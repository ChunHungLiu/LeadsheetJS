/*! LeadsheetJS, 0.1.0 Helps you to create a Leadsheet 2015-04-20 - Sony CSL */
define(["mustache","modules/core/src/SongModel","modules/Cursor/src/CursorModel","utils/UserLog","pubsub"],function(a,b,c){function d(a,d,e){this.songModel=a||new c,this.cursor=d||new b,this.view=e,this.initSubscribe()}return d.prototype.initSubscribe=function(){var a=this;$.subscribe("ChordEditionView-copyChords",function(){a.copyChords()}),$.subscribe("ChordEditionView-pasteChords",function(){a.pasteChords()}),$.subscribe("ChordEditionView-activeView",function(){a.changeEditMode(!0),$.publish("ToViewer-draw",a.songModel)}),$.subscribe("ChordEditionView-unactiveView",function(){a.changeEditMode(!1)})},d.prototype.copyChords=function(){console.log("copyChords")},d.prototype.pasteChords=function(){console.log("pasteChords")},d.prototype.getSelectedChords=function(){var a=this.songModel.getComponent("chords"),b=a.getChords(this.cursor.getStart(),this.cursor.getEnd()+1);return b},d.prototype.changeEditMode=function(a){this.cursor.setEditable(a)},d}),define(["mustache","modules/core/src/SongModel","utils/UserLog","pubsub"],function(a){function b(a,b){this.cursor=b,this.el=void 0,this.initSubscribe()}return b.prototype.render=function(a,b,c){b=b||!1;var d=this;return"undefined"==typeof this.el||"undefined"!=typeof this.el&&b===!0?void this.initView(a,function(){d.initController(),d.initKeyboard(),$.publish("ChordEditionView-render"),"function"==typeof c&&c()}):void("function"==typeof c&&c())},b.prototype.initView=function(b,c){var d=this;$.get("/modules/ChordEdition/src/ChordEditionTemplate.html",function(e){var f=a.render(e);"undefined"!=typeof b&&(b.innerHTML=f),d.el=f,"function"==typeof c&&c()})},b.prototype.initController=function(){$("#copy_chord").click(function(){$.publish("ChordEditionView-copyChords")}),$("#paste_chord").click(function(){$.publish("ChordEditionView-pasteChords")})},b.prototype.initKeyboard=function(){function a(a){a.preventDefault(),a.stopPropagation()}var b=this;$(document).keydown(function(c){if(b.editing!==!1){{var d=null===c?event.keyCode:c.keyCode;String.fromCharCode(d).toLowerCase()}if(8===d){var e=!1,f=c.srcElement||c.target;e="TEXTAREA"===f.tagName.toUpperCase()||"INPUT"===f.tagName.toUpperCase()&&("TEXT"===f.type.toUpperCase()||"PASSWORD"===f.type.toUpperCase()||"FILE"===f.type.toUpperCase())?f.readOnly||f.disabled:!0,e&&a(c)}b.isEditMode("chords")&&(13==d?($.publish("ChordEditionView-toggleEditChord"),a(c)):67==d&&c.ctrlKey?($.publish("ChordEditionView-copyChords"),a(c)):86==d&&c.ctrlKey&&($.publish("ChordEditionView-pasteChords"),a(c)))}})},b.prototype.initSubscribe=function(){},b.prototype.isEditMode=function(a){return this.editMode===a?!0:!1},b.prototype.unactiveView=function(){this.editMode="",$.publish("ChordEditionView-unactiveView")},b.prototype.activeView=function(){this.editMode="chords",$.publish("ChordEditionView-activeView","chords")},b}),define(["modules/core/src/SongModel","modules/core/src/ChordModel","modules/ChordEdition/src/ChordSpaceView","modules/Cursor/src/CursorModel","utils/UserLog","pubsub"],function(a,b,c,d){function e(b,c){this.songModel=b||new a,this.cursor=c||new d,this.chordSpace=[],this.initSubscribe()}return e.prototype.initSubscribe=function(){var a=this;$.subscribe("ChordSpaceView-updateChord",function(b,c){a.updateChord(c.chordString,c.chordModel,c.chordSpace),$.publish("ToViewer-draw",a.songModel)}),$.subscribe("LSViewer-click",function(b,c){var d=a.isInPath(c.x,c.y);d!==!1?($.publish("ToAllCursor-setEditable",!1),a.cursor.setEditable(!0),a.cursor.setPos(d),$.publish("ToViewer-draw",a.songModel)):a.undraw()}),$.subscribe("LSViewer-mousemove",function(){}),$.subscribe("LSViewer-drawEnd",function(b,c){a.cursor.getEditable()?a.refresh(c):0===a.chordSpace.length?a.chordSpace=a.createChordSpace(c):a.undraw()}),$.subscribe("CursorView-moveCursorByElementchords",function(b,c){a.moveCursorByBar(c)})},e.prototype.updateChord=function(a,c,d){"undefined"==typeof c&&"undefined"!=typeof d&&(c=new b({beat:d.beatNumber,barNumber:d.barNumber}),this.songModel.getComponent("chords").addChord(c)),c.setChordFromString(a)},e.prototype.refresh=function(a){this.chordSpace=this.createChordSpace(a),this.draw(a)},e.prototype.isInPath=function(a,b){for(var c=0,d=this.chordSpace.length;d>c;c++)if("undefined"!=typeof this.chordSpace[c]&&this.chordSpace[c].isInPath(a,b))return c;return!1},e.prototype.moveCursorByBar=function(a){if(this.cursor.getEditable()!==!1){var b=this.chordSpace[this.cursor.getPos()[0]].barNumber,c=this.songModel.getStartBeatFromBarNumber(b+a)-1;if(0===b&&-1===a)return this.cursor.setPos(0),void $.publish("ToViewer-draw",this.songModel);this.cursor.setPos(c),$.publish("ToViewer-draw",this.songModel)}},e.prototype.createChordSpace=function(a){var b=[];if("undefined"!=typeof a.vxfBars){for(var d,e,f,g=a.SCALE,h=0,i=a.vxfBars.length;i>h;h++){d=a.vxfBars[h].timeSignature.getBeats(),e=a.vxfBars[h].barDimensions.width/d;for(var j=0;d>j;j++)f={x:(a.vxfBars[h].barDimensions.left+e*j)*g,y:(a.vxfBars[h].barDimensions.top-17)*g,xe:e*g,ye:20},b.push(new c(a,f,h,j+1))}return b}},e.prototype.undraw=function(){$("#canvas_container .chordSpaceInput").devbridgeAutocomplete("dispose").remove()},e.prototype.draw=function(a){var b=this.cursor.getPos(),c=a.ctx.strokeStyle;a.ctx.lineWidth=.7;var d=!1;this.undraw();for(var e=0,f=this.chordSpace.length;f>e;e++)d=b[0]<=e&&e<=b[1]?!0:!1,this.chordSpace[e].draw(a,this.songModel,d);a.ctx.strokeStyle=c},e}),define(["utils/ChordUtils","utils/UserLog","pubsub","jquery_autocomplete"],function(a){function b(a,b,c,d){this.viewer=a,this.initSubscribe(),this.position=b,this.barNumber=c,this.beatNumber=d}return b.prototype.initController=function(){},b.prototype.initKeyboard=function(){},b.prototype.initSubscribe=function(){},b.prototype.isInPath=function(a,b){return"undefined"!=typeof a&&!isNaN(a)&&"undefined"!=typeof b&&!isNaN(b)&&this.position.x<=a&&a<=this.position.x+this.position.xe&&this.position.y<=b&&b<=this.position.y+this.position.ye?!0:!1},b.prototype.onChange=function(a,b){var c={chordString:b,chordModel:a,chordSpace:this};$.publish("ChordSpaceView-updateChord",c)},b.prototype.draw=function(b,c,d){var e=20,f=5,g=5;if(d){var h=this,i="";if("undefined"!=typeof c){var j=c.getComponent("chords").searchChordByBarAndBeat(this.barNumber,this.beatNumber);"undefined"!=typeof j&&(i=j.toString("",!1))}var k=$("#canvas_container canvas").offset();("undefined"==typeof k||isNaN(k.top)||isNaN(k.left))&&(k={top:0,left:0});var l=this.position.y-f-1,m=this.position.x+k.left+window.pageXOffset-1,n=this.position.xe-g,o=e+f,p=$("<input/>").attr({type:"text",style:"position:absolute; z-index: 11000;left:"+m+"px;top:"+l+"px; width:"+n+"px; height:"+o+"px","class":"chordSpaceInput"}).prependTo("#canvas_container"),q=[];q="undefined"!=typeof a.allChords?a.allChords:a.getAllChords(),p.devbridgeAutocomplete({lookup:q,maxHeight:200,width:140,triggerSelectOnValidInput:!1,showNoSuggestionNotice:!0,autoSelectFirst:!0,noSuggestionNotice:"No Chord match",lookupFilter:function(a,b){return-1!==a.value.indexOf(b)},onSelect:function(a){p.devbridgeAutocomplete("dispose"),h.onChange(j,a.value)}}),p.focus(),p.val(i),p.focus(),p.on("blur",function(){h.onChange(j,$(this).val()),p.devbridgeAutocomplete("dispose")}),$("#autocomplete-suggestion").on("click",function(){h.onChange(j,$(p).val()),p.devbridgeAutocomplete("dispose")}),p.on("input propertychange paste",function(){$(this).val(h.filterFunction($(this).val()))})}b.ctx.strokeStyle="#999999",b.ctx.strokeRect(this.position.x,this.position.y-f,this.position.xe-g,e+f)},b.prototype.filterFunction=function(a){function b(a,b){var c=[];for(d=0;d<a.length;++d)a.substring(d,d+b.length)==b&&c.push(d);return c}a=a.replace(/^[a-z]/,function(a){return a.toUpperCase()}),a=a.replace(/\/[a-z]/,function(a){return a.toUpperCase()}),a=a.replace("-","m"),a=a.replace("è","7"),a=a.replace("ç","9"),a=a.replace("0","halfdim7"),a=a.replace("<","|"),a=a.replace(".","dim7"),a=a.replace("*","M7"),a=a.replace("mm","mM"),"5"==a.substring(0,1)&&(a=a.replace("5","%"));var c=b(a,"3");for(var d in c)1!=a.charAt(c[d]-1)&&"t"!=a.charAt(c[d]-1)&&(a=a.substr(0,c[d])+"#"+a.substr(c[d]+1));return a=a.replace(/^(.+)(p|²)$/,"($1)")},b}),define(["utils/AjaxUtils"],function(a){function b(){}return b.prototype.constraintAPI=function(b,c){"undefined"!=typeof globalVariables&&"roy"==globalVariables.username?$.ajax({url:"http://localhost:8080/flow/ct",dataType:"json",type:"POST",data:b,xhrFields:{withCredentials:!0},success:function(a){"undefined"!=typeof a&&"undefined"!=typeof c&&c(a)}}):a.servletRequest("flow","ct",b,c)},b}),define(["mustache","modules/core/src/SongModel","modules/Tag/src/TagManager","modules/converters/MusicCSLJson/src/SongModel_CSLJson","modules/Constraint/src/ConstraintAPI","utils/UserLog","pubsub"],function(a,b,c,d,e,f){function g(a){this.songModel=a||new b,this.initSubscribe()}return g.prototype.initSubscribe=function(){var a=this;$.subscribe("ConstraintView-compute",function(b,c){a.computeConstraint(c.songset,c.composer,c.timeSignature,c.source,c.numberOfBars)})},g.prototype.constraint2API=function(a,b,c,e){var f={};f=d.exportToMusicCSLJSON(this.songModel),c="all";var g={incompleteLeadsheet:JSON.stringify(f),timesigFilter:c},h={};return""!==a&&null!==a&&(h={songSet:a},$.extend(!0,g,h)),""!==b&&null!==b&&(h={composer:b},$.extend(!0,g,h)),""!==e&&null!==e&&(h={source:e},$.extend(!0,g,h)),g},g.prototype.computeConstraint=function(a,b,g,h,i){var j=this,k=new e,l={};l=this.constraint2API(a,b,g,h,i);var m=f.log("info","Computing ...");k.constraintAPI(l,function(a){if(f.removeLog(m),a.success===!0){if(j._compareObj(l.leadsheet,a.result),d.importFromMusicCSLJSON(a.result,j.songModel),$.publish("ToHistory-add",{item:a.result,title:"Constraint"}),"undefined"!=typeof a.tags){new c(j.songModel,a.tags)}$.publish("ToViewer-draw",j.songModel),f.logAutoFade("success","Constraint is finished")}else{var b="Unknown error";"undefined"!=typeof a.error?b=a.error:"undefined"!=typeof a.message&&(b=a.message),f.logAutoFade("error",b)}})},g.prototype._compareObj=function(a,b){var c=!0,d=!0,e=!0,f=!1,g=!1,h=!1,i=!1,j="blue";if("undefined"!=typeof b&&(c="undefined"==typeof a?!1:!0,"undefined"!=typeof b.changes)){c===!0&&(c="undefined"==typeof a.changes?!1:!0);for(var k in b.changes){var l=b.changes[k];if(f===!0&&(c=!0,f=!1),c===!0&&("undefined"==typeof a.changes[k]?(f=!0,c=!1):c=!0),"undefined"!=typeof l.bars){c===!0&&(c="undefined"==typeof a.changes[k].bars?!1:!0);for(var m in l.bars){g===!0&&(c=!0,g=!1);var n=l.bars[m];if(c===!0&&("undefined"==typeof a.changes[k].bars[m]?(c=!1,g=!0):c=!0),"undefined"!=typeof n.chords){i===!0&&(c=!0,i=!1),c===!0&&("undefined"==typeof a.changes[k].bars[m].chords?(c=!1,i=!0):c=!0);for(var o in n.chords){var p=n.chords[o];c===!0&&(d=!0,("undefined"==typeof a.changes[k].bars[m].chords[o]||a.changes[k].bars[m].chords[o].p!=p.p||a.changes[k].bars[m].chords[o].ch!=p.ch||a.changes[k].bars[m].chords[o].beat!=p.beat)&&(d=!1)),(c===!1||d===!1)&&(p.color=j,d=!0)}}if("undefined"!=typeof n.melody){h===!0&&(c=!0,h=!1),c===!0&&("undefined"==typeof a.changes[k].bars[m].melody?(c=!1,h=!0):c=!0);for(var o in n.melody){var q=n.melody[o];c===!0&&(e=!0,("undefined"==typeof a.changes[k].bars[m].melody[o]||a.changes[k].bars[m].melody[o].duration!=q.duration||a.changes[k].bars[m].melody[o].keys[0]!=q.keys[0])&&(e=!1)),(c===!1||e===!1)&&(q.color=j,e=!0)}}}}}}return b},g}),define(["mustache","modules/core/src/SongModel","utils/UserLog","pubsub"],function(){var a=function(){this.init()};return a.prototype.init=function(){this.constraints=[]},a.prototype.addMusicCSLJSON=function(a){if("undefined"==typeof editor)return a;var b=editor.getSong().exportToMusicCSLJSON(),c={incompleteLeadsheet:JSON.stringify(b)};return $.extend(!0,a,c),a},a}),define(["mustache","modules/core/src/SongModel","utils/UserLog","pubsub"],function(a){function b(){this.el=void 0}return b.prototype.render=function(a,b,c){b=b||!1;var d=this;return"undefined"==typeof this.el||"undefined"!=typeof this.el&&b===!0?void this.initView(a,function(){"undefined"!=typeof a&&(d.initController(),$.publish("ConstraintView-render")),"function"==typeof c&&c()}):void("function"==typeof c&&c())},b.prototype.initView=function(b,c){var d=this;$.get("/modules/Constraint/src/ConstraintTemplate.html",function(e){var f=a.render(e);"undefined"!=typeof b&&(b.innerHTML=f),d.el=f,"function"==typeof c&&c()})},b.prototype.initController=function(){$("#constraint_compute").click(function(){var a=$("#constraint_select_songsets").val();"none"==a&&(a=null);var b=$("#constraint_select_composer").val();""===b&&(b=null);var c=$("#constraint_select_source").val();"none"==c&&(c=null);var d=$("#constraint_select_timeSignature").val(),e=$("#constraint_nbBars").val();isNaN(e)&&(e=8);var f={songset:a,composer:b,timeSignature:d,source:c,numberOfBars:e};return $.publish("ConstraintView-compute",f),!1})},b.prototype.unactiveView=function(){$.publish("toHistoryView-unactiveView")},b.prototype.activeView=function(){$.publish("toHistoryView-activeView")},b});var JSON1={_id:{$id:"546dc7fef90679280900263d"},title:"Coolest song in the world",composer:"Neullas",time:"4/4",keySignature:"C",style:"Medium Swing",source:"51b6fe4067ca227d25665b0e",changes:[{name:"A",bars:[{chords:[{p:"C",ch:"7",beat:1}],melody:[{keys:["C/5"],duration:"q"},{keys:["G/4"],duration:"8"},{keys:["A/4"],duration:"8"},{keys:["E/4"],duration:"8"},{keys:["B/4"],duration:"8r"},{keys:["B/4"],duration:"qr"}]},{melody:[{keys:["B/4"],duration:"wr"}]},{melody:[{keys:["B/4"],duration:"wr"}]},{melody:[{keys:["B/4"],duration:"wr"}]},{melody:[{keys:["B/4"],duration:"wr"}]},{melody:[{keys:["B/4"],duration:"wr"}]},{chords:[{p:"C",ch:"m",beat:1}],melody:[{keys:["B/4"],duration:"wr"}]},{chords:[{p:"G",ch:"9",beat:1}],melody:[{keys:["C/4"],duration:"wr"}]}]}],editinfo:{userid:"51caed7058e3380359000000",date:{sec:1416480897,usec:0}}},JSON2={title:"In the style of Constraint Test",composer:"FlowComposer",time:"4/4",source:"5310666826bb7df40e000001",editinfo:{userid:"51127cac0c6f3420f60a1fcc"},keySignature:"C",changes:[{bars:[{melody:[{keys:["C/5"],duration:"q"},{keys:["G/4"],duration:"8"},{keys:["A/4"],duration:"8"},{keys:["E/4"],duration:"8"},{keys:["B/4"],duration:"8r"},{keys:["D#/5"],duration:"q"}],chords:[{p:"C",ch:"7",pb:"",pch:"",beat:1},{p:"F",ch:"m6",pb:"",pch:"",beat:4}]},{melody:[{keys:["G/4"],duration:"8"},{keys:["A/4"],duration:"8"},{keys:["G/4"],duration:"h"},{keys:["G/4"],duration:"8"},{keys:["A/4"],duration:"8"}],chords:[{p:"C",ch:"7",pb:"",pch:"",beat:1},{p:"Eb",ch:"69",pb:"",pch:"",beat:2},{p:"C",ch:"7",pb:"",pch:"",beat:4}]},{melody:[{keys:["Gb/4"],duration:"q"},{keys:["Gn/4"],duration:"8"},{keys:["A/4"],duration:"8"},{keys:["Fb/5"],duration:"8"},{keys:["Eb/5"],duration:"q"},{keys:["Db/5"],duration:"8"}],chords:[{p:"Db",ch:"m7",pb:"",pch:"",beat:1},{p:"C",ch:"7",pb:"",pch:"",beat:2},{p:"Db",ch:"m7",pb:"",pch:"",beat:3}]},{melody:[{keys:["G/4"],duration:"8"},{keys:["A/4"],duration:"8"},{keys:["B/4"],duration:"8r"},{keys:["C#/5"],duration:"8"},{keys:["E/5"],duration:"8"},{keys:["D#/5"],duration:"8"},{keys:["E/4"],duration:"8"},{keys:["B/4"],duration:"8r"}],chords:[{p:"C",ch:"7",pb:"",pch:"",beat:1},{p:"A",ch:"7",pb:"",pch:"",beat:2},{p:"C",ch:"7",pb:"",pch:"",beat:4}]},{melody:[{keys:["Ab/4"],duration:"q"},{keys:["F#/4"],duration:"8"},{keys:["Fn/4"],duration:"q"},{keys:["F#/4"],duration:"q"},{keys:["Ab/4"],duration:"8"}],chords:[{p:"D",ch:"dim7",pb:"",pch:"",beat:1}]},{melody:[{keys:["E/4"],duration:"8"},{keys:["B/4"],duration:"8r"},{keys:["A/4"],duration:"q"},{keys:["G/4"],duration:"8"},{keys:["A/4"],duration:"8"},{keys:["C/5"],duration:"8"},{keys:["A/4"],duration:"8"}],chords:[{p:"C",ch:"7",pb:"",pch:"",beat:1},{p:"A",ch:"7",pb:"",pch:"",beat:2},{p:"C",ch:"7",pb:"",pch:"",beat:3},{p:"A",ch:"m7",pb:"",pch:"",beat:4}]},{melody:[{keys:["A/4"],duration:"q"},{keys:["A/4"],duration:"h"},{keys:["B/4"],duration:"qr"}],chords:[{p:"A",ch:"7",pb:"",pch:"",beat:4}]},{melody:[{keys:["C/4"],duration:"w"}],chords:[{p:"G",ch:"9",pb:"",pch:"",beat:1}]}],timeSignature:"4/4",name:"A"}]};define(["mustache","modules/core/src/SongModel","utils/UserLog","pubsub"],function(){function a(a,b,c){this.songModel=a,this.model=b||new CursorModel,this.view=c,this.initSubscribe()}return a.prototype.initSubscribe=function(){var a=this;$.subscribe("ToAllCursor-setEditable",function(b,c){a.setEditable(c)}),$.subscribe("CursorView-setCursor"+this.view.id,function(b,c){a.setCursor(c)}),$.subscribe("CursorView-expandSelected"+this.view.id,function(b,c){a.expandSelected(c)}),$.subscribe("CursorView-moveCursor"+this.view.id,function(b,c){a.moveCursor(c)})},a.prototype.setCursor=function(a){if("undefined"==typeof a||isNaN(a))throw"CursorController - setCursor - index is not correct "+a;this.model.setPos(a),$.publish("ToViewer-draw",this.songModel)},a.prototype.expandSelected=function(a){if("undefined"==typeof a||isNaN(a))throw"CursorController - expandSelected - inc is not correct "+a;this.model.expand(a),$.publish("ToViewer-draw",this.songModel)},a.prototype.moveCursor=function(a){this.setCursor(this.model.getEnd()+a)},a.prototype.setEditable=function(a){this.model.setEditable(a)},a}),define(["pubsub"],function(){function a(a,b,c){this.listElement=a,b=b||[0,0],b instanceof Array||(b=[b,b]),this.sideSelected=1,this.isEditable="undefined"!=typeof c?c:!0,this.setPos(b)}return a.prototype.getPos=function(){return this.pos},a.prototype.setPos=function(a){this.isEditable&&(a instanceof Array||(a=[a,a]),a=this._checkPosition(a),this.pos=a,$.publish("CursorModel-setPos",this.pos))},a.prototype.getStart=function(){return this.pos[0]},a.prototype.getEnd=function(){return this.pos[1]},a.prototype.setIndexPos=function(a,b){if(this.isEditable){if(0!==a&&1!==a||isNaN(b))throw"CursorModel - setIndexPos, arguments not well defined index:"+a+" - pos:"+b;b=this._checkPosition(b)[0],this.pos[a]=b,$.publish("CursorModel-setPos",this.pos)}},a.prototype._checkPosition=function(a){a instanceof Array||(a=[a,a]);for(var b=this.getListLength(),c=0;c<a.length;c++)a[c]<0&&(a[c]=0),a[c]>=b&&(a[c]=b-1);return a},a.prototype.revisePos=function(){for(var a in this.pos)this.pos[a]>=this.getListLength()&&this.setIndexPos(a,this.getListLength()-1)},a.prototype.expand=function(a){this.pos[1]===this.pos[0]&&(this.sideSelected=a>0?1:0);var b=this.pos[this.sideSelected]+a;0>b&&(b=0),b>=this.getListLength()&&(b=this.getListLength()-1),this.setIndexPos(this.sideSelected,b)},a.prototype.getRelativeCursor=function(b){var c=[this.pos[0]-b,this.pos[1]-b];return new a(c)},a.prototype.reset=function(){this.setPos([0,0])},a.prototype.increment=function(a){a=a||1,this.setIndexPos(0,this.pos[0]+=a),this.setIndexPos(1,this.pos[1]+=a)},a.prototype.getListLength=function(){return"object"==typeof this.listElement?this.listElement.getTotal():this.listElement.constructor===Array?this.listElement.length:this.listElement.constructor===Number?this.listElement:void 0},a.prototype.setEditable=function(a){this.isEditable=!!a},a.prototype.getEditable=function(){return this.isEditable},a}),define(["mustache","modules/core/src/SongModel","utils/UserLog","pubsub"],function(){function a(a,b,c){this.id=b,this.model=a,this.keyToNext="undefined"!=typeof c?c:"arrow",this.initSubscribe(),this.initController(),this.initKeyboard()}return a.prototype.initController=function(){},a.prototype.initKeyboard=function(){function a(a){a.preventDefault(),a.stopPropagation()}var b=this;$(document).keydown(function(c){if(b.editing!==!1){{var d=null===c?event.keyCode:c.keyCode;String.fromCharCode(d).toLowerCase()}if(8===d||37===d||39===d||36===d||35===d){var e=!1,f=c.srcElement||c.target;if(e="TEXTAREA"===f.tagName.toUpperCase()||"INPUT"===f.tagName.toUpperCase()&&("TEXT"===f.type.toUpperCase()||"PASSWORD"===f.type.toUpperCase()||"FILE"===f.type.toUpperCase())?!(f.readOnly||f.disabled):!1,e===!0)return}"tab"===b.keyToNext?9==d&&(inc=c.shiftKey?-1:1,$.publish("CursorView-moveCursorByElement"+b.id,inc),a(c)):37==d||39==d?(inc=39==d?1:-1,c.shiftKey?$.publish("CursorView-expandSelected"+b.id,inc):c.ctrlKey?$.publish("CursorView-moveCursorByElement"+b.id,inc):$.publish("CursorView-moveCursor"+b.id,inc),a(c)):36==d?(c.shiftKey?$.publish("CursorView-expandSelected"+b.id,-1e4):$.publish("CursorView-setCursor"+b.id,0),a(c)):35==d&&(c.shiftKey?$.publish("CursorView-expandSelected"+b.id,1e4):$.publish("CursorView-setCursor"+b.id,1e4),a(c))}})},a.prototype.initSubscribe=function(){},a}),define(["modules/Cursor/src/CursorModel"],function(a){return{run:function(){test("CursorModel",function(b){var c=new a(10);b.ok(c instanceof a),b.deepEqual(c.getPos(),[0,0]),c.setPos(4),b.deepEqual(c.getPos(),[4,4]),c.setPos([5,6]),b.deepEqual(c.getPos(),[5,6]),b.equal(c.getStart(),5),b.equal(c.getEnd(),6),c.setIndexPos(1,7),b.deepEqual(c.getPos(),[5,7]),c.setIndexPos(0,4),b.deepEqual(c.getPos(),[4,7]),b.equal(c.getListLength(),10,"length"),c.reset(),b.deepEqual(c.getPos(),[0,0],"reset"),c.expand(1,10),b.deepEqual(c.getPos(),[0,1]),c.increment(5),b.deepEqual(c.getPos(),[5,6]),c.expand(1,10),b.deepEqual(c.getPos(),[5,7]),c.expand(-1,10),b.deepEqual(c.getPos(),[5,6]),c.expand(-1,10),b.deepEqual(c.getPos(),[5,5])})}}}),define(["mustache","modules/core/src/SongModel","modules/converters/MusicCSLJson/src/SongModel_CSLJson","modules/converters/MusicXML/src/SongModel_MusicXML","modules/LSViewer/src/LSViewer","pubsub","utils/UserLog","utils/apiFlowMachines/ComposerServlet","utils/AjaxUtils","jsPDF"],function(a,b,c,d,e,f,g,h,i,j){function k(a,c){this.viewerCanvas=c,this.songModel=a||new b,this.initSubscribe()}return k.prototype.initSubscribe=function(){var a=this;$.subscribe("FileEditionView-importMusicCSLJSON",function(b,c){a.importMusicCSLJSON(c)}),$.subscribe("FileEditionView-importMusicXML",function(b,c){a.importMusicXML(c)}),$.subscribe("FileEditionView-sound_export",function(b,d){var e=d&&"undefined"!=typeof d.exportType?d.exportType:"mp3",f=d&&"undefined"!=typeof d.chord?d.chord:!0,g=d&&"undefined"!=typeof d.tick?d.tick:!1,h=d&&"undefined"!=typeof d.style?d.style:"none",i=c.exportToMusicCSLJSON(a.songModel);i=JSON.stringify(i);var j=a.songModel.getTempo();"mid"===e?a.exportMidiFile(i,j,f,g):a.exportAudioFile(i,j,e,f,g,h)}),$.subscribe("FileEditionView-exportPNG",function(){a.exportPNG()}),$.subscribe("FileEditionView-exportPDF",function(){a.exportAndPromptLeadsheetToPDF(a.songModel.getTitle(),a.songModel.getComposer(),a.songModel.getTimeSignature(),a.songModel.getStyle())}),$.subscribe("FileEditionView-exportMusicCSLJSON",function(){a.exportLeadsheetJSON()})},k.prototype.importMusicCSLJSON=function(a){if("undefined"==typeof a)throw"FileEditionController - importMusicCSLJSON File imported is not defined "+a;c.importFromMusicCSLJSON(a,this.songModel),$.publish("ToHistory-add",{item:a,title:"Open MusicCSLJson - "+this.songModel.getTitle()}),$.publish("ToViewer-draw",this.songModel)},k.prototype.importMusicXML=function(a){if("undefined"==typeof a)throw"FileEditionController - importMusicXML File imported is not defined "+a;d.importFromMusicXML(a,this.songModel),$.publish("ToHistory-add",{item:a,title:"Open MusicXML - "+this.songModel.getTitle()}),$.publish("ToViewer-draw",this.songModel)},k.prototype.promptFile=function(a,b,c){"undefined"==typeof c&&(c="");var d=$("<a>",{download:a+c,href:b}).prependTo("body");d[0].click(),d.remove()},k.prototype.exportAudioFile=function(a,b,c,d,e,f){var j=this,k=g.log("info","Computing..."),l=h.getRequestForSimpleAudio(a,b,d,e,f);i.servletRequest("flow","composer",l,function(a){if(g.removeLog(k),"undefined"!=typeof a)if("undefined"==typeof a.file){var b="Error while trying to build audio from Leadsheet";"undefined"!=typeof a.error?b=a.error:"undefined"!=typeof a.message&&(b=a.message),g.logAutoFade("error",b)}else j.promptFile(j.songModel.getTitle()+"."+c,a.file)})},k.prototype.exportMidiFile=function(a,b,c,d){var e=this,f=g.log("info","Computing..."),j=h.getRequestForSimpleMidi(a,b,c,d);i.servletRequest("flow","composer",j,function(a){if(g.removeLog(f),"undefined"!=typeof a)if("undefined"==typeof a.file){var b="Error while trying to build midi from Leadsheet";"undefined"!=typeof a.error?b=a.error:"undefined"!=typeof a.message&&(b=a.message),g.logAutoFade("error",b)}else e.promptFile(e.songModel.getTitle()+".mid",a.file)})},k.prototype.exportPNG=function(){var a=this.viewerCanvas,b=document.createElement("div"),c=new e(b,{width:5*a.width,typeResize:"scale"});c.draw(this.songModel),this.promptFile(this.songModel.getTitle()+".png",c.canvas.toDataURL())},k.prototype.exportAndPromptLeadsheetToPDF=function(a,b,c,d,f){var g=this.viewerCanvas,h=document.createElement("div"),i=new e(h,{width:g.width-10});i.draw(this.songModel);var k=document.createElement("canvas");k.width=g.width,k.height=g.height;var l=k.getContext("2d");l.fillStyle="#FFFFFF",l.fillRect(0,0,g.width,g.height),l.drawImage(i.canvas,0,0);var m=k.toDataURL("image/jpeg",1),n=200,o=n*(g.height/g.width),p=new j;p.setFontSize(34),p.addImage(m,"JPEG",10,23,n,o),p.setFontSize(10),p.text(15,20,d+" ("+c+")"),o>=365&&(p.addPage(),p.addImage(m,"JPEG",10,-270,n,o)),f=f&&""!==f?"_"+f:"",p.save(a+f+".pdf")},k.prototype.exportLeadsheetJSON=function(){var a=c.exportToMusicCSLJSON(this.songModel),b="text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(a)),d=$("<a>",{download:this.songModel.getTitle()+".json",href:"data:"+b}).prependTo("body");d[0].click(),d.remove()},k}),define(["mustache","modules/core/src/SongModel","utils/UserLog","pubsub"],function(a){function b(){this.el=void 0,this.initSubscribe(),this.initKeyboard()}return b.prototype.render=function(a,b,c){b=b||!1;var d=this;return"undefined"==typeof this.el||"undefined"!=typeof this.el&&b===!0?void this.initView(a,function(){d.initController(),$.publish("FileEditionView-render"),"function"==typeof c&&c()}):void("function"==typeof c&&c())},b.prototype.initView=function(b,c){var d=this;$.get("/modules/FileEdition/src/FileEditionTemplate.html",function(e){var f=a.render(e);"undefined"!=typeof b&&(b.innerHTML=f),d.el=f,"function"==typeof c&&c()})},b.prototype.initController=function(){$("#add-bar").click(function(){$.publish("FileEditionView-addBar")});$("#importFile").change(function(a){var b=a.target.files[0],c=["json","xml","mxml"],d=b.name.split(".");d=d[d.length-1];var e=c.indexOf(d);if(b&&-1!==e){var f=new FileReader;return f.onload=function(a){0===e?$.publish("FileEditionView-importMusicCSLJSON",JSON.parse(a.target.result)):$.publish("FileEditionView-importMusicXML",a.target.result)},f.readAsText(b),!1}}),$("#export_mp3").click(function(){var a=$("#export_sound_chords").prop("checked"),b=$("#export_sound_tick").prop("checked"),c=$("#sound_export_style").val();$.publish("FileEditionView-sound_export",{exportType:"mp3",chord:a,tick:b,style:c})}),$("#export_wav").click(function(){var a=$("#export_sound_chords").prop("checked"),b=$("#export_sound_tick").prop("checked"),c=$("#sound_export_style").val();$.publish("FileEditionView-sound_export",{exportType:"wav",chord:a,tick:b,style:c})}),$("#export_midi").click(function(){var a=$("#export_sound_chords").prop("checked"),b=$("#export_sound_tick").prop("checked");$.publish("FileEditionView-sound_export",{exportType:"mid",chord:a,tick:b})}),$("#export_png").click(function(){$.publish("FileEditionView-exportPNG")}),$("#export_pdf").click(function(){$.publish("FileEditionView-exportPDF")}),$("#export_musicCslJson").click(function(){$.publish("FileEditionView-exportMusicCSLJSON")})},b.prototype.initKeyboard=function(){},b.prototype.initSubscribe=function(){},b}),define(["modules/core/src/SongModel","modules/FileEdition/src/FileEditionController","modules/converters/MusicCSLJson/src/SongModel_CSLJson","modules/converters/MusicXML/src/SongModel_MusicXML","modules/converters/MusicXML/utils/musicXMLParser","tests/test-songs"],function(a,b,c,d,e,f){return{run:function(){test("File Edition Controller",function(g){var h=new b(new a);h.importMusicCSLJSON(f.simpleLeadSheet);var i=c.importFromMusicCSLJSON(f.simpleLeadSheet);g.deepEqual(h.songModel,i,"importFromMusicCSLJSON");var j=new e,k=j.fetch("/tests/ferme.xml");h.importMusicXML(k),i=d.importFromMusicXML(k),g.deepEqual(h.songModel.getComponent("notes"),i.getComponent("notes"),"importFromMusicXML"),g.deepEqual(h.songModel.getComponent("chords"),i.getComponent("chords"),"importFromMusicXML"),g.deepEqual(h.songModel.getComponent("bars"),i.getComponent("bars"),"importFromMusicXML")})}}}),define(["utils/AjaxUtils"],function(a){function b(){}return b.prototype.harmonicAnalyseFromIdSongAPI=function(b,c){var d={id:b};a.servletRequest("jsonsong","harmony",d,c)},b.prototype.harmonicAnalyseFromLeadsheetAPI=function(b,c){var d={leadsheet:b};a.servletRequest("jsonsong","harmony",d,c)},b}),define(["mustache","modules/core/src/SongModel","modules/converters/MusicCSLJson/src/SongModel_CSLJson","modules/HarmonicAnalysis/src/HarmonicAnalysisAPI","modules/Tag/src/TagManager","utils/UserLog","pubsub"],function(a,b,c,d,e,f){function g(a){this.songModel=a,this.initSubscribe(),this.tagManager=new e(this.songModel,[],void 0,!1)}return g.prototype.initSubscribe=function(){var a=this;$.subscribe("HarmonicAnalysisView-compute",function(){a.computeHarmonicAnalysis()}),$.subscribe("HarmonicAnalysisView-remove",function(){a.removeHarmonicAnalysis()})},g.prototype.computeHarmonicAnalysis=function(){var a=this,b=c.exportToMusicCSLJSON(this.songModel),e=new d,g=f.log("info","Computing...");e.harmonicAnalyseFromLeadsheetAPI(JSON.stringify(b),function(b){f.removeLog(g),b.success===!0?(f.logAutoFade("success","Harmonic Analysis is finished"),"undefined"!=typeof b.analysis&&(a.tagManager.setActive(!0),a.tagManager.setTags(b.analysis),$.publish("ToViewer-draw",a.songModel))):f.logAutoFade("error",b.error)})},g.prototype.removeHarmonicAnalysis=function(){this.tagManager.setActive(!1)},g}),define(["mustache","modules/core/src/SongModel","utils/UserLog","pubsub"],function(a){function b(){this.el=void 0}return b.prototype.render=function(a,b,c){b=b||!1;var d=this;return"undefined"==typeof this.el||"undefined"!=typeof this.el&&b===!0?void this.initView(a,function(){d.initController(),$.publish("HarmonicAnalysisView-render"),"function"==typeof c&&c()}):void("function"==typeof c&&c())},b.prototype.initView=function(b,c){var d=this;$.get("/modules/HarmonicAnalysis/src/HarmonicAnalysisTemplate.html",function(e){var f=a.render(e);"undefined"!=typeof b&&(b.innerHTML=f),d.el=f,"function"==typeof c&&c()})},b.prototype.initController=function(){$("#harmonic_analysis").click(function(){return $.publish("HarmonicAnalysisView-compute"),$("#remove_harmonic_analysis").show(),!1}),$("#remove_harmonic_analysis").click(function(){return $.publish("HarmonicAnalysisView-remove"),$("#remove_harmonic_analysis").hide(),!1})},b}),define(["utils/AjaxUtils"],function(a){function b(){}return b.prototype.harmonizeFromIdSongAPI=function(b,c,d){var e={id:b,setName:c};a.servletRequest("flow","harmonize",e,d)},b.prototype.harmonizeFromLeadsheetAPI=function(b,c,d){var e={leadsheet:b,setName:c};a.servletRequest("flow","harmonize",e,d)},b}),define(["mustache","modules/core/src/SongModel","modules/converters/MusicCSLJson/src/SongModel_CSLJson","modules/Harmonizer/src/HarmonizerAPI","utils/UserLog","pubsub"],function(a,b,c,d,e){function f(a,b){this.songModel=a,this.view=b;var c=this;$.subscribe("HarmonizerView-compute",function(a,b){c.computeHarmonize(b)})}return f.prototype.computeHarmonize=function(a){var b=this;a||(a="Take6");var f=c.exportToMusicCSLJSON(this.songModel),g=new d,h=e.log("info","Computing ...");g.harmonizeFromLeadsheetAPI(JSON.stringify(f),a,function(d){e.removeLog(h),d.success===!0?(e.logAutoFade("success","Harmonization is finished"),c.importFromMusicCSLJSON(d.sequence,b.songModel),$.publish("ToHistory-add",{item:d.sequence,title:"Harmonization - "+a}),$.publish("ToViewer-draw",b.songModel)):e.logAutoFade("error",d.error)})},f}),define(["mustache","modules/core/src/SongModel","utils/UserLog","pubsub"],function(a){function b(){this.el=void 0}return b.prototype.render=function(a,b,c){b=b||!1;var d=this;return"undefined"==typeof this.el||"undefined"!=typeof this.el&&b===!0?void this.initView(a,function(){d.initController(),$.publish("HarmonizerView-render"),"function"==typeof c&&c()
}):void("function"==typeof c&&c())},b.prototype.initView=function(b,c){var d=this;$.get("/modules/Harmonizer/src/HarmonizerTemplate.html",function(e){var f=a.render(e);"undefined"!=typeof b&&(b.innerHTML=f),d.el=f,"function"==typeof c&&c()})},b.prototype.initController=function(){$("#harmonize").click(function(){var a=$("#harmonization_style_select").val();return $.publish("HarmonizerView-compute",a),!1})},b.prototype.unactiveView=function(){$.publish("toHistoryView-unactiveView")},b.prototype.activeView=function(){$.publish("toHistoryView-activeView")},b}),define(["modules/Harmonizer/src/HarmonizerController"],function(a){return{run:function(){test("HarmonizerController",function(b){var c=new a;b.ok(c instanceof a)})}}}),define(["modules/converters/MusicCSLJson/src/SongModel_CSLJson","mustache","utils/UserLog","pubsub"],function(a,b,c){function d(a,b){this.model=a||new HistoryModel,this.songModel=b,this.initSubscribe()}return d.prototype.initSubscribe=function(){var a=this;$.subscribe("HistoryView-selectHistory",function(b,c){a.loadHistory(c)}),$.subscribe("HistoryView-moveSelectHistory",function(b,c){a.moveSelectHistory(c)}),$.subscribe("ToHistory-add",function(b,c){var d="",e="";"string"==typeof c?d=c:(d=c.item,e=c.title),a.addToHistory(d,e)})},d.prototype.loadHistory=function(b){return"undefined"==typeof this.model.historyList[b]?void c.logAutoFade("error","No history available"):(this.model.setCurrentPosition(b),"undefined"!=typeof this.model.getCurrentState().leadsheet&&a.importFromMusicCSLJSON(this.model.getCurrentState().leadsheet,this.songModel),void $.publish("ToViewer-draw",this.songModel))},d.prototype.moveSelectHistory=function(a){if(isNaN(a))throw"HistoryController - moveSelectHistory - inc must be an int "+a;this.loadHistory(this.model.getCurrentPosition()+a)},d.prototype.addToHistory=function(a,b){this.model.addToHistory(a,b),this.model.setCurrentPosition(this.model.historyList.length-1)},d}),define(["mustache","utils/UserLog","pubsub"],function(){var a=function(){this.init()};return a.prototype.init=function(){this.historyList=[],this.currentPosition=0},a.prototype.getCurrentPosition=function(){return this.currentPosition},a.prototype.getCurrentState=function(){return this.historyList[this.currentPosition]},a.prototype.setCurrentPosition=function(a){!isNaN(a)&&a>=0&&a<this.historyList.length&&(this.currentPosition=a,$.publish("HistoryModel-setCurrentPosition",this))},a.prototype.addToHistory=function(a,b){this.historyList=this.historyList.slice(0,this.currentPosition+1);var c=(new Date).toLocaleString();b=b?b:"";var d={leadsheet:a,title:b,time:c};this.historyList.push(d),$.publish("HistoryModel-addToHistory",this)},a}),define(["mustache","utils/UserLog","pubsub"],function(){function a(a){this.el=void 0,this.parentHTML=a?a:$("#rightPanel"),this.initController(),this.initKeyboard(),this.initSubscribe(),this.render()}return a.prototype.render=function(a){if("undefined"!=typeof this.parentHTML){var b="<h3>History</h3>";b+='<ul class="history_ul">';var c="",d="";if("undefined"!=typeof a)for(var e=0,f=a.historyList.length;f>e;e++)d="",e==a.currentPosition&&(d="current_history"),c="",""!==a.historyList[e].title&&(c+=a.historyList[e].title+" "),c+=a.historyList[e].time,b+='<li class="'+d+'" data-history="'+e+'">'+c+"</li>";b+="</ul>",this.parentHTML.html(b),$.publish("HistoryView-render")}},a.prototype.initKeyboard=function(){function a(a){a.preventDefault(),a.stopPropagation()}var b=this;$(document).keydown(function(c){if(b.editing!==!1){{var d=null===c?event.keyCode:c.keyCode;String.fromCharCode(d).toLowerCase()}if(8===d){var e=!1,f=c.srcElement||c.target;e="TEXTAREA"===f.tagName.toUpperCase()||"INPUT"===f.tagName.toUpperCase()&&("TEXT"===f.type.toUpperCase()||"PASSWORD"===f.type.toUpperCase()||"FILE"===f.type.toUpperCase())?f.readOnly||f.disabled:!0,e&&a(c)}90===d&&c.ctrlKey?($.publish("HistoryView-moveSelectHistory",-1),a(c)):89===d&&c.ctrlKey&&($.publish("HistoryView-moveSelectHistory",1),a(c))}})},a.prototype.initController=function(){this.parentHTML.on("click",".history_ul li",function(){var a=parseInt($(this).attr("data-history"),10);$.publish("HistoryView-selectHistory",a)})},a.prototype.initSubscribe=function(){var a=this;$.subscribe("HistoryModel-setCurrentPosition",function(b,c){a.render(c)}),$.subscribe("HistoryModel-addToHistory",function(b,c){a.render(c)}),$.subscribe("toHistoryView-unactiveView",function(){a.unactiveView()}),$.subscribe("toHistoryView-activeView",function(){a.activeView()})},a.prototype.unactiveView=function(){$("#rightPanel").hide("slow")},a.prototype.activeView=function(){$("#rightPanel").show("slow")},a}),define(["modules/History/src/HistoryModel","modules/History/src/HistoryController"],function(a,b){return{run:function(){test("HistoryController",function(c){var d=new a,e=new b(d);e.addToHistory({},"test"),e.addToHistory({},"test2"),c.equal(d.historyList.length,2),e.loadHistory(0),c.equal(d.getCurrentPosition(),0),e.moveSelectHistory(1),c.equal(d.getCurrentPosition(),1),e.moveSelectHistory(-1),c.equal(d.getCurrentPosition(),0)})}}}),define(["modules/History/src/HistoryModel"],function(a){return{run:function(){test("HistoryModel",function(b){var c=new a;b.ok(c instanceof a),c.addToHistory({},"test"),b.equal(c.historyList.length,1),b.equal(c.getCurrentPosition(),0),c.setCurrentPosition(0),b.equal(c.getCurrentPosition(),0),c.addToHistory({},"test2"),c.setCurrentPosition(1),b.equal(c.getCurrentPosition(),1)})}}}),define(function(){function a(a,b,c,d,e){if(!a)throw"BarWidthManager - lineHeight not defined";if(!b)throw"BarWidthManager - lineWidth not defined";if(!c)throw"BarWidthManager - noteWidth not defined";if(!d)throw"BarWidthManager - barsPerLine not defined";if(!e)throw"BarWidthManager - marginTop not defined";this.WIDTH_FACTOR=1.6,this.barsStruct=[],this.lineHeight=Number(a),this.lineWidth=Number(b),this.noteWidth=Number(c),this.barsPerLine=Number(d),this.marginTop=Number(e)}return a.prototype.getMinWidthList=function(a,b){var c,d,e=this,f=[];return a.getSections().forEach(function(g){for(var h=0;h<g.numberOfBars;h++)d=b.getNotesAtBarNumber(h,a),c=d.length*e.noteWidth*e.WIDTH_FACTOR,f.push(c)}),f},a.prototype.assignBarsToLines=function(a,b){function c(a,b){for(var c=0,d=0;b>=d;d++)c+=a[d];return c}for(var d,e,f,g,h,i=0,j=[],k=(this.lineWidth/this.barsPerLine,0);i<a.length||0!==k;){e=[],g=this.barsPerLine+k,b&&0==i&&g++,h=i+g,d=a.slice(i,i+g),k=0;for(var l=d.length-1,m=!0;m&&l>=0;)if(c(d,l)<this.lineWidth)for(m=!1,f=0;l>=f;f++)e[f]=d[f];else l>0?(k++,d.pop(),l--):(e.push(this.lineWidth),m=!1);j.push(e),i+=d.length}return j},a.prototype.getWidths=function(a){function b(a,b){for(var c=[],d=0;d<a.length;d++)a[d]>b&&c.push(d);return c}function c(a){for(var b=[],c=0;a>c;c++)b[c]=0;return b}function d(a,d){for(var e=a.length,f=c(e),g=d/a.length,h=b(a,g),i=0,j=0;j<h.length;j++)f[h[j]]=a[h[j]],i+=a[h[j]];var k=e-h.length,l=d-i,m=Math.round(l/k*1e3)/1e3;for(j=0;j<f.length;j++)0===f[j]&&(f[j]=m);return f}for(var e,f=[],g=0;g<a.length;g++)e=d(a[g],this.lineWidth),f.push(e);return f},a.prototype.setBarsStruct=function(a){this.barsStruct=a},a.prototype.calculateBarsStructure=function(a,b){var c=this.getMinWidthList(a,b),d=1==a.getSection(0).getNumberOfBars(),e=this.assignBarsToLines(c,d);this.setBarsStruct(this.getWidths(e))},a.prototype.getDimensions=function(a){var b,c,d=0,e=0,f=0;for(b=0;b<this.barsStruct.length;b++){for(c=0;c<this.barsStruct[b].length;c++){if(d==a)return{left:f,width:this.barsStruct[b][c],top:e*this.lineHeight+this.marginTop};d++,f+=this.barsStruct[b][c]}f=0,e++}},a.prototype.inSameLine=function(a,b){var c=0,d=-1,e=-1;a:for(var f=0;f<this.barsStruct.length;f++)for(var g=0;g<this.barsStruct[f].length;g++){if(c==a&&(d=f),c==b&&(e=f),-1!=d&&-1!=e)break a;c++}return d==e},a}),define(["vexflow"],function(a){function b(){this.beams=[],this.counter=0,this.lastNoteBeat=-1}return b.prototype.checkBeam=function(a,b,c){function d(a,b){return Math.floor(a)==Math.floor(b)}var e;if(c.isBeamable()){e=a.getNoteBeat(b),d(e,this.lastNoteBeat)||(this.beams[this.counter]&&this.beams[this.counter].length>1&&this.counter++,this.beams[this.counter]=[]);var f=c.getVexflowNote();this.beams[this.counter].push(f),this.lastNoteBeat=e}},b.prototype.getVexflowBeams=function(){for(var b=[],c=0;c<this.beams.length;c++)b[c]=this.beams[c]&&this.beams[c].length>1?new a.Flow.Beam(this.beams[c],!0):null;return b},b.prototype.draw=function(a,b){for(var c=0,d=b.length;d>c;c++)null!==b[c]&&b[c].setContext(a).draw()},b}),define(["vexflow"],function(a){function b(b){this.vexflowStave=new a.Flow.Stave(b.left,b.top,b.width)}return b.prototype.draw=function(b,c,d,e,f){if(0===c.getBarIndex()&&this.vexflowStave.addClef("treble").setContext(b).draw(),0===d.getBarIndex()){var g=d.getSection().getName(),h=parseInt(d.getSection().getRepeatTimes(),10)+1,i="";h>1&&(i+=" (x"+h+")"),""!==g&&this.vexflowStave.setSection(g+i,9)}var j=!0;if(j===!0){b.font="10px Verdana",b.fillStyle="#900";var k=this.getVexflowStave();b.fillText(c.getBarIndex()+1,k.x+3,k.y+37),b.fillStyle="#000",b.font="18px Verdana"}var l=c.getBarKeySignature();l!=c.prevKeySig&&this.vexflowStave.addKeySignature(l);var m=c.getBarTimeSignature();m.toString()!=c.prevTimeSig&&this.vexflowStave.addTimeSignature(m.toString());var n=c.getBar(),o=c.getFollowingBar(),p=n.getEnding();p?(c.setEndingState(o.getEnding()?"BEGIN_END":"BEGIN"),this.vexflowStave.setVoltaType(a.Flow.Volta.type[c.getEndingState()],p+".",e)):null!=c.getEndingState()&&(d.isLastBar()||o.getEnding()?(c.setEndingState("END"),d.isLastBar()||this.vexflowStave.setEndBarType(a.Flow.Barline.type.REPEAT_END),this.vexflowStave.setVoltaType(a.Flow.Volta.type[c.getEndingState()],p+".",e),c.setEndingState(null)):("BEGIN"==c.getEndingState()||"MID"==c.getEndingState())&&(c.setEndingState("MID"),this.vexflowStave.setVoltaType(a.Flow.Volta.type[c.getEndingState()],p+".",e)));var q=n.getLabel();("coda"===q||"coda2"===q)&&this.vexflowStave.setRepetitionTypeRight(a.Flow.Repetition.type.CODA_RIGHT,f),("segno"===q||"segno2"===q)&&this.vexflowStave.setRepetitionTypeRight(a.Flow.Repetition.type.SEGNO_RIGHT,f);var r=n.getSublabel(!0);null!=r&&this.vexflowStave.setRepetitionTypeRight(a.Flow.Repetition.type[r],f),d.isLastBar()&&this.vexflowStave.setEndBarType(a.Flow.Barline.type.END),this.vexflowStave.setContext(b).draw()},b.prototype.getKeySignature=function(){return this.keySignature},b.prototype.getVexflowStave=function(){return this.vexflowStave},b}),define(["vexflow"],function(){function a(a,b){this.color=b||"#000",this.chord=a}return a.prototype.draw=function(a,b,c,d){function e(a,b,c){var d=a-1,e=b.width/c;return b.left+d*e}a.font="18px Verdana",a.textBaseline="top",a.fillStyle=this.color;var f=e(this.chord.getBeat(),b,c.getBeatUnit());a.fillText(this.chord.toString(),f,b.top-d),a.fillStyle="black",a.textBaseline="alphabetic"},a}),define(["vexflow","modules/converters/MusicCSLJson/src/NoteModel_CSLJson"],function(a,b){function c(c){function d(c){var d=b.exportToMusicCSLJSON(c);c.isRest&&(d.keys[0]="B/4");var e=new a.Flow.StaveNote(d);parseInt(e.keyProps[0].octave,null)>=5&&e.setStemDirection(-1);var f,g=[];for(f=0;f<c.getNumPitches();f++)g.push(c.getAccidental(f));for(var h in g)null!=g[h]&&0!==g[h].length&&e.addAccidental(h,new a.Flow.Accidental(g[h]));var i=c.getDot();if(i)for(f=0;i>f;f++)e.addDot(0);return e}this.vexflowNote=d(c),this.note=c}return c.prototype.getVexflowNote=function(){return this.vexflowNote},c.prototype.isBeamable=function(){return/^\d+$/.test(this.vexflowNote.duration)&&!this.note.isRest},c}),define(["vexflow","modules/LSViewer/src/LSNoteView","modules/LSViewer/src/LSChordView","modules/LSViewer/src/LSBarView","modules/LSViewer/src/BeamManager","modules/LSViewer/src/TieManager","modules/LSViewer/src/TupletManager","modules/LSViewer/src/BarWidthManager","modules/core/src/SectionBarsIterator","modules/core/src/SongBarsIterator","pubsub"],function(a,b,c,d,e,f,g,h,i,j){function k(a,b){b=b||{},this.el=a,this._init(a,b),this.drawableModel=[],this._initController(),this._initSubscribe()}return k.prototype._createCanvas=function(a,b,c){var d=$("<canvas id='"+a+"'></canvas>");d[0].width=b,d[0].height=c,d.appendTo(this.divContainer);var e={textAlign:"center"};return this.barWidthMng=null,$(this.divContainer).css(e),d[0]},k.prototype._createLayer=function(){if(!this.canvas)throw"LSViewer cannot create layer because canvas does not exist";var a,b=$(this.canvas),c=$(this.canvas).attr("id"),d=c+"-layer",e=b.offset(),f={position:"absolute",left:e.left,top:e.top};return 0===$("canvas#"+d).length?($("<canvas id='"+d+"' width='"+b.width()+"' height='"+b.height()+"'></canvas>").insertAfter(b),a=$("#"+d),a.css(f),a.css("z-index",10)):a=$("canvas#"+d),a[0].getContext("2d")},k.prototype._initController=function(){function a(a,b){return xpos=b.pageX-a.offset().left,ypos=b.pageY-a.offset().top,{x:xpos,y:ypos}}var b=this;$(this.canvas).mousedown(function(c){$.publish("LSViewer-mousedown",a($(b.canvas),c))}),$(this.canvas).click(function(c){$.publish("LSViewer-click",a($(b.canvas),c))}),$(this.canvas).mousemove(function(c){$.publish("LSViewer-mousemove",a($(b.canvas),c))})},k.prototype._initSubscribe=function(){var a=this;$.subscribe("ToViewer-draw",function(b,c){a.draw(c)})},k.prototype._init=function(b,c){c=c||{},this.DEFAULT_HEIGHT=1e3,this.SCALE=.999,this.CANVAS_DIV_WIDTH_PROPORTION=.8,this.NOTE_WIDTH=20,this.LINE_HEIGHT=150,this.LINE_WIDTH=1160,this.BARS_PER_LINE=4,this.ENDINGS_Y=20,this.LABELS_Y=0,this.MARGIN_TOP=100,this.CHORDS_DISTANCE_STAVE=20,this.DISPLAY_TITLE=void 0!=c.displayTitle?c.displayTitle:!0,this.DISPLAY_COMPOSER=void 0!=c.displayComposer?c.displayComposer:!0,c.lineMarginTop&&(this.MARGIN_TOP+=c.lineMarginTop,this.LINE_HEIGHT+=c.lineMarginTop,this.LINE_MARGIN_TOP=c.lineMarginTop),this.heightOverflow=c.heightOverflow||"auto",this.divContainer=b;var d="ls"+($("canvas").length+1),e=c.width?c.width:$(b).width()*this.CANVAS_DIV_WIDTH_PROPORTION;this.canvas=this._createCanvas(d,e,this.DEFAULT_HEIGHT);var f=new a.Flow.Renderer(this.canvas,a.Flow.Renderer.Backends.CANVAS);this.ctx=f.getContext("2d"),"scale"==c.typeResize?this.SCALE=e/this.LINE_WIDTH*.95:this._setWidth(e),c.layer&&(this.layerCtx=this._createLayer())},k.prototype._setWidth=function(a){var b=a||this.LINE_WIDTH;this.LINE_WIDTH=b},k.prototype._scale=function(){this.ctx.scale(this.SCALE,this.SCALE)},k.prototype._resetScale=function(){this.ctx.scale(1/this.SCALE,1/this.SCALE)},k.prototype._getNonScaledWidth=function(){return this.canvas.width/this.SCALE},k.prototype._displayTitle=function(a){var b=this.ctx.textAlign;this.ctx.textAlign="center",this.ctx.font="32px lato Verdana",this.ctx.fillText(a,this._getNonScaledWidth()/2,60,this._getNonScaledWidth()),this.ctx.textAlign=b},k.prototype._displayComposer=function(a){var b=this.ctx.textAlign;this.ctx.textAlign="right",this.ctx.font="24px lato Verdana","undefined"==typeof a&&(a="Unknown"),this.ctx.fillText(a,this._getNonScaledWidth()-20,20,this._getNonScaledWidth()),this.ctx.textAlign=b},k.prototype.setHeight=function(a,b){var c=a.getComponent("bars").getTotal();this.canvas.height=(b.getDimensions(c-1).top+this.LINE_HEIGHT)*this.SCALE,this.canvas.height>$(this.divContainer).height()&&"scroll"==this.heightOverflow?$(this.divContainer).css({overflowY:"scroll"}):$(this.divContainer).height(this.canvas.height)},k.prototype.addDrawableModel=function(a,b){"undefined"!=typeof a&&("undefined"==typeof b&&(b=11),this.drawableModel.push({elem:a,zIndex:b}),this.sortDrawableModel())},k.prototype.removeDrawableModel=function(a){for(var b=0,c=this.drawableModel.length;c>b;b++)if(this.drawableModel[b].elem===a)return void this.drawableModel[b].slice(b,1)},k.prototype.sortDrawableModel=function(){this.drawableModel.sort(function(a,b){return a.zIndex<b.zIndex?-1:a.zIndex>b.zIndex?1:0})},k.prototype.draw=function(k){if("undefined"==typeof k)return void console.warn("song is empty");var l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=this,A=k.getComponent("notes"),B=k.getComponent("chords"),C=0,D=[],E=[],F=new f;this.barWidthMng=new h(this.LINE_HEIGHT,this.LINE_WIDTH,this.NOTE_WIDTH,this.BARS_PER_LINE,this.MARGIN_TOP),this.barWidthMng.calculateBarsStructure(k,A),this.setHeight(k,this.barWidthMng),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this._scale();var G,H,I=0,J=new j(k);k.getSections().forEach(function(f){for(H=new i(f);H.hasNext();){for(r=new e,s=new g,t=[],p=A.getNotesAtBarNumber(J.getBarIndex(),k),m=0,n=p.length;n>m;m++)F.checkTie(p[m],C),s.checkTuplet(p[m],C),u=new b(p[m]),r.checkBeam(A,C,u),x=u.getVexflowNote(),t.push(x),D.push(x),C++;for(y=z.barWidthMng.getDimensions(J.getBarIndex()),G=new d(y),G.draw(z.ctx,J,H,z.ENDINGS_Y,z.LABELS_Y),E.push({barDimensions:y,timeSignature:J.getBarTimeSignature()}),q=B.getChordsByBarNumber(J.getBarIndex()),l=0,o=q.length;o>l;l++)v=new c(q[l]).draw(z.ctx,y,J.getBarTimeSignature(),z.CHORDS_DISTANCE_STAVE);w=r.getVexflowBeams(),a.Flow.Formatter.FormatAndDraw(z.ctx,G.getVexflowStave(),t,{autobeam:!1}),r.draw(z.ctx,w),s.draw(z.ctx,D),J.next(),H.next()}I++}),F.draw(this.ctx,D,A,this.barWidthMng,k),this.vxfNotes=D,this.vxfBars=E,this.ctx.fillStyle="black",this.ctx.strokeStyle="black",this._displayComposer(k.getComposer()),this._displayTitle(k.getTitle()),this._resetScale(),$.publish("LSViewer-drawEnd",this)},k}),define(["vexflow"],function(a){function b(){this.ties=[],this.numTies=0,this.prevTieType=null}return b.prototype.checkTie=function(a,b){var c;a.isTie()&&(c=a.getTie(),"start"==c?(this.ties[this.numTies]=[],this.ties[this.numTies].push(b)):(("stop"==this.prevTieType||null===this.prevTieType)&&(this.ties[this.numTies]=[],this.ties[this.numTies].push(null)),this.ties[this.numTies].push(b),this.numTies++),"stop_start"==c&&(this.ties[this.numTies]=[],this.ties[this.numTies].push(b)),this.prevTieType=c)},b.prototype.draw=function(b,c,d,e,f){function g(c,d){var e=new a.Flow.StaveTie({first_note:c,last_note:d});e.setContext(b),e.draw()}var h,i,j,k,l;for(var m in this.ties)h=this.ties[m][0],i=this.ties[m][1],l=c[h],j=d.getNoteBarNumber(h,f),k=d.getNoteBarNumber(i,f),e.inSameLine(j,k)||(g(l,null),l=null),g(l,c[i])},b}),define(["vexflow"],function(a){function b(){this.tuplets=[],this.numTuplets=0,this.prevTieType=null}return b.prototype.checkTuplet=function(a,b){var c,d=a.getTuplet();null!=d&&("start"==d?(c=1,this.numTuplets++,this.tuplets[this.numTuplets]=[],this.tuplets[this.numTuplets][0]=b):"stop"==d&&(this.tuplets[this.numTuplets][1]=b))},b.prototype.draw=function(b,c){var d,e;for(var f in this.tuplets)e=c.slice(this.tuplets[f][0],this.tuplets[f][1]+1),d=new a.Flow.Tuplet(e),d.setContext(b).draw()},b}),define(["modules/LSViewer/src/BarWidthManager"],function(a){return{run:function(){var b,c,d,e,f,g=150,h=1160,i=20,j=4,k=100,l=h/j;test("BarWidthManager",function(m){var n=new a(g,h,i,j,k);b=[100,100,100,100,100,100,100,100],d=[[100,100,100,100],[100,100,100,100]],c=n.assignBarsToLines(b),m.deepEqual(c,d),f=[[l,l,l,l],[l,l,l,l]],e=n.getWidths(c),m.deepEqual(e,f),n.setBarsStruct(e),m.ok(n.inSameLine(0,3)),m.ok(!n.inSameLine(3,4)),m.ok(n.inSameLine(4,7)),b=[100,100,100,470,500,300,100,100],d=[[100,100,100,470],[500,300,100,100]],c=n.assignBarsToLines(b),m.deepEqual(c,d),f=[[230,230,230,470],[500,300,180,180]],e=n.getWidths(c),m.deepEqual(e,f),n.setBarsStruct(e),m.ok(n.inSameLine(0,3)),m.ok(!n.inSameLine(3,4)),m.ok(n.inSameLine(4,7)),b=[290,290,290,300,100,100,100,100],d=[[290,290,290],[300,100,100,100,100]],c=n.assignBarsToLines(b),m.deepEqual(c,d),f=[[386.667,386.667,386.667],[300,215,215,215,215]],e=n.getWidths(c),m.deepEqual(e,f),n.setBarsStruct(e),m.ok(n.inSameLine(0,2)),m.ok(!n.inSameLine(2,3)),m.ok(n.inSameLine(3,7)),b=[1290,290,290,300,100,100,100,100],d=[[h],[290,290,300,100,100],[100,100]],c=n.assignBarsToLines(b),m.deepEqual(c,d),e=n.getWidths(c),f=[[h],[290,290,300,140,140],[580,580]],m.deepEqual(e,f),n.setBarsStruct(e),m.ok(!n.inSameLine(0,1)),m.ok(n.inSameLine(1,5)),m.ok(!n.inSameLine(5,6)),b=[290,290,1300,1300,200,200,200,200],d=[[290,290],[h],[h],[200,200,200,200]],c=n.assignBarsToLines(b),m.deepEqual(c,d),f=[[580,580],[h],[h],[l,l,l,l]],e=n.getWidths(c),m.deepEqual(e,f),n.setBarsStruct(e),m.ok(n.inSameLine(0,1)),m.ok(!n.inSameLine(1,2)),m.ok(!n.inSameLine(2,3))})}}}),define(["tests/DisplayTester","modules/LSViewer/src/LSViewer","modules/core/src/SongModel","modules/converters/MusicCSLJson/src/SongModel_CSLJson","modules/WaveManager/src/WaveManager","modules/WaveManager/src/WaveManagerView","modules/WaveManager/src/WaveManagerController","modules/NoteEdition/src/NoteSpaceManager","tests/songs/allRhythmicFigures","tests/songs/AloneTogether","tests/songs/Solar"],function(a,b,c,d,e,f,g,h,i,j,k){return{run:function(){var c=d.importFromMusicCSLJSON(j),h=new a,l=new b($("#ls1")[0],{typeResize:"fluid",heightOverflow:"scroll"});l.draw(c);var m=new b($("#ls2")[0],{typeResize:"scale"});m.draw(c),h.runTest(function(a){var c=d.importFromMusicCSLJSON(i),e=new b(a);e.draw(c)},{width:1200,height:1e3},"Rhythmic figures",["Globally: adapting bars per line to width","Bar 4: all figure durations","Bar8: all tie types","Bar 8 to 9: tie jumping line","Bar 10: triplets"]),song=d.importFromMusicCSLJSON(j),h.runTest(function(a){l=new b(a,{heightOverflow:"scroll"}),l.draw(song)},{width:1200,height:1e3},"Real song: AloneTogether scroll. div height is 1000 and canvas is larger, so it scrolls. "),h.runTest(function(a){l=new b(a,{heightOverflow:"resizeDiv",layer:!0}),l.draw(song),l.layerCtx.font="18px lato Verdana",l.layerCtx.fillText(" This square is drawn in a new layer (canvas) placed on top of the main canvas",65,30),l.layerCtx.fillStyle="rgb(200,0,0)",l.layerCtx.fillRect(10,10,55,50)},{width:1200,height:1e3},"Real song: AloneTogether resideDiv. Same canvas as previous test,  same div height (1000), but now div height is adapted. Also, creating a new layer"),h.runTest(function(a){var c=new e,h=new b(a,{heightOverflow:"resizeDiv",lineMarginTop:150,layer:!0}),i=d.importFromMusicCSLJSON(k);h.draw(i),c.load("/tests/audio/solar.wav",h,i);{var j=new f(a);new g(c)}j.render()},{width:1200,height:1e3},"Painting audio")}}}),define(["modules/MainMenu/src/MainMenuModel","pubsub","mustache"],function(a){function b(b,c){this.model=b||new a,this.view=c;var d=this;$.subscribe("MainMenuView-active_menu",function(a,b){d.activeMenu(b)})}return b.prototype.activeMenu=function(a){var b=this.model.searchMenuIndex(a);if(-1!==b){var c=this.model.getMenu(b);this.model.setCurrentMenu(c),this.pushStateTab(a)}},b.prototype.pushStateTab=function(a){var b={},c="",d=window.location.href.split("#")[0]+"#"+a;history.pushState(b,c,d)},b}),define(["pubsub"],function(){function a(){this.menuList=[],this.currentMenu=this.menuList[0]}return a.prototype.getMenuLength=function(){return this.menuList.length},a.prototype.getMenu=function(a){if(isNaN(a)||"undefined"==typeof this.menuList[a])throw"MainMenuModel - getMenu - index is undefined or is not a number or doesnt exist "+a;return this.menuList[a]},a.prototype.addMenu=function(a){if("undefined"==typeof a||"undefined"==a.title)throw"MainMenuModel - addMenu - menu is undefined"+a;this.hasMenu(a.title)===!1?("undefined"==typeof a.order&&(a.order=this.menuList.length+1),this.menuList.push(a),this.sortMenu(),window.clearTimeout(this.eventOptimizer),this.eventOptimizer=window.setTimeout(function(){$.publish("MainMenuModel-addMenu",a)},10)):console.warn("MainMenuModel - addMenu - menu "+a.title+" already exist")},a.prototype.sortMenu=function(){this.menuList.sort(function(a,b){return a.order>b.order?1:a.order<b.order?-1:0})},a.prototype.hasMenu=function(a){if(""==typeof a)throw"MainMenuModel - hasModule - menuTitle can't be equal to an empty string";for(var b=0,c=this.menuList.length;c>b;b++)if(this.menuList[b].title===a)return!0;return!1},a.prototype.searchMenuIndex=function(a){if(""==typeof a)throw"MainMenuModel - searchMenuIndex - menuTitle can't be equal to an empty string";for(var b=0,c=this.menuList.length;c>b;b++)if(this.menuList[b].title===a)return b;return-1},a.prototype.removeMenu=function(a){var b=this.searchMenuIndex(a);return-1!==b?(this.menuList[b]=void 0,this.menuList.splice(b,1),$.publish("MainMenuModel-removeMenu",a),!0):!1},a.prototype.getCurrentMenu=function(){return this.currentMenu},a.prototype.setCurrentMenu=function(a){"undefined"!=typeof a&&(this.currentMenu=a,$.publish("MainMenuModel-setCurrentMenu",this.currentMenu))},a}),define(["modules/MainMenu/src/MainMenuModel","pubsub","mustache"],function(a,b,c){function d(b,c){this.model=b?b:new a,this.el=void 0,this.selectedClassName="main_menu_first_level_selected";var d=this;"undefined"!=typeof c&&this.initView(c,function(){d.initSubscribe(),d.initController(),$.publish("MainMenuView-render")})}return d.prototype.initView=function(a,b){var d=this;$.get("/modules/MainMenu/src/MainMenuTemplate.html",function(e){var f=c.render(e);a.innerHTML+=f,d.el=a,"function"==typeof b&&b()})},d.prototype.initSubscribe=function(){var a=this;$.subscribe("MainMenuModel-addMenu",function(){a.removeMenu(),a.buildMenu()}),$.subscribe("MainMenuModel-removeMenu",function(b,c){a.removeMenu(c)}),$.subscribe("MainMenuModel-setCurrentMenu",function(b,c){a.setCurrentMenu(c)})},d.prototype.initController=function(){$("body").on("click",".main_menu_item",function(){var a=$(this).attr("data-menuTitle");$.publish("MainMenuView-active_menu",a)})},d.prototype.buildMenu=function(){var a="",b="";$("#main_menu_first_level").html(),$("#main_menu_second_level").html();var c=this.model.getCurrentMenu(),d=-1;"undefined"!=typeof c&&(d=this.model.searchMenuIndex(c.title));for(var e,f="",g="",h=0,i=this.model.getMenuLength();i>h;h++)e=this.model.getMenu(h),g=' style="display:none"',f="",h===d&&(f=this.selectedClassName,g=""),a+='<div id="'+this._concatTitle(e.title)+'_first_level" class="first_level main_menu_item '+f+'" data-menuTitle="'+e.title+'">'+e.title+"</div>",b+='<div id="'+this._concatTitle(e.title)+'_second_level" class="second_level" data-menuTitle="'+e.title+'"'+g+">"+e.view.el+"</div>";for($("#main_menu_first_level").html(a),$("#main_menu_second_level").html(b),h=0,i=this.model.getMenuLength();i>h;h++)e=this.model.getMenu(h),e.view.initController()},d.prototype.removeMenu=function(a){$("#"+a+"_first_level").remove(),$("#"+a+"_second_level").remove()},d.prototype.setCurrentMenu=function(a){this.hideAllMenus(a),this.showMenu(a)},d.prototype._concatTitle=function(a){return a.replace(" ","_")},d.prototype.hideAllMenus=function(a){$("#main_menu_second_level > div").each(function(){$(this).hide()});for(var b=this,c=0,d=this.model.menuList.length;d>c;c++)this.model.menuList[c]!==a&&this.model.menuList[c].view&&"function"==typeof this.model.menuList[c].view.unactiveView&&this.model.menuList[c].view.unactiveView();$("."+this.selectedClassName).each(function(){$(this).removeClass(b.selectedClassName)})},d.prototype.showMenu=function(a){var b=this;a.view&&"function"==typeof a.view.activeView&&a.view.activeView(),$("#"+this._concatTitle(a.title)+"_first_level").addClass(b.selectedClassName),$("#"+this._concatTitle(a.title)+"_second_level").show(0,function(){})},d.prototype.hide=function(){this.el.style.display="none"},d.prototype.show=function(){this.el.style.display="block"},d}),define(["modules/MainMenu/src/MainMenuModel","modules/MainMenu/src/MainMenuController","modules/MainMenu/src/MainMenuView","modules/Harmonizer/src/HarmonizerController","modules/Harmonizer/src/HarmonizerView"],function(a,b){return{run:function(){test("MainMenuController",function(a){var c=new b;a.ok(c instanceof b)})}}}),define(["modules/MainMenu/src/MainMenuModel"],function(a){return{run:function(){test("MainMenuModel",function(b){var c=new a;b.ok(c instanceof a),b.equal(c.getCurrentMenu(),void 0),c.setCurrentMenu("title"),b.equal(c.getCurrentMenu("title"),"title"),b.ok(c.hasMenu("menu1")===!1),b.equal(c.getMenuLength(),0),c.addMenu({title:"menu1"}),b.equal(c.getMenuLength(),1),b.ok(c.hasMenu("menu1")===!0);var d=new a;d.addMenu({title:"menu1"}),d.addMenu({title:"menu2"}),d.addMenu({title:"menu3"}),b.equal(d.getMenuLength(),3),b.ok(d.removeMenu("menu2")),b.equal(d.getMenuLength(),2)})}}}),define(["mustache","modules/MidiCSL/src/model/PlayerModel_MidiCSL","utils/UserLog","pubsub"],function(a,b){function c(a,c){this.model=a||new b,this.view=c,this.initView(),this.initSubscribe()}return c.prototype.initSubscribe=function(){var a=this;$.subscribe("PlayerView-play",function(b,c){a.play(c)}),$.subscribe("PlayerView-playFromPercent",function(b,c){a.playFromPercent(c.tempo,c.percent)}),$.subscribe("PlayerView-stop",function(){a.stop()}),$.subscribe("PlayerView-pause",function(){a.pause()}),$.subscribe("PlayerView-playPause",function(){a.pause()}),$.subscribe("PlayerView-onToggleMute",function(b,c){a.toggleMute(c)}),$.subscribe("PlayerView-onVolume",function(b,c){a.onVolumeChange(c)}),$.subscribe("PlayerView-onToggleMetronome",function(b,c){a.metronomeChange(c)}),$.subscribe("PlayerView-onTempo",function(){}),$.subscribe("PlayerView-onChordInstrumentChange",function(b,c){a.onChordInstrumentChange(c)}),$.subscribe("PlayerView-onMelodyInstrumentChange",function(b,c){a.onMelodyInstrumentChange(c)}),$.subscribe("PlayerView-toggleLoop",function(){a.toggleLoop()}),$.subscribe("PlayerView-render",function(){a.initView()})},c.prototype.playPause=function(a){this.model.playState?this.model.pause():this.model.play(a)},c.prototype.playFromPercent=function(a,b){var c=this.model.getSongDuration()*b;this.model.play(a,c)},c.prototype.play=function(a,b){this.model.play(a,b)},c.prototype.stop=function(){this.model.stop()},c.prototype.pause=function(){this.model.pause()},c.prototype.tempoChange=function(a){this.model.setTempo(a),this.model.stop()},c.prototype.toggleLoop=function(){this.model.toggleLoop()},c.prototype.toggleMute=function(a){0===a?this.model.mute():this.model.unmute()},c.prototype.metronomeChange=function(a){a?this.model.unmuteMetronome():this.model.muteMetronome()},c.prototype.onVolumeChange=function(a){0===a?this.model.mute():this.model.setVolume(a)},c.prototype.onChordInstrumentChange=function(a){this.model.setChordsInstrument(a)},c.prototype.onMelodyInstrumentChange=function(a){this.model.setMelodyInstrument(a)},c.prototype.initView=function(){$.publish("PlayerModel_MidiCSL-onvolumechange",this.model.getMelodyVolume())},c}),define(["mustache","utils/UserLog","pubsub","bootstrap"],function(a){function b(a,b){this.displayMetronome="undefined"!=typeof b&&"undefined"!=typeof b.displayMetronome?b.displayMetronome:!1,this.displayLoop="undefined"!=typeof b&&"undefined"!=typeof b.displayLoop?b.displayLoop:!1,this.displayTempo="undefined"!=typeof b&&"undefined"!=typeof b.displayTempo?b.displayTempo:!1,this.changeInstrument="undefined"!=typeof b&&"undefined"!=typeof b.changeInstrument?b.changeInstrument:!1,this.progressBar="undefined"!=typeof b&&"undefined"!=typeof b.progressBar?b.progressBar:!1,this.el=void 0,this.initSubscribe();this.render(a,!0)}return b.prototype.render=function(a,b,c){b=b||!1;var d=this;return"undefined"==typeof this.el||"undefined"!=typeof this.el&&b===!0?void this.initView(a,function(){d.initTemplate(),d.initController(),$.publish("PlayerView-render"),"function"==typeof c&&c()}):void("function"==typeof c&&c())},b.prototype.initView=function(b,c){var d=this;$.get("/modules/MidiCSL/src/PlayerTemplate_MidiCSL.html",function(e){var f=a.render(e,{displayLoop:d.displayLoop,displayMetronome:d.displayMetronome,displayTempo:d.displayTempo,changeInstrument:d.changeInstrument,progressBar:d.progressBar});"undefined"!=typeof b&&(b.innerHTML=f),d.el=b,"function"==typeof c&&c()})},b.prototype.initTemplate=function(){var a=this.getTempo();if("undefined"!=typeof globalVariables&&"undefined"!==globalVariables.tempo&&null!==globalVariables.tempo){var b=parseInt(globalVariables.tempo.minTempo,10),c=parseInt(globalVariables.tempo.maxTempo,10),d=c-b;a=Math.round(Math.random()*d+b),$("#tempo_container #tempo").val(a)}},b.prototype.initController=function(){var a=this;$("#play_button_container").click(function(){var b=a.getTempo();$.publish("PlayerView-play",b)
}),$("#stop_button_container").click(function(){$.publish("PlayerView-stop")}),$("#pause_button_container").click(function(){$.publish("PlayerView-pause")}),$("#loop_button_container").click(function(){$.publish("PlayerView-toggleLoop")}),$("#tempo_container #tempo").on("change",function(){var a=$(this).val();$("#pause_button_container").hide(),$("#play_button_container").show(),$.publish("PlayerView-onTempo",a)}),$("#metronome_container").click(function(){$("#metronome_container .metronome_on").is(":visible")?$.publish("PlayerView-onToggleMetronome",!1):$.publish("PlayerView-onToggleMetronome",!0)}),$("#volume_container").click(function(){$("#volume_container .sound_off").is(":visible")?$.publish("PlayerView-onToggleMute"):$.publish("PlayerView-onToggleMute",0)});var b=!1;$("#volume_controller_barre").bind("dragstart",function(a){return a.preventDefault(),!1}),$("#volume_controller").bind("dragstart",function(a){return a.preventDefault(),!1}),$("#volume_controller_barre").mousedown(function(){b=!0}),$("#volume_controller_barre").mouseup(function(){b=!1}),$("body").mouseup(function(){b=!1}),$("#volume_controller").mousemove(function(c){b&&a._dragVolumeController(c)}),$("#volume_controller").mousedown(function(c){a._dragVolumeController(c),b=!0}),$("#volume_controller").mouseup(function(){b=!1}),$("#volume_controller_barre").mousemove(function(c){b&&a._dragVolumeController(c)}),$("#chords_instrument_container select").change(function(){$.publish("PlayerView-onChordInstrumentChange",$(this).val())}),$("#melody_instrument_container select").change(function(){$.publish("PlayerView-onMelodyInstrumentChange",$(this).val())}),$(".progress_bar_player").click(function(b){var c=$(this).width(),d=b.pageX-$(this).parent().offset().left,e=a.getTempo();$.publish("PlayerView-playFromPercent",{tempo:e,percent:d/c}),b.preventDefault()}),$(document).keydown(function(b){if(32==b.keyCode){var c=b.srcElement||b.target;if("TEXTAREA"!==c.tagName.toUpperCase()&&("INPUT"!==c.tagName.toUpperCase()||"TEXT"!==c.type.toUpperCase()&&"PASSWORD"!==c.type.toUpperCase()&&"FILE"!==c.type.toUpperCase())){var d=a.getTempo();$.publish("PlayerView-play-pause",d),b.preventDefault()}}})},b.prototype.initSubscribe=function(){var a=this;$.subscribe("PlayerModel_MidiCSL-onplay",function(){a.play()}),$.subscribe("PlayerModel_MidiCSL-onpause",function(){a.pause()}),$.subscribe("PlayerModel_MidiCSL-onstop",function(){a.pause()}),$.subscribe("PlayerModel_MidiCSL-onfinish",function(){a.pause()}),$.subscribe("PlayerModel_MidiCSL-onloopstart",function(){}),$.subscribe("PlayerModel_MidiCSL-toggleLoop",function(b,c){c?a.activeLoop():a.unactiveLoop()}),$.subscribe("PlayerModel_MidiCSL-onvolumechange",function(b,c){a.setVolume(c)}),$.subscribe("PlayerModel_MidiCSL-onload",function(){a.playerIsReady()}),$.subscribe("PlayerModel_MidiCSL-onChordsInstrument",function(){}),$.subscribe("PlayerModel_MidiCSL-onMelodyInstrument",function(){}),$.subscribe("PlayerModel_MidiCSL-toggleMetronome",function(b,c){c?a.muteMetronome():a.unmuteMetronome()}),$.subscribe("PlayerModel_MidiCSL-onPosition",function(b,c){a.updateProgressbar(100*c.positionInPercent,c.songDuration)})},b.prototype.play=function(){$("#pause_button_container").show(),$("#pause_button_container").css("display","inline-block"),$("#play_button_container").hide()},b.prototype.pause=function(){$("#pause_button_container").hide(),$("#play_button_container").show()},b.prototype.playerIsReady=function(){$("#play_button img").attr("src","/modules/MidiCSL/img/play.png"),$("#play_button_container").css("color","black"),$("#play_button_container .player_text").html("Play")},b.prototype.playerIsNotReady=function(){$("#play_button img").attr("src","/modules/MidiCSL/img/play_grey.png"),$("#play_button_container").css("color","grey"),$("#play_button_container .player_text").html("Loading")},b.prototype.activeLoop=function(){$("#loop_button img").attr("src","/modules/MidiCSL/img/loop.png").attr("title","Loop is on")},b.prototype.unactiveLoop=function(){$("#loop_button img").attr("src","/modules/MidiCSL/img/loop_grey.png").attr("title","Loop is off")},b.prototype.setVolume=function(a){isNaN(a)||0>a||(this.adaptSoundButton(a),this.setControllerPosition(1-a))},b.prototype.muteMetronome=function(){$("#metronome_container .metronome_off").hide(),$("#metronome_container .metronome_on").show()},b.prototype.unmuteMetronome=function(){$("#metronome_container .metronome_on").hide(),$("#metronome_container .metronome_off").show()},b.prototype.adaptSoundButton=function(a){.33>a&&(pic="sound_off"),a>0&&.33>=a?pic="sound_1":a>.33&&.66>=a?pic="sound_2":a>.66&&(pic="sound_on"),$("#volume_container ."+pic).is(":visible")||($("#volume_container .sound_off").hide(),$("#volume_container .sound_on").hide(),$("#volume_container .sound_1").hide(),$("#volume_container .sound_2").hide(),$("#volume_container ."+pic).show())},b.prototype.getTempo=function(){var a=$("#tempo_container #tempo").val();return"undefined"==typeof a&&(a=120),a},b.prototype._convertSecondToPrintableTime=function(a){if(isNaN(a))throw"PlayerView - _convertSecondToPrintableTime, seconds is not a number "+a;var b=new Date(null);return b.setSeconds(a),b.toISOString().substr(14,5)},b.prototype.updateProgressbar=function(a,b){var c=$(".progress_bar_player").find("div");c.attr("aria-valuenow",a),c.css("width",a+"%");var d=c.find("span"),e=a/100*b/1e3,f=b/1e3,g=this._convertSecondToPrintableTime(e),h=this._convertSecondToPrintableTime(f);d.text(g+" / "+h)},b.prototype._dragVolumeController=function(a){var b=$("#volume_controller").height(),c=$("#volume_controller").offset().top,d=a.pageY,e=5,f=b-2*e,g=d-c;e>g&&(g=e),g>b-e&&(g=b-e);var h=1-(g-e)/f;$.publish("PlayerView-onVolume",h)},b.prototype.setControllerPosition=function(a){var b=5,c=$("#volume_controller").height();null===c&&(c=68);var d=c-2*b,e=a*d;b>e&&(e=b),e>c-b&&(e=c);var f=$("#volume_controller_barre").height()/2;$("#volume_controller_barre").css({top:e-f+"px"})},b.prototype.hide=function(){this.el.style.display="none"},b.prototype.show=function(){this.el.style.display="inline-block"},b}),define(["modules/core/src/SongModel","modules/core/src/ChordManager","modules/core/src/ChordModel","modules/MidiCSL/src/model/NoteModel_midiCSL","utils/NoteUtils","utils/ChordUtils","modules/MidiCSL/utils/MidiHelper"],function(a,b,c,d,e,f,g){var h={};return h.exportToMidiCSL=function(a){if(!a instanceof c)throw"ChordConverterMidi_MidiCSL - exportToMidiCSL - chordModel parameters must be an instanceof SongModel";var b=h.getAllMidiNotes(a);return b},h.getAllMidiNotes=function(a){var b=h.getChordTypesNotes(a);if("undefined"!=typeof b){if(a.isEmptyBase()===!1){var c=a.getBase().getNote(),d=e.pitch2Number(c),f=e.number2Pitch(d-j);b.unshift(f+"3")}var i=g.convertNotesToMidi(b),j=e.pitch2Number(a.getNote()),k=g.transposeMidiNotes(i,j);return k}},h.getChordTypesNotes=function(a){var b=a.getNote();if("NC"===b)return a.allMidiNotes=[],void("undefined"!=typeof callback&&callback([]));var c=a.unformatChordType(a.getChordType()),d=f.getAllChordTypes();if("undefined"!=typeof d&&"undefined"!=typeof d[c]){var e=d[c];return e}return console.warn("ChordConverterMidi_MidiCSL: Unknown chord "+a.toString()),[]},h.convertNotesToMidi=function(a){return a.allMidiNotes=g.convertNotesToMidi(a.allNotes),a.allMidiNotes},h}),define(["modules/core/src/SongModel","modules/core/src/ChordManager","modules/MidiCSL/src/converters/ChordConverterMidi_MidiCSL","modules/MidiCSL/src/model/NoteModel_midiCSL"],function(a,b,c,d){var e={};return e.exportToMidiCSL=function(b){if(!b instanceof a)throw"ChordManagerConverterMidi_MidiCSL - exportToMidiCSL - songModel parameters must be an instanceof SongModel";var e=[];if("undefined"===b.getComponent("chords"))return void 0;for(var f,g=b.getComponent("chords"),h=0,i=[],j=0,k=[],l=b.getUnfoldedSongComponents("chords"),m=0,n=l.length;n>m;m++)if(k=l[m],0===k.length){j=g.getChordDurationFromBarNumber(b,f,m)*b.timeSignature.getBeatUnitQuarter();var o=new d({currentTime:h,duration:j,midiNote:i,type:"chord"});h+=j,e.push(o)}else for(var p=0,q=k.length;q>p;p++){f=g.getChordIndex(k[p]),j=g.getChordDurationFromBarNumber(b,f,m)*b.timeSignature.getBeatUnitQuarter(),i=c.exportToMidiCSL(k[p]);var o=new d({currentTime:h,duration:j,midiNote:i,type:"chord"});h+=j,e.push(o)}return e},e}),define(["modules/core/src/SongModel","modules/MidiCSL/src/model/SongModel_midiCSL","modules/MidiCSL/src/model/NoteModel_midiCSL","modules/MidiCSL/src/converters/ChordManagerConverterMidi_MidiCSL","modules/MidiCSL/utils/MidiHelper"],function(a,b,c,d,e){var f={};return f.exportToMidiCSL=function(b){if(!b instanceof a)throw"SongConverterMidi_MidiCSL - exportToMusicCSLJSON - songModel parameters must be an instanceof SongModel";var c=[];c=d.exportToMidiCSL(b);var e=b.getComponent("notes");if("undefined"!=typeof e){var g=f.exportNoteToMidiCSL(b);c=c.concat(g)}return c},f.exportNoteToMidiCSL=function(a){function b(a){if("undefined"!=typeof a){for(var b,c,d,f=[],g=0,h=a.getNumPitches();h>g;g++)c=a.getAccidental(g),d=a.getPitchClass(g),"n"===c?u[d]=d:"#"===c?u[d]=d+"#":"b"===c?u[d]=d+"b":"##"===c?u[d]=d+"##":"bb"===c&&(u[d]=d+"bb"),b=u[d]+a.getOctave(g),b=e.convertDoubleAccidental(b),b=e.convertSharp2Flat(b),b=e.detectImpossibleFlat(b),f[g]=b;return[f,u]}}function d(a){if("undefined"!=typeof a){var b={A:"A",B:"B",C:"C",D:"D",E:"E",F:"F",G:"G"};switch(a){case"Cb":jQuery.extend(b,{B:"Bb",E:"Eb",A:"Ab",D:"Db",G:"Gb",C:"Cb",F:"Fb"});break;case"Gb":jQuery.extend(b,{B:"Bb",E:"Eb",A:"Ab",D:"Db",G:"Gb",C:"Cb"});break;case"Db":jQuery.extend(b,{B:"Bb",E:"Eb",A:"Ab",D:"Db",G:"Gb"});break;case"Ab":jQuery.extend(b,{B:"Bb",E:"Eb",A:"Ab",D:"Db"});break;case"Eb":jQuery.extend(b,{B:"Bb",E:"Eb",A:"Ab"});break;case"Bb":jQuery.extend(b,{B:"Bb",E:"Eb"});break;case"F":jQuery.extend(b,{B:"Bb"});break;case"C":break;case"G":jQuery.extend(b,{F:"F#"});break;case"D":jQuery.extend(b,{F:"F#",C:"C#"});break;case"A":jQuery.extend(b,{F:"F#",C:"C#",G:"G#"});break;case"E":jQuery.extend(b,{F:"F#",C:"C#",G:"G#",D:"D#"});break;case"B":jQuery.extend(b,{F:"F#",C:"C#",G:"G#",D:"D#",A:"A#"});break;case"F#":jQuery.extend(b,{F:"F#",C:"C#",G:"G#",D:"D#",A:"A#",E:"E#"});break;case"C#":jQuery.extend(b,{F:"F#",C:"C#",G:"G#",D:"D#",A:"A#",E:"E#",B:"B#"})}return b}}var f=[];if("undefined"==typeof a||"undefined"==typeof e)return f;var g="C",h=4;"undefined"!=typeof a&&(g=a.getTonality());var i,j,k,l,m,n=d(g),o=0,p=[],q=[],r={},s=0,t=!1,u=JSON.parse(JSON.stringify(n)),v=0,w=!1,x=a.getUnfoldedSongStructure();0===x.length&&(x[0]=0);for(var y=0,z=x.length;z>y;y++){v=x[y],h=a.getTimeSignatureAt(v).getBeats(),m=a.getComponentsAtBarNumber(v,"notes"),t===!1?(w=!0,n=d(a.getTonalityAt(v)),u=JSON.parse(JSON.stringify(n))):w=!1;for(var A=0,B=m.length;B>A;A++){if(i=m[A],j=i.getDuration(h),i.isRest)l=new c({midiNote:[!1],type:"melody",currentTime:o,duration:j,noteModel:i}),f.push(l);else{q=b(i,u),k=q[0],u=q[1],p=[];for(var C=0;C<k.length;C++)p[C]=e.keyToNote[k[C]];i.isTie()&&1!==z?("start"===i.getTie()&&(t=!0,s=1,r=new c({midiNote:p,type:"melody",currentTime:o,duration:j,noteModel:i}),l=new c({midiNote:!1,type:"melody",currentTime:o,duration:j,noteModel:i}),f.push(l)),"stop_start"===i.getTie()&&(s++,r.setDuration(r.getDuration(h)+j),l=new c({midiNote:!1,type:"melody",currentTime:o,duration:j,noteModel:i}),f.push(l)),"stop"===i.getTie()&&(w===!1&&(w=!0,n=d(a.getTonalityAt(v)),u=JSON.parse(JSON.stringify(n))),t=!1,s++,"undefined"==typeof r.getDuration?r=l=new c({midiNote:p,type:"melody",currentTime:o,duration:j,noteModel:i}):r.setDuration(r.getDuration(h)+j),r.tieNotesNumber=s,l=r,f.push(r),s=0)):(l=new c({midiNote:p,type:"melody",currentTime:o,duration:j,noteModel:i}),f.push(l))}o+=j}}return f},f}),define([],function(){function a(a){this.currentTime="undefined"!=typeof a&&"undefined"!=typeof a.currentTime?a.currentTime:0,this.duration="undefined"!=typeof a&&"undefined"!=typeof a.duration?a.duration:0,this.type="undefined"!=typeof a&&"undefined"!=typeof a.type?a.type:void 0,this.midiNote="undefined"!=typeof a&&"undefined"!=typeof a.midiNote?a.midiNote:[]}return a.prototype.getCurrentTime=function(){return this.currentTime},a.prototype.setCurrentTime=function(a){if("undefined"==typeof a||isNaN(a)||0>a)throw"NoteModel_MidiCSL - setCurrentTime - currentTime must be a positive float "+a;this.currentTime=a},a.prototype.getDuration=function(){return this.duration},a.prototype.setDuration=function(a){if("undefined"==typeof a||isNaN(a)||0>a)throw"NoteModel_MidiCSL - setCurrentTime - duration must be a positive float "+a;this.duration=a},a.prototype.getType=function(){return this.type},a.prototype.setType=function(a){if("undefined"==typeof a)throw"NoteModel_MidiCSL - setType - type is undefined "+a;this.type=a},a.prototype.getMidiNote=function(){return this.midiNote},a.prototype.setMidiNote=function(a){if("undefined"==typeof a)throw"NoteModel_MidiCSL - setType - midiNote is undefined "+a;this.midiNote=a},a.prototype.getTransposeMidiNote=function(a){var b,c=[];if("undefined"!==this.midiNote)for(var d=0,e=this.midiNote.length;e>d;d++)b=this.midiNote[d]+a,b>=21&&108>=b&&(c[d]=b);return c},a.prototype.serialize=function(){var a={};return a.currentTime=this.currentTime,a.duration=this.duration,a.type=this.type,a.midiNote=this.midiNote,a},a.prototype.clone=function(){return new a(this.serialize())},a}),define(["modules/core/src/SongModel","modules/MidiCSL/src/converters/SongConverterMidi_MidiCSL","modules/MidiCSL/src/model/SongModel_MidiCSL","Midijs","pubsub"],function(a,b,c,d){function e(a,b){this.isReady=!1,this.indexPosition=0,this.playState=!1,this.songModel=a;var c;c="undefined"!=typeof b&&"undefined"!=typeof b.volume?b.volume:this.initVolume(.7),this.chords={volume:c,tmpVolume:c,instrument:"undefined"!=typeof b&&"undefined"!=typeof b.chordsInstrument?b.chordsInstrument:0},this.melody={volume:c,tmpVolume:c,instrument:"undefined"!=typeof b&&"undefined"!=typeof b.melodyInstrument?b.melodyInstrument:0},this.activeMetronome="undefined"!=typeof b&&"undefined"!=typeof b.activeMetronome?b.activeMetronome:!1,this.loop="undefined"!=typeof b&&"undefined"!=typeof b.loop?b.loop:!1,"undefined"!=typeof b&&"undefined"!=typeof b.editor?(this.editor=b.editor,this.showCursorBool="undefined"!=typeof b&&"undefined"!=typeof b.showCursorBool?b.showCursorBool:!0):this.showCursorBool=!1,this.autoload="undefined"!=typeof b&&"undefined"!=typeof b.autoload?b.autoload:!0,this.autoload&&this.load(),this._startTime=0}return e.prototype.setSong=function(b){if("undefined"==typeof b||!(b instanceof a))throw"PlayerModel_MidiCSL- setSong, song model shouldn't be empty and should be a SongModel instance"+b;this.songModel=b},e.prototype.load=function(){"undefined"!=typeof d&&(this.instrumentsIndex=this.getAllInstrumentsIndex(),this.instrumentsName=this.getAllInstrumentsName(),this.initMidiChannels(this.instrumentsIndex),this.initMidiPlugin(this.instrumentsName))},e.prototype.getReady=function(){return this.isReady},e.prototype.setReady=function(a){"undefined"!=typeof a&&(this.isReady=a)},e.prototype.getPlayState=function(){return this.playState},e.prototype.doLoop=function(){return this.loop},e.prototype.setLoop=function(a){return"undefined"!=typeof a?(this.loop=!!a,$.publish("PlayerModel_MidiCSL-toggleLoop",a),!0):!1},e.prototype.toggleLoop=function(){return this.setLoop(this.loop===!0?!1:!0),this.loop},e.prototype.mute=function(){this.chords.tmpVolume=this.getChordsVolume(),this.melody.tmpVolume=this.getMelodyVolume(),this.setVolume(0)},e.prototype.unmute=function(){this.setVolume(this.chords.tmpVolume)},e.prototype.doMetronome=function(){return this.activeMetronome},e.prototype.muteMetronome=function(){this.activeMetronome=!1,$.publish("PlayerModel_MidiCSL-toggleMetronome",!1)},e.prototype.unmuteMetronome=function(){this.activeMetronome=!0,$.publish("PlayerModel_MidiCSL-toggleMetronome",!0)},e.prototype.initVolume=function(a){var b=localStorage.getItem("player-volume");return null===b?a:b},e.prototype.setVolume=function(a){if("undefined"==typeof a||isNaN(a))throw"PlayerModel_MidiCSL - setVolume - volume must be a number "+a;$.publish("PlayerModel_MidiCSL-onvolumechange",a),this.setMelodyVolume(a),this.setChordsVolume(a),localStorage.setItem("player-volume",a)},e.prototype.getChordsVolume=function(){return this.chords.volume},e.prototype.setChordsVolume=function(a){if("undefined"==typeof a||isNaN(a))throw"PlayerModel_MidiCSL - setChordsVolume - volume must be a number "+a;this.chords.volume=a},e.prototype.getMelodyVolume=function(){return this.melody.volume},e.prototype.setMelodyVolume=function(a){if("undefined"==typeof a||isNaN(a))throw"PlayerModel_MidiCSL - setMelodyVolume - volume must be a number "+a;this.melody.volume=a},e.prototype.getChordsInstrument=function(){return this.chords.instrument},e.prototype.setChordsInstrument=function(a){return"undefined"!=typeof a?(this.chords.instrument=a,$.publish("PlayerModel_MidiCSL-onChordsInstrument",a),!0):!1},e.prototype.getMelodyInstrument=function(){return this.melody.instrument},e.prototype.setMelodyInstrument=function(a){return"undefined"!=typeof a?(this.melody.instrument=a,$.publish("PlayerModel_MidiCSL-onMelodyInstrument",a),!0):!1},e.prototype.getPositionIndex=function(){return this.indexPosition},e.prototype.setPositionIndex=function(a){if("undefined"==typeof a||isNaN(a))throw"PlayerModel_MidiCSL - setPositionIndex - indexPosition must be a number "+a;this.indexPosition=a},e.prototype.setPositionInPercent=function(a){if("undefined"==typeof a||isNaN(a))throw"PlayerModel_MidiCSL - setPositionInPercent - positionInPercent must be a float "+a;this.positionInPercent=a,$.publish("PlayerModel_MidiCSL-onPosition",{positionInPercent:a,songDuration:this.songDuration})},e.prototype.getPosition=function(){if("undefined"==typeof this._startTime||isNaN(this._startTime)||"undefined"==typeof this.songDuration||isNaN(this.songDuration))throw"PlayerModel_MidiCSL - getPosition - _startTime and songDuration must be numbers "+this._startTime+" "+this.songDuration;var a=(Date.now()-this._startTime)/this.songDuration;return a>1&&(a=1),a},e.prototype.getSongDuration=function(){return this.songDuration?this.songDuration:0},e.prototype.getBeatDuration=function(a){if("undefined"==typeof a||isNaN(a))throw"PlayerModel_MidiCSL - getBeatDuration - tempo must be a number "+a;return 1e3*(60/a)},e.prototype.play=function(a,e,f){if("undefined"==typeof a||isNaN(a))throw"PlayerModel_MidiCSL - play - tempo must be a number "+a;this.emptyPlayNotes();var g=b.exportToMidiCSL(this.songModel),h=new c({song:g}),i=h.generateMetronome(this.songModel);h.setFromType(i,"metronome");var j=h.getSong();if(0!==j.length&&this.getReady()===!0){var k=this,l=h.getLastNote(),m=this.getBeatDuration(a);this.noteTimeOut=[];{var n=l.getCurrentTime()+l.getDuration();n*m+Date.now()}this.songDuration=n*m,this.playState=!0,$.publish("PlayerModel_MidiCSL-onplay"),("undefined"==typeof e||isNaN(e))&&(e=j[this.indexPosition].getCurrentTime()*m),this._startTime=Date.now()-e;for(var o,p,q,r,s,t,u=80,v=40,w=0,x=this.instrumentsIndex.length-1,y=!1,z=0,A=j.length;A>z;z++)if(o=j[z],o&&o.getCurrentTime()*m>=e)for(var B=0,C=o.getMidiNote().length;C>B;B++)!function(b,c,g,h){k.noteTimeOut[c]=setTimeout(function(){"undefined"!==b.getMidiNote()&&(p=b.getMidiNote()[h],y=!1,"melody"==b.getType()?(s=k.getMelodyInstrument(),t=127*k.getMelodyVolume(),r=Math.random()*v+u,y=!0):"chord"==b.getType()?(s=k.getChordsInstrument(),t=80*k.getChordsVolume(),r=Math.random()*v+u,d.setVolume(s,80*k.getChordsVolume()),y=!0):"metronome"==b.getType()&&k.doMetronome()===!0&&(s=x,t=127*k.getMelodyVolume(),r=Math.random()*v+u,y=!0),y===!0&&(d.setVolume(s,t),q=b.getDuration()*(60/a),d.noteOn(s,p,r),d.noteOff(s,p,q)),"melody"==b.getType()&&(k.setPositionIndex(g),k.setPositionInPercent((Date.now()-k._startTime)/k.songDuration)),(b==l||b.getCurrentTime()*k.getBeatDuration(a)>=f)&&(k.setPositionIndex(g),k.setPositionInPercent(1),setTimeout(function(){k.setPositionIndex(0,n),k.setPositionInPercent(0),k.doLoop()===!1?($.publish("PlayerModel_MidiCSL-onfinish"),k.stop()):($.publish("PlayerModel_MidiCSL-onloopstart"),k.play(a))},1e3*q)))},b.getCurrentTime()*k.getBeatDuration(a)-e)}(o,w,z,B),w++}},e.prototype.emptyPlayNotes=function(){"undefined"!=typeof d.stopAllNotes&&d.stopAllNotes();for(var a in this.noteTimeOut)window.clearTimeout(this.noteTimeOut[a])},e.prototype.pause=function(){this.playState=!1,"undefined"!=typeof d.stopAllNotes&&d.stopAllNotes();for(var a in this.noteTimeOut)window.clearTimeout(this.noteTimeOut[a]);$.publish("PlayerModel_MidiCSL-onpause")},e.prototype.stop=function(){this.playState=!1,"undefined"!=typeof d.stopAllNotes&&d.stopAllNotes();for(var a in this.noteTimeOut)window.clearTimeout(this.noteTimeOut[a]);this.setPositionIndex(0),this.setPositionInPercent(0),$.publish("PlayerModel_MidiCSL-onstop")},e.prototype.getAllInstruments=function(){var a={0:"acoustic_grand_piano",116:"taiko_drum"};return a},e.prototype.getAllInstrumentsIndex=function(){var a=this.getAllInstruments(),b=[];for(var c in a)b.push(c);return b},e.prototype.getAllInstrumentsName=function(){var a=this.getAllInstruments(),b=[];for(var c in a)b.push(a[c]);return b},e.prototype.initMidiChannels=function(a){if("undefined"==typeof a)throw"PlayerModel_MidiCSL - initMidiChannels - instruments must be defined";var b={};if("undefined"!=typeof a)for(var c=0,e=a.length;e>c;c++)b[c]={instrument:a[c],mute:!1,mono:!1,omni:!1,solo:!1};b[9]={instrument:116,mute:!1,mono:!1,omni:!1,solo:!1},d.channels=b},e.prototype.initMidiPlugin=function(a){if("undefined"==typeof a)throw"PlayerModel_MidiCSL - initMidiPlugin - instruments must be defined";var b=this;d.loadPlugin({soundfontUrl:"/external-libs/Midijs/soundfont/",instruments:a,callback:b.MidiPluginIsReady.bind(b)})},e.prototype.MidiPluginIsReady=function(){this.setReady(!0),$.publish("PlayerModel_MidiCSL-onload")},e}),define(["modules/MidiCSL/src/model/NoteModel_MidiCSL"],function(a){function b(a){this.song="undefined"!=typeof a&&"undefined"!=typeof a.song?a.song:[]}return b.prototype.getSong=function(){return this.song},b.prototype.setSong=function(a,b){this.song="undefined"!=typeof b&&b?a:this.song.concat(a)},b.prototype.setFromType=function(a,b){if("undefined"!=typeof b){for(var c=this.song.length-1;c>=0;c--)this.song[c].getType()===b&&this.song.splice(c,1);this.song=this.song.concat(a)}},b.prototype.getFromType=function(a){var b=[];if("undefined"!=typeof a)for(var c=0,d=this.song.length;d>c;c++)this.song[c].getType()===a&&b.push(this.song[c]);return b},b.prototype.removeFromType=function(a){if("undefined"!=typeof a)for(var b=this.song.length-1;b>=0;b--)this.song[b].getType()===a&&this.song.splice(b,1)},b.prototype.getLastNote=function(){for(var a,b,c=this.song[0],d=c.getCurrentTime()+c.getDuration(),e=0,f=this.song.length;f>e;e++)a=this.song[e],a&&"metronome"!==a.getType()&&(b=a.getCurrentTime()+a.getDuration(),b>d&&(d=b,c=a));return c},b.prototype.getMidiSoundModelIndex=function(a){if("undefined"!=typeof a&&a instanceof b)for(var c=a.serialize(),d=0,e=this.song.length;e>d;d++)if(this.song[d].serialize()===c)return d;return-1},b.prototype.serialize=function(){var a={};return a.song=this.song,a},b.prototype.clone=function(){return new b(this.serialize())},b.prototype.generateMetronome=function(b){var c,d={},e=[],f=0,g=[],h=4;timeSig=4,"undefined"!=typeof b&&(timeSig=b.timeSignature.getBeats(),h=b.timeSignature.getBeatUnitQuarter());for(var i=0,j=200;j>i;i++)g=i%timeSig===0?[105]:[93],c=.5,d=new a({midiNote:g,type:"metronome",currentTime:f,duration:c}),f+=h,e.push(d);return e},b}),define(["modules/core/src/SongModel","modules/MidiCSL/src/converters/SongConverterMidi_MidiCSL","modules/MidiCSL/src/model/SongModel_midiCSL","modules/MidiCSL/src/model/NoteModel_midiCSL","tests/test-songs","modules/converters/MusicCSLJson/src/SongModel_CSLJson"],function(a,b,c,d,e,f){return{run:function(){test("SongConverterMidi_MidiCSL",function(g){var h=new c;g.deepEqual(h.getSong(),[]);var i=new a,j=(f.importFromMusicCSLJSON(e.simpleLeadSheet,i),b.exportToMidiCSL(i)),k=new c({song:j}),l=[];l.push(new d({currentTime:0,duration:4,midiNote:[69,73,76,80],type:"chord"})),l.push(new d({currentTime:4,duration:4,midiNote:[69,73,76,80],type:"chord"})),l.push(new d({currentTime:8,duration:4,midiNote:[71,75,78,81],type:"chord"})),l.push(new d({currentTime:12,duration:4,midiNote:[71,75,78,81],type:"chord"})),l.push(new d({currentTime:16,duration:4,midiNote:[64,67,71],type:"chord"})),l.push(new d({currentTime:20,duration:4,midiNote:[64,67,71],type:"chord"})),l.push(new d({currentTime:24,duration:4,midiNote:[65,69,72,75],type:"chord"})),l.push(new d({currentTime:28,duration:4,midiNote:[65,69,72,75],type:"chord"})),g.deepEqual(k.getFromType("chord"),l);var m=new d({currentTime:0,duration:1,midiNote:[69],type:"melody"});g.deepEqual(k.getFromType("melody")[0],m);var m=new d({currentTime:7,duration:1,midiNote:[64],type:"melody"});g.deepEqual(k.getFromType("melody")[8],m)})}}}),define(["modules/MidiCSL/src/model/NoteModel_MidiCSL"],function(a){return{run:function(){test("NoteModel_MidiCSL",function(b){var c=new a;b.equal(c.getCurrentTime(),0),b.equal(c.getDuration(),0),b.equal(c.getType(),void 0),b.deepEqual(c.getMidiNote(),[]),c.setCurrentTime(1.4),b["throws"](function(){c.setCurrentTime(-1)}),b.equal(c.getCurrentTime(),1.4),c.setDuration(4.2),b["throws"](function(){c.setDuration("a")}),b.equal(c.getDuration(),4.2),c.setType("melody"),b["throws"](function(){c.setType()},"type"),b.equal(c.getType(),"melody"),c.setMidiNote([30,45,64]),b["throws"](function(){c.setMidiNote()},"midi note"),b.deepEqual(c.getMidiNote(),[30,45,64]),b.deepEqual(c.getTransposeMidiNote(-4),[26,41,60],"-4"),b.deepEqual(c.getTransposeMidiNote(6),[36,51,70],"6");var d=c.clone();b.deepEqual(c,d,"Clone test")})}}}),define(["modules/core/src/SongModel","modules/MidiCSL/src/model/PlayerModel_MidiCSL","modules/MidiCSL/src/model/SongModel_MidiCSL","modules/MidiCSL/src/model/NoteModel_MidiCSL","modules/MidiCSL/src/converters/SongConverterMidi_MidiCSL","modules/converters/MusicCSLJson/src/SongModel_CSLJson","tests/test-songs","pubsub"],function(a,b,c,d,e,f,g){return{run:function(){test("PlayerModel_MidiCSL",function(d){var h=new b;d.ok(!h.getReady()),d.ok(!h.doLoop()),d["throws"](function(){h.play()});{var i=f.importFromMusicCSLJSON(g.simpleLeadSheet,new a),j=e.exportToMidiCSL(i);new c({song:j})}})}}}),define(["modules/MidiCSL/src/model/SongModel_midiCSL","modules/MidiCSL/src/model/NoteModel_midiCSL"],function(a,b){return{run:function(){test("SongModel_midiCSL",function(c){var d=new a;c.deepEqual(d.getSong(),[]);var e=new b({currentTime:0,duration:1,midiNote:[45],type:"melody"}),f=new b({currentTime:1,duration:1,midiNote:[60],type:"melody"}),g=new b({currentTime:0,duration:1,midiNote:[60,65,67],type:"chords"}),d=new a({song:[e,f,g]}),h=new a;h.setSong([e,f,g]),c.deepEqual(d.getSong(),h.getSong(),"Set and getSong"),c.deepEqual(d.getFromType("chords"),[g],"get from type chords"),c.deepEqual(d.getFromType("melody"),[e,f],"get from type melody"),c.deepEqual(d.getLastNote(),f,"get last note"),d.removeFromType("melody"),c.deepEqual(d.getSong(),[g],"Remove melody"),d.setSong(e),c.deepEqual(d.getSong(),[g,e],"Set without replace"),d.setSong(e,!0),c.deepEqual(d.getSong(),e,"Set with replace");var i=d.clone();c.deepEqual(d,i,"Clone test")})}}}),define([],function(){var a={};return a.convertNotesToMidi=function(b){var c=[];if("undefined"!=typeof b)for(var d,e=0,f=b.length;f>e;e++)d=b[e],d=a.convertSharp2Flat(d),d=a.detectImpossibleFlat(d),d=a.convertDoubleAccidental(d),c[e]=a.keyToNote[d];return c},a.convertDoubleAccidental=function(a){return"undefined"!=typeof a?("#"===a[1]&&"#"===a[2]?a="G"===a[0]?"A"+a.substring(3):"B"===a[0]?"C"+(parseInt(a[3])+1):String.fromCharCode(a.charCodeAt(0)+1)+a.substring(3):"b"===a[1]&&"b"===a[2]&&(a="A"===a[0]?"G"+a.substring(3):"C"===a[0]?"B"+(parseInt(a[3])-1):String.fromCharCode(a.charCodeAt(0)-1)+a.substring(3)),a):void 0},a.convertSharp2Flat=function(a){return"undefined"!=typeof a?("#"===a[1]&&(a="G"===a[0]?"Ab"+a.substring(2):"B"===a[0]?"C"+(parseInt(a[2])+1):"E"===a[0]?"F"+a.substring(2):String.fromCharCode(a.charCodeAt(0)+1)+"b"+a.substring(2)),a):void 0},a.detectImpossibleFlat=function(a){return"undefined"!=typeof a?("b"===a[1]&&("C"===a[0]?a="B"+(parseInt(a[2])-1):"F"===a[0]&&(a="E"+a.substring(2))),a):void 0},a.transposeMidiNotes=function(a,b){if("undefined"!=typeof a&&!isNaN(b)){for(var c=0,d=a.length;d>c;c++)a[c]+=b;return a}return void 0},a.keyToNote={},a.noteToKey={},function(){for(var b=21,c=108,d=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],e=b;c>=e;e++){var f=(e-12)/12>>0,g=d[e%12]+f;a.keyToNote[g]=e,a.noteToKey[e]=g}}(),a}),define([],function(){function a(){this.modules=[]}return a.prototype.getModuleLength=function(){return this.modules.length},a.prototype.getModule=function(a){if(isNaN(a)||"undefined"==typeof this.modules[a])throw"ModuleManager - getModule - index is undefined or is not a number or doesnt exist";return this.modules[a]},a.prototype.addModule=function(a){if("undefined"==typeof a||"undefined"==a.title)throw"ModuleManager - addModule - module is undefined";this.hasModule(a.title)===!1?this.modules.push(a):console.warn("ModuleManager - addModule - module "+a+" already exist")},a.prototype.hasModule=function(a){if(""==typeof a)throw"ModuleManager - hasModule - moduleTitle can't be equal to an empty string";for(var b=0,c=this.modules.length;c>b;b++)if(this.modules[b].title===a)return!0;return!1},a.prototype.searchModuleIndex=function(a){if(""==typeof a)throw"ModuleManager - searchModuleIndex - moduleTitle can't be equal to an empty string";for(var b=0,c=this.modules.length;c>b;b++)if(this.modules[b].title===a)return b;return-1},a.prototype.removeModule=function(a){var b=this.searchModuleIndex(a);return-1!==b?(this.modules.splice(b,1),!0):!1},a}),define(["modules/ModuleManager/src/ModuleManager"],function(a){return{run:function(){test("ModuleManager",function(b){var c=new a;b.ok(c instanceof a),b.ok(c.hasModule("menu1")===!1),b.equal(c.getModuleLength(),0),c.addModule({title:"menu1"}),b.equal(c.getModuleLength(),1),b.ok(c.hasModule("menu1")===!0);var d=new a;d.addModule({title:"menu1"}),d.addModule({title:"menu2"}),d.addModule({title:"menu3"}),b.equal(d.getModuleLength(),3),b.ok(d.removeModule("menu2")),b.equal(d.getModuleLength(),2)})}}}),define(["mustache","modules/core/src/SongModel","modules/core/src/NoteManager","modules/Cursor/src/CursorModel","utils/NoteUtils","utils/UserLog","pubsub"],function(a,b,c,d,e,f){function g(a,c){this.songModel=a||new b,this.cursor=c||new d,this.initSubscribe()}return g.prototype.initSubscribe=function(){var a=this;$.subscribe("NoteEditionView-setPitch",function(b,c){a.setPitch(c)}),$.subscribe("NoteEditionView-addAccidental",function(b,c){var d="";d=c.hasOwnProperty("acc")?c.acc:c;var e=!1;c.hasOwnProperty("double")&&(e=c["double"]),a.addAccidental(d,e)}),$.subscribe("NoteEditionView-setCurrDuration",function(b,c){a.setCurrDuration(c)}),$.subscribe("NoteEditionView-setDot",function(){a.setDot()}),$.subscribe("NoteEditionView-setTie",function(){a.setTie()}),$.subscribe("NoteEditionView-setTuplet",function(){a.setTuplet()}),$.subscribe("NoteEditionView-setSilence",function(){a.setSilence()}),$.subscribe("NoteEditionView-deleteNote",function(){a.deleteNote()}),$.subscribe("NoteEditionView-addNote",function(){a.addNote()}),$.subscribe("NoteEditionView-copyNotes",function(){a.copyNotes()}),$.subscribe("NoteEditionView-pasteNotes",function(){a.pasteNotes()}),$.subscribe("NoteEditionView-activeView",function(){a.changeEditMode(!0),$.publish("ToViewer-draw",a.songModel)}),$.subscribe("NoteEditionView-unactiveView",function(){a.changeEditMode(!1)}),$.subscribe("CursorView-moveCursorByElementnotes",function(b,c){a.moveCursorByBar(c)})},g.prototype.setPitch=function(a){for(var b,c=this.getSelectedNotes(),d=0,f=c.length;f>d;d++){b=c[d],b.isRest&&b.setRest(!1);var g;-1!==e.getValidPitch(a)?(g=e.getClosestKey(b.getPitch(),a),b.setNoteFromString(g)):(g=e.getKey(b.getPitch(),a),b.setNoteFromString(g))
}$.publish("ToViewer-draw",this.songModel)},g.prototype.addAccidental=function(a,b){var c,d=this.getSelectedNotes();"undefined"!=typeof b&&b===!0&&"n"!==a&&(a+=a);for(var e=0;e<d.length;e++)c=d[e],c.isRest||(c.getAccidental()==a?c.removeAccidental():c.setAccidental(a));$.publish("ToViewer-draw",this.songModel)},g.prototype.setCurrDuration=function(a){var b={1:"64",2:"32",3:"16",4:"8",5:"q",6:"h",7:"w",8:"w"},c=this.getSelectedNotes(),d=b[a];if("undefined"==typeof d)throw"NoteEditionController - setCurrDuration not accepted duration "+a;for(var e=0,f=0,g=0;g<c.length;g++)e+=c[g].getDuration(),c[g].setDuration(d),f+=c[g].getDuration();this.checkDuration(e,f),$.publish("ToViewer-draw",this.songModel)},g.prototype.setDot=function(){for(var a=this.getSelectedNotes(),b=0,c=0,d=0,e=0,f=a.length;f>e;e++)c+=a[e].getDuration(),b=a[e].getDot(),b>=2?b=0:b++,a[e].setDot(b),d+=a[e].getDuration();this.checkDuration(c,d),$.publish("ToViewer-draw",this.songModel)},g.prototype.setTie=function(){var a,b=this.getSelectedNotes();if(2==b.length)for(var c=0;c<b.length;c++)a=b[c],0===c?a.isTie("start")?a.removeTie("start"):a.setTie("start"):a.isTie("stop")?a.removeTie("stop"):a.setTie("stop");$.publish("ToViewer-draw",this.songModel)},g.prototype.setTuplet=function(){function a(a){for(var b=0,c=0;c<a.length;c++)b+=a[c].getDuration();return b}function b(a){initDur=4;for(var b=0;6>b;b++){if(initDur==a)return!0;initDur/=2}return!1}function c(a,b){var c,d=a[0],e=1==a.length?d.getDuration()/2:d.getDuration();h=[];for(var f=0;3>f;f++)c=d.clone(),c.setDuration(e),0===f?c.setTuplet("start",b):1===f?c.setTuplet("middle",b):c.setTuplet("stop",b),h.push(c);return h}var d,e=this.getSelectedNotes(),f="3/2";if(e.length>3)return{error:"You must select 3 notes or less"};for(var g=0;g<e.length-1;g++)if(e[g].getDuration()!=e[g+1].getDuration())return{error:"Notes have not same duration"};if(e.length<3&&!b(a(e)))return{error:"You must choose to make a tuplet over simple durations"};if(1==e.length||2==e.length){var h=c(e,f);this.pasteNotes(h)}else if(3==e.length)for(var g=0;g<e.length;g++)d=e[g],d.isTuplet()?d.removeTuplet():0===g?d.setTuplet("start",f):g==e.length-1?d.setTuplet("stop",f):d.setTuplet("middle",f);$.publish("ToViewer-draw",this.songModel)},g.prototype.setSilence=function(){for(var a,b=this.getSelectedNotes(),c=0;c<b.length;c++)a=b[c],"stop"!==a.tie&&"start"!==a.tie?a.isRest||a.setRest(!0):(console.warn("Can't convert to silence a tied note"),f.logAutoFade("warn","Can't convert to silence a tied note"));$.publish("ToViewer-draw",this.songModel)},g.prototype.deleteNote=function(){for(var a=this.songModel.getComponent("notes"),b=this.cursor.getPos(),c=0,d=b[0],e=b[1];e>=d;d++)c+=a.getNote(d).getDuration(),a.deleteNote(d);this.checkDuration(c,0);var f=a.getTotal();this.cursor.revisePos(f),$.publish("ToViewer-draw",this.songModel)},g.prototype.addNote=function(){var a=this.songModel.getComponent("notes"),b=this.cursor.getEnd(),c=a.getNotes(b,b+1)[0],d=c.clone(!1);a.insertNote(b,d),this.checkDuration(0,c.getDuration()),$.publish("ToViewer-draw",this.songModel)},g.prototype.copyNotes=function(){var a=this.songModel.getComponent("notes");this.buffer=a.cloneElems(this.cursor.getStart(),this.cursor.getEnd()+1),$.publish("ToViewer-draw",this.songModel)},g.prototype.pasteNotes=function(a){a=a||this.buffer;var b=new c;b.setNotes(a),b.reviseNotes(),a=b.getNotes();var d=this.songModel.getComponent("notes");d.notesSplice(this.cursor.getPos(),a),$.publish("ToViewer-draw",this.songModel)},g.prototype.moveCursorByBar=function(a){if(this.cursor.getEditable()!==!1){var b=this.songModel.getComponent("notes"),c=b.getNoteBarNumber(this.cursor.getPos()[0],this.songModel);if(0===c&&-1===a)return this.cursor.setPos(0),void $.publish("ToViewer-draw",this.songModel);var d=this.songModel.getStartBeatFromBarNumber(c+a),e=b.getNextIndexNoteByBeat(d);this.cursor.setPos(e),$.publish("ToViewer-draw",this.songModel)}},g.prototype.getSelectedNotes=function(){var a=this.songModel.getComponent("notes"),b=a.getNotes(this.cursor.getStart(),this.cursor.getEnd()+1);return b},g.prototype.checkDuration=function(a,b){function c(a,b,c){function d(a){return a=16*a,Math.round(a)!=a}var e=c.getNextIndexNoteByBeat(a),f=c.getNextIndexNoteByBeat(b);return d(c.getNoteBeat(e))||d(c.getNoteBeat(f))}var d=this.songModel.getComponent("notes"),e=d.getNoteBeat(this.cursor.getStart()),g=e+b;if(a>b)d.fillGapWithRests(a-b,e);else if(b>a){if(c(e,g,d))return void f.logAutoFade("error","Can't break tuplet");var h=d.getNextIndexNoteByBeat(g),i=d.getNoteBeat(h);i>g&&d.fillGapWithRests(i-g,e),this.cursor.setPos([this.cursor.getStart(),h-1])}d.reviseNotes()},g.prototype.changeEditMode=function(a){this.cursor.setEditable(a)},g}),define(["mustache","modules/core/src/SongModel","utils/UserLog","utils/NoteUtils","pubsub"],function(a,b,c,d){function e(){this.el=void 0,this.initSubscribe(),this.initKeyboard()}return e.prototype.render=function(a,b,c){b=b||!1;var d=this;return"undefined"==typeof this.el||"undefined"!=typeof this.el&&b===!0?void this.initView(a,function(){d.initController(),$.publish("NoteEditionView-render"),"function"==typeof c&&c()}):void("function"==typeof c&&c())},e.prototype.initView=function(b,c){var d=this;$.get("/modules/NoteEdition/src/NoteEditionTemplate.html",function(e){var f=a.render(e);"undefined"!=typeof b&&(b.innerHTML=f),d.el=f,"function"==typeof c&&c()})},e.prototype.initController=function(){$("#aug-note").click(function(){$.publish("NoteEditionView-setPitch",1)}),$("#sub-note").click(function(){$.publish("NoteEditionView-setPitch",-1)}),$("#double_flat").click(function(){$.publish("NoteEditionView-addAccidental",{acc:"b","double":!0})}),$("#flat").click(function(){$.publish("NoteEditionView-addAccidental","b")}),$("#natural").click(function(){$.publish("NoteEditionView-addAccidental","n")}),$("#sharp").click(function(){$.publish("NoteEditionView-addAccidental","#")}),$("#double_sharp").click(function(){$.publish("NoteEditionView-addAccidental",{acc:"#","double":!0})}),$("#whole-note").click(function(){$.publish("NoteEditionView-setCurrDuration",7)}),$("#half-note").click(function(){$.publish("NoteEditionView-setCurrDuration",6)}),$("#quarter-note").click(function(){$.publish("NoteEditionView-setCurrDuration",5)}),$("#eight-note").click(function(){$.publish("NoteEditionView-setCurrDuration",4)}),$("#sixteenth-note").click(function(){$.publish("NoteEditionView-setCurrDuration",3)}),$("#thirty-second-note").click(function(){$.publish("NoteEditionView-setCurrDuration",2)}),$("#sixty-four-note").click(function(){$.publish("NoteEditionView-setCurrDuration",1)}),$("#dot").click(function(){$.publish("NoteEditionView-setDot")}),$("#tie-note").click(function(){$.publish("NoteEditionView-setTie")}),$("#tuplet").click(function(){$.publish("NoteEditionView-setTuplet",!0)}),$("#silent-note").click(function(){$.publish("NoteEditionView-setSilence")}),$("#regular-note").click(function(){$.publish("NoteEditionView-setPitch",0)}),$("#delete-note").click(function(){$.publish("NoteEditionView-setSilence")}),$("#add-note").click(function(){$.publish("NoteEditionView-addNote")}),$("#copy-note").click(function(){$.publish("NoteEditionView-copyNotes")}),$("#paste-note").click(function(){$.publish("NoteEditionView-pasteNotes")})},e.prototype.initKeyboard=function(){function a(a){return a.preventDefault(),a.stopPropagation(),!1}var b=this,c={s:"#",v:"b",n:"n"};$(document).keydown(function(e){if(b.editing!==!1){var f=null===e?event.keyCode:e.keyCode,g=String.fromCharCode(f).toLowerCase(),h=!!e.metaKey,i=e.srcElement||e.target;if(8===f){var j=!1;j="TEXTAREA"===i.tagName.toUpperCase()||"INPUT"===i.tagName.toUpperCase()&&("TEXT"===i.type.toUpperCase()||"PASSWORD"===i.type.toUpperCase()||"FILE"===i.type.toUpperCase())?i.readOnly||i.disabled:!0,j&&a(e)}if(doListenToEvent=!0,("TEXTAREA"===i.tagName.toUpperCase()||"INPUT"===i.tagName.toUpperCase()&&("TEXT"===i.type.toUpperCase()||"PASSWORD"===i.type.toUpperCase()||"FILE"===i.type.toUpperCase()))&&(doListenToEvent=!1),doListenToEvent)if(38==f||40==f){var k=38==f?1:-1;$.publish("NoteEditionView-setPitch",k),a(e)}else if(-1==d.getValidPitch(g)||e.ctrlKey)if(c.hasOwnProperty(g)&&!e.ctrlKey){var l=c[g];$.publish("NoteEditionView-addAccidental",{acc:l,"double":e.shiftKey}),a(e)}else parseInt(g,null)>=1&&parseInt(g,null)<=9?($.publish("NoteEditionView-setCurrDuration",g),a(e)):190==f?($.publish("NoteEditionView-setDot",e.shiftKey),a(e)):84==f?($.publish(e.shiftKey?"NoteEditionView-setTuplet":"NoteEditionView-setTie"),a(e)):82==f?($.publish("NoteEditionView-setSilence"),a(e)):46==f?($.publish("NoteEditionView-setSilence"),a(e)):13==f?($.publish("NoteEditionView-addNote"),a(e)):67==f&&e.ctrlKey||67==f&&h?($.publish("NoteEditionView-copyNotes"),a(e)):(86==f&&e.ctrlKey||86==f&&h)&&($.publish("NoteEditionView-pasteNotes"),a(e));else $.publish("NoteEditionView-setPitch",g.toUpperCase()),a(e)}})},e.prototype.initSubscribe=function(){},e.prototype.isEditMode=function(a){return this.editMode===a?!0:!1},e.prototype.unactiveView=function(){this.editMode="",$.publish("NoteEditionView-unactiveView")},e.prototype.activeView=function(){this.editMode="notes",$.publish("NoteEditionView-activeView","notes")},e}),define(["modules/core/src/SongModel","modules/core/src/NoteModel","modules/NoteEdition/src/NoteSpaceView","modules/Cursor/src/CursorModel","utils/UserLog","pubsub"],function(a,b,d,e){function f(b,c){this.songModel=b||new a,this.cursor=c||new e,this.noteSpace=[],this.initSubscribe(),this.CURSORHEIGHT=80,this.CURSORMARGINTOP=20,this.CURSORMARGINLEFT=6,this.CURSORMARGINRIGHT=9}return f.prototype.initSubscribe=function(){var a=this;$.subscribe("LSViewer-click",function(b,c){var d=a.isInPath(c.x,c.y);d!==!1&&($.publish("ToAllCursor-setEditable",!1),a.cursor.setEditable(!0),a.cursor.setPos(d),$.publish("ToViewer-draw",a.songModel))}),$.subscribe("LSViewer-mousemove",function(b,c){var d=a.isInPath(c.x,c.y);myApp.viewer.el.style.cursor=d!==!1?"pointer":"default"}),$.subscribe("LSViewer-drawEnd",function(b,c){a.cursor.getEditable()&&a.refresh(c)})},f.prototype.updateNote=function(a,c,d){"undefined"==typeof c&&"undefined"!=typeof d&&(c=new b({beat:d.beatNumber,barNumber:d.barNumber}),this.songModel.getComponent("notes").addnote(c)),c.setnoteFromString(a)},f.prototype.refresh=function(a){this.noteSpace=this.createNoteSpace(a),this.draw(a)},f.prototype.isInPath=function(a,b){for(var c=0,d=this.noteSpace.length;d>c;c++)if("undefined"!=typeof this.noteSpace[c]&&this.noteSpace[c].isInPath(a,b))return c;return!1},f.prototype.createNoteSpace=function(a){var b=[];if("undefined"!=typeof a.vxfBars){for(var c,e=(a.SCALE,0),f=a.vxfNotes.length;f>e;e++)currentNote=a.vxfNotes[e],currentNoteStaveY=currentNote.stave.y,boundingBox=currentNote.getBoundingBox(),c={x:boundingBox.x-this.CURSORMARGINLEFT,y:currentNoteStaveY+this.CURSORMARGINTOP,xe:boundingBox.w+this.CURSORMARGINLEFT+this.CURSORMARGINRIGHT,ye:this.CURSORHEIGHT},b.push(new d(c));return b}},f.prototype.getNotesAreasFromCursor=function(a,b){var c=[],d=b[0],e=b[1];if("undefined"==typeof a.vxfNotes[d])return c;var f,g,h,i,j,k,l;for(k=a.vxfNotes[d];e>=d;)h=a.vxfNotes[d],i=h.stave.y,"undefined"!=typeof a.vxfNotes[d+1]&&(j=a.vxfNotes[d+1].stave.y),(i!=j||d==e)&&(l=h.getBoundingBox(),f=k.getBoundingBox().x-this.CURSORMARGINLEFT,g=l.x-f+l.w+this.CURSORMARGINRIGHT,c.push({x:f,y:i+this.CURSORMARGINTOP,xe:g,ye:this.CURSORHEIGHT}),d!=e&&(k=a.vxfNotes[d+1])),d++;return c},f.prototype.draw=function(a){var b=this.cursor.getPos(),d=a.ctx.fillStyle;a.ctx.fillStyle="#0099FF",a.ctx.globalAlpha=.2;var e=[];for(b[0]===b[1]?e.push({x:this.noteSpace[b[0]].position.x,y:this.noteSpace[b[0]].position.y,xe:this.noteSpace[b[0]].position.xe,ye:this.noteSpace[b[0]].position.ye}):e=this.getNotesAreasFromCursor(a,b),i=0,c=e.length;i<c;i++)a.ctx.fillRect(e[i].x,e[i].y,e[i].xe,e[i].ye);a.ctx.fillStyle=d,a.ctx.globalAlpha=1},f}),define([],function(){function a(a){this.position=a}return a.prototype.isInPath=function(a,b){return"undefined"!=typeof a&&!isNaN(a)&&"undefined"!=typeof b&&!isNaN(b)&&this.position.x<=a&&a<=this.position.x+this.position.xe&&this.position.y<=b&&b<=this.position.y+this.position.ye?!0:!1},a}),define(["modules/core/src/NoteModel","modules/NoteEdition/src/NoteEditionController","modules/converters/MusicCSLJson/src/SongModel_CSLJson","modules/Cursor/src/CursorModel","tests/test-songs"],function(a,b,c,d,e){return{run:function(){test("Notes Edition Controller",function(a){var f=c.importFromMusicCSLJSON(e.simpleLeadSheet),g=new d(f.getComponent("notes")),h=new b(f,g);a.equal(h.getSelectedNotes().toString(),"A/4-q"),h.setPitch(1),a.equal(h.getSelectedNotes().toString(),"B/4-q"),h.setPitch("C"),a.equal(h.getSelectedNotes().toString(),"C/5-q"),h.setPitch("Db"),a.equal(h.getSelectedNotes().toString(),"C/5-q"),h.addAccidental("b"),a.equal(h.getSelectedNotes().toString(),"Cb/5-q","accidental flat"),h.addAccidental("bb"),a.equal(h.getSelectedNotes().toString(),"Cbb/5-q"),h.addAccidental("#"),a.equal(h.getSelectedNotes().toString(),"C#/5-q"),h.addAccidental("##"),a.equal(h.getSelectedNotes().toString(),"C##/5-q"),h.addAccidental("n"),a.equal(h.getSelectedNotes().toString(),"Cn/5-q"),h.addAccidental("n"),a.equal(h.getSelectedNotes().toString(),"C/5-q","remove accidental"),h.setCurrDuration("1"),a.equal(h.getSelectedNotes()[0].getDuration(),.0625,"durations 1"),h.setCurrDuration("2"),a.equal(h.getSelectedNotes()[0].getDuration(),.125,"durations 2"),h.setCurrDuration("3"),a.equal(h.getSelectedNotes()[0].getDuration(),.25,"durations 3"),h.setCurrDuration("4"),a.equal(h.getSelectedNotes()[0].getDuration(),.5,"durations 4"),h.setCurrDuration("5"),a.equal(h.getSelectedNotes()[0].getDuration(),1,"durations 5"),h.setCurrDuration("6"),a.equal(h.getSelectedNotes()[0].getDuration(),2,"durations 6"),h.setCurrDuration("7"),a.equal(h.getSelectedNotes()[0].getDuration(),4,"durations 7"),h.setCurrDuration("8"),a.equal(h.getSelectedNotes()[0].getDuration(),4,"durations 8"),a["throws"](function(){h.setCurrDuration("9")}),h.setDot(),a.equal(h.getSelectedNotes()[0].getDuration(),6,"dot"),h.setSilence(),a.ok(h.getSelectedNotes()[0].isRest,"rest");var i=h.getSelectedNotes().toString();h.addNote(),a.equal(h.getSelectedNotes().toString(),i,"add note"),h.deleteNote(),a.equal(h.getSelectedNotes().toString(),i,"delete note"),h.setTie(),a.equal(h.getSelectedNotes()[0].isTie(),!1,"tie note with only one selected"),h.cursor.setPos([0,1]),h.setTie(),a.equal(h.getSelectedNotes()[0].isTie(),!0,"tie note"),a.equal(h.getSelectedNotes()[0].isTie("start"),!0,"tie note begin type"),a.equal(h.getSelectedNotes()[0].isTie("start_stop"),!1,"tie note type"),a.equal(h.getSelectedNotes()[0].isTie("stop"),!1,"tie note type"),a.equal(h.getSelectedNotes()[1].isTie("stop"),!0,"tie note end type"),h.setTie(),a.equal(h.getSelectedNotes()[0].isTie(),!1,"remove tie begin note"),a.equal(h.getSelectedNotes()[1].isTie(),!1,"remove tie end note"),h.setTuplet(),a.equal(h.getSelectedNotes()[0].isTuplet(),!1,"tuplet with not 3 notes same length selected"),a.equal(h.getSelectedNotes()[0].getTuplet(),void 0,"type tuplet with not 3 notes same length selected"),h.cursor.setPos([3,5]),h.setTuplet(),a.equal(h.getSelectedNotes()[0].isTuplet(),!0,"tuplet with 3 notes selected - first"),a.equal(h.getSelectedNotes()[1].isTuplet(),!0,"tuplet with 3 notes selected - second"),a.equal(h.getSelectedNotes()[2].isTuplet(),!0,"tuplet with 3 notes selected - third"),a.equal(h.getSelectedNotes()[0].getTuplet(),"start","type tuplet with 3 notes selected - start"),a.equal(h.getSelectedNotes()[1].getTuplet(),"middle","type tuplet with 3 notes selected - middle"),a.equal(h.getSelectedNotes()[2].getTuplet(),"stop","type tuplet with 3 notes selected - stop");var j=h.getSelectedNotes().toString();h.copyNotes(),a.equal(h.buffer.toString(),j,"copy Notes"),h.cursor.setPos(5),h.pasteNotes(),h.cursor.setPos([5,7]),a.equal(h.getSelectedNotes().toString(),j,"copy Notes"),a.equal(h.moveCursorByBar(-1),void 0),h.moveCursorByBar(1),a.equal(h.getSelectedNotes().toString(),"G/4-8"),h.moveCursorByBar(-1),a.equal(h.getSelectedNotes().toString(),"wr")})}}}),define(["mustache","modules/Cursor/src/CursorModel","modules/core/src/SongModel","modules/core/src/SectionModel","modules/core/src/NoteManager","modules/core/src/NoteModel","utils/UserLog","pubsub"],function(a,b,c,d,e,f,g){function h(a,d,e,f){this.songModel=a||new c,this.cursor=d||new b,this.initSubscribe(),this.structEditionModel=f}return h.prototype.initSubscribe=function(){var a=this;$.subscribe("StructureEditionView-addSection",function(){a.addSection()}),$.subscribe("StructureEditionView-removeSection",function(){a.removeSection()}),$.subscribe("StructureEditionView-sectionName",function(b,c){a.setSectionName(c)}),$.subscribe("StructureEditionView-repeatTimes",function(b,c){a.setRepeatTimes(c)}),$.subscribe("StructureEditionView-addBar",function(){a.addBar()}),$.subscribe("StructureEditionView-removeBar",function(){a.removeBar()}),$.subscribe("StructureEditionView-timeSignature",function(b,c){a.timeSignature(c)}),$.subscribe("StructureEditionView-tonality",function(b,c){a.tonality(c)}),$.subscribe("StructureEditionView-ending",function(b,c){a.ending(c)}),$.subscribe("StructureEditionView-style",function(b,c){a.style(c)}),$.subscribe("StructureEditionView-label",function(b,c){a.label(c)}),$.subscribe("StructureEditionView-sublabel",function(b,c){a.subLabel(c)}),$.subscribe("StructureEditionView-activeView",function(){a.changeEditMode(!0),$.publish("ToViewer-draw",a.songModel)}),$.subscribe("StructureEditionView-unactiveView",function(){a.changeEditMode(!1)}),$.subscribe("StructureEditionView-unfold",function(){a.unfold()})},h.prototype.addSection=function(){for(var a=2,b=this.songModel.getComponent("bars"),c=b.getTotal()-1,e=b.getBar(c).clone(),f=this.songModel.getComponent("notes"),g=f.getTotal()-1,h=f.getNoteBeat(g),i=this.songModel.getTimeSignatureAt(c).getQuarterBeats(),j=0;a>j;j++)b.addBar(e),f.fillGapWithRests(i,h),h+=i;var k=new d({numberOfBars:a});this.songModel.addSection(k),$.publish("ToViewer-draw",this.songModel)},h.prototype.removeSection=function(){if(1===this.songModel.getSections().length)return void g.logAutoFade("error","You can't delete last section");var a=this._getSelectedBars();if(0!==a.length){for(var b=this.songModel.getSectionNumberFromBarNumber(a[0]),c=this.songModel.getStartBarNumberFromSectionNumber(b),d=this.songModel.getSection(b).getNumberOfBars(),e=this.songModel.getComponent("bars"),f=this.songModel.getComponent("notes"),h=0;d>h;h++)e.removeBar(c);var i=f.getTotal()-1;this.cursor.getEnd()>i&&this.cursor.setPos(i),this.songModel.removeSection(b),$.publish("ToViewer-draw",this.songModel)}},h.prototype.setSectionName=function(a){if("undefined"!=typeof a){var b=this._getSelectedBars();if(0!==b.length){var c=this.songModel.getSectionNumberFromBarNumber(b[0]);this.songModel.getSection(c).setName(a),$.publish("ToViewer-draw",this.songModel)}}},h.prototype.setRepeatTimes=function(a){if("undefined"!=typeof a){var b=this._getSelectedBars();if(0!==b.length){var c=this.songModel.getSectionNumberFromBarNumber(b[0]);this.songModel.getSection(c).setRepeatTimes(a),$.publish("ToViewer-draw",this.songModel)}}},h.prototype.addBar=function(){var a=this._getSelectedBars(),b=0;0!==a.length&&(b=a[0]);var c=this.songModel.getComponent("notes"),d=this.songModel.getTimeSignatureAt(b).getQuarterBeats(),g=new e,h=0;0===b&&(g.addNote(new f("E/4-q")),d-=1,h=1),g.fillGapWithRests(d,h);var i=this.songModel.getStartBeatFromBarNumber(b),j=c.getNextIndexNoteByBeat(i);c.notesSplice([j,j-1],g.getNotes());var k=this.songModel.getComponent("bars"),l=k.getBar(b).clone();k.addBar(l);var m=this.songModel.getSection(this.songModel.getSectionNumberFromBarNumber(b));m.setNumberOfBars(m.getNumberOfBars()+1),this.songModel.getComponent("chords").incrementChordsBarNumberFromBarNumber(1,b),$.publish("ToViewer-draw",this.songModel)},h.prototype.removeBar=function(){var a=this._getSelectedBars();if(0!==a.length){for(var b,c,d,e,f,h,i,j=this.songModel.getComponent("bars"),k=this.songModel.getComponent("notes"),l=this.songModel.getComponent("chords"),m=a.length-1;m>0;m--)b=this.songModel.getSectionNumberFromBarNumber(a[m]),i=this.songModel.getSection(b),c=i.getNumberOfBars(),1===c?1===this.songModel.getSections().length?g.logAutoFade("warn","Can't delete the last bar of the last section."):this.removeSection(b):(i.setNumberOfBars(c-1),d=this.songModel.getTimeSignatureAt(a[m]).getQuarterBeats()-1,e=this.songModel.getStartBeatFromBarNumber(a[m]),f=k.getNextIndexNoteByBeat(e),h=k.getNextIndexNoteByBeat(e+d),k.notesSplice([f,h],[]),l.removeChordsByBarNumber(a[m]),l.incrementChordsBarNumberFromBarNumber(-1,a[m]),j.removeBar(a[m]));this.cursor.setPos(f-1),$.publish("ToViewer-draw",this.songModel)}},h.prototype.timeSignature=function(a){var b=this._getSelectedBars();if(0!==b.length){for(var c=this.songModel.getSongTotalBeats(),d=0,e=b.length;e>d;d++)"none"===a&&(a=void 0),this.songModel.getComponent("bars").getBar(b[d]).setTimeSignature(a);var f=this.songModel.getSongTotalBeats();this._checkDuration(c,f),$.publish("ToViewer-draw",this.songModel)}},h.prototype._checkDuration=function(a,b){function c(a,b,c){function d(a){return a=16*a,Math.round(a)!=a}var e=c.getNextIndexNoteByBeat(a),f=c.getNextIndexNoteByBeat(b);return d(c.getNoteBeat(e))||d(c.getNoteBeat(f))}var d=this.songModel.getComponent("notes"),e=1,f=b+1;if(b>a)d.fillGapWithRests(b-a,e);else if(a>b){if(c(e,b,d))return void g.logAutoFade("error","Can't break tuplet");var h=d.getNextIndexNoteByBeat(f),i=d.getNoteBeat(h);i>f&&d.fillGapWithRests(i-f,e)}d.reviseNotes()},h.prototype.tonality=function(a){var b=this._getSelectedBars();if(0!==b.length){for(var c=0,d=b.length;d>c;c++)this.songModel.getComponent("bars").getBar(b[c]).setTonality(a);$.publish("ToViewer-draw",this.songModel)}},h.prototype.ending=function(a){var b=this._getSelectedBars();if(0!==b.length){for(var c=0,d=b.length;d>c;c++)"none"===a&&(a=void 0),this.songModel.getComponent("bars").getBar(b[c]).setEnding(a);$.publish("ToViewer-draw",this.songModel)}},h.prototype.style=function(a){var b=this._getSelectedBars();if(0!==b.length){for(var c=0,d=b.length;d>c;c++)"none"===a&&(a=void 0),this.songModel.getComponent("bars").getBar(b[c]).setStyle(a);$.publish("ToViewer-draw",this.songModel)}},h.prototype.label=function(a){var b=this._getSelectedBars();if(0!==b.length){for(var c=0,d=b.length;d>c;c++)"none"===a&&(a=""),this.songModel.getComponent("bars").getBar(b[c]).setLabel(a);$.publish("ToViewer-draw",this.songModel)}},h.prototype.subLabel=function(a){var b=this._getSelectedBars();if(0!==b.length){for(var c=0,d=b.length;d>c;c++)"none"===a&&(a=void 0),this.songModel.getComponent("bars").getBar(b[c]).setSublabel(a);$.publish("ToViewer-draw",this.songModel)}},h.prototype._getSelectedBars=function(){var a=[];return a[0]=this.songModel.getComponent("notes").getNoteBarNumber(this.cursor.getStart(),this.songModel),a[1]=this.songModel.getComponent("notes").getNoteBarNumber(this.cursor.getEnd(),this.songModel),a},h.prototype.changeEditMode=function(a){this.cursor.setEditable(a)},h.prototype.unfold=function(){if(this.structEditionModel.unfolded)$.publish("ToViewer-draw",this.oldSong);else{this.oldSong=this.songModel;var a=this.songModel.unfold();$.publish("ToViewer-draw",a)}this.structEditionModel.toggleUnfolded()},h}),define(["pubsub"],function(){function a(){this.unfolded=!1}return a.prototype.toggleUnfolded=function(){this.unfolded=!this.unfolded,$.publish("StructureEditionModel-toggleUnfolded",this.unfolded)},a}),define(["mustache","modules/core/src/SongModel","utils/UserLog","pubsub"],function(a){function b(){this.el=void 0,this.initSubscribe(),this.initKeyboard()}return b.prototype.render=function(a,b,c){b=b||!1;var d=this;return"undefined"==typeof this.el||"undefined"!=typeof this.el&&b===!0?void this.initView(a,function(){d.initController(),$.publish("StructureEditionView-render"),"function"==typeof c&&c()}):void("function"==typeof c&&c())},b.prototype.initView=function(b,c){var d=this;$.get("/modules/StructureEdition/src/StructureEditionTemplate.html",function(e){var f=a.render(e);"undefined"!=typeof b&&(b.innerHTML=f),d.el=f,"function"==typeof c&&c()})},b.prototype.initController=function(){$("#add-section").click(function(){$.publish("StructureEditionView-addSection")}),$("#rem-section").click(function(){$.publish("StructureEditionView-removeSection")}),$("#validateSectionTitle").click(function(){var a=$("#inputSectionName").val();$.publish("StructureEditionView-sectionName",a)}),$("#selectSectionRepeatTimes").change(function(){var a=parseInt($(this).val(),10)-1;$.publish("StructureEditionView-repeatTimes",a)}),$("#add-bar").click(function(){$.publish("StructureEditionView-addBar")}),$("#rem-bar").click(function(){$.publish("StructureEditionView-removeBar")}),$("#edit_each_time_signature_container select").change(function(){var a=$(this).val();$.publish("StructureEditionView-timeSignature",a)}),$("#edit_each_tonality_container select").change(function(){var a=$(this).val();$.publish("StructureEditionView-tonality",a)}),$("#edit_each_ending_container select").change(function(){var a=$(this).val();$.publish("StructureEditionView-ending",a)}),$("#edit_each_style_container select").change(function(){var a=$(this).val();$.publish("StructureEditionView-style",a)}),$("#edit_each_label_container select").change(function(){var a=$(this).val();$.publish("StructureEditionView-label",a)}),$("#edit_each_sublabel_container select").change(function(){var a=$(this).val();$.publish("StructureEditionView-sublabel",a)}),$("#unfold").click(function(){$(this).val();$.publish("StructureEditionView-unfold")})},b.prototype.initKeyboard=function(){},b.prototype.initSubscribe=function(){$.subscribe("StructureEditionModel-toggleUnfolded",function(a,b){var c=b?"Fold":"Unfold";$("#unfold").val(c)})},b.prototype.unactiveView=function(){$.publish("StructureEditionView-unactiveView")},b.prototype.activeView=function(){$.publish("StructureEditionView-activeView","notes")},b}),define(["modules/StructureEdition/src/StructureEditionController","modules/converters/MusicCSLJson/src/SongModel_CSLJson","modules/Cursor/src/CursorModel","tests/test-songs"],function(a,b,c,d){return{run:function(){test("Structures Edition Controller",function(e){var f=b.importFromMusicCSLJSON(d.simpleLeadSheet),g=new c(f.getComponent("notes")),h=new a(f,g),i=f.getComponent("notes"),j=f.getComponent("bars"),k=f.getSections().length;h.addSection(),e.equal(f.getSections().length,k+1,"add section"),h.removeSection(),e.equal(f.getSections().length,k,"remove section"),h.setSectionName("ok é !"),e.equal(f.getSection(0).getName(),"ok é !","Section Name"),h.removeSection(),e.equal(f.getSections().length,k,"remove last section should not change section length"),h.addBar(),e.equal(i.getNotesAtBarNumber(0,f).toString(),"E/4-q,qr,qr,qr","test bar have been created with E at start because it's forst bar"),g.setPos(4),h.addBar(),e.equal(i.getNotesAtBarNumber(1,f).toString(),"qr,qr,qr,qr","test bar have been created with only silence"),h.removeBar(),e.equal(i.getNotesAtBarNumber(0,f).toString(),"E/4-q,qr,qr,qr","test bar have been created with only silence"),g.setPos(0);var l=h._getSelectedBars();e.deepEqual(l,[0,0],"Selected bar"),h.timeSignature("3/4"),e.equal(j.getBar(l[0]).getTimeSignature().toString(),"3/4","Time Signature"),h.tonality("G"),e.equal(j.getBar(l[0]).getTonality(),"G","Tonality"),h.ending("BEGIN"),e.equal(j.getBar(l[0]).getEnding(),"BEGIN","Ending"),h.style("Jazz"),e.equal(j.getBar(l[0]).getStyle(),"Jazz","Style"),h.label("Segno"),e.equal(j.getBar(l[0]).getLabel(),"Segno","Label"),h.subLabel("DC al Coda"),e.equal(j.getBar(l[0]).getSublabel(),"DC al Coda","Sublabel"),e.equal(j.getBar(l[0]).getSublabel(!0),"DC_AL_CODA","Sublabel formatted")})}}}),define(["modules/Tag/src/TagSpaceView","pubsub"],function(a){function b(a,b,c,d){this.songModel=a,this.tags="undefined"!=typeof b?b:[],this.colors="undefined"!=typeof c?c:["#559","#995","#599","#595"],this.tagSpace=[],this.isActive="undefined"!=typeof d?d:!0,this.initSubscribe(),this.CURSOR_HEIGHT=80,this.CURSOR_MARGIN_TOP=20,this.CURSOR_MARGIN_LEFT=6,this.CURSOR_MARGIN_RIGHT=9}return b.prototype.getTags=function(){return this.tags},b.prototype.setTags=function(a){if("undefined"==typeof a)throw"TagManager - setTags tags must be an array "+a;this.tags=a,$.publish("TagManager-setTags",this),$.publish("ToViewer-draw",this.songModel)},b.prototype.getColors=function(){return this.colors},b.prototype.setColors=function(a){if("undefined"==typeof a)throw"TagManager - setColors colors must be an array "+a;this.colors=a,$.publish("TagManager-setColors",this),$.publish("ToViewer-draw",this.songModel)},b.prototype.setActive=function(a){this.isActive=!!a,$.publish("ToViewer-draw",this.songModel)},b.prototype.getActive=function(){return this.isActive},b.prototype.initSubscribe=function(){var a=this;$.subscribe("LSViewer-drawEnd",function(b,c){a.draw(c)})},b.prototype.isInPath=function(a,b){for(var c=0,d=this.tagSpace.length;d>c;c++)if("undefined"!=typeof this.tagSpace[c]&&this.tagSpace[c].isInPath(a,b))return c;return!1},b.prototype.getTagsAreas=function(b){for(var c,d,e,f,g,h,i,j,k,l,m=[],n={},o=this.songModel.getComponent("notes"),p="",q=0,r=this.tags.length;r>q;q++){if(c=o.getIndexesStartingBetweenBeatInterval(this.tags[q].startBeat,this.tags[q].endBeat-1),d=c[0],e=c[1],"undefined"==typeof b.vxfNotes[d]||"undefined"==typeof b.vxfNotes[e])return m;for(k=b.vxfNotes[d];e>=d;)h=b.vxfNotes[d],i=h.stave.y,"undefined"!=typeof b.vxfNotes[d+1]&&(j=b.vxfNotes[d+1].stave.y),(i!=j||d==e)&&(l=h.getBoundingBox(),f=k.getBoundingBox().x-this.CURSOR_MARGIN_LEFT,g=l.x-f+l.w+this.CURSOR_MARGIN_RIGHT,n={x:f,y:i+this.CURSOR_MARGIN_TOP,xe:g,ye:this.CURSOR_HEIGHT},p="","undefined"!=typeof this.tags[q].name&&(p=this.tags[q].name),m.push(new a(n,p)),d!=e&&(k=b.vxfNotes[d+1])),d++}return m},b.prototype.draw=function(a){if(this.isActive===!0&&!(this.tags.length<=0)){var b=a.ctx.fillStyle;a.ctx.font="15px Arial",this.tagSpace=this.getTagsAreas(a);for(var c=3,d=this.colors.length,e=0,f=this.tagSpace.length;f>e;e++)a.ctx.globalAlpha=.4,a.ctx.fillStyle=this.colors[e%d],e%2?(this.tagSpace[e].position.y+=c,this.tagSpace[e].position.ye+=c):(this.tagSpace[e].position.y-=c,this.tagSpace[e].position.ye-=c),a.ctx.fillRect(this.tagSpace[e].position.x,this.tagSpace[e].position.y,this.tagSpace[e].position.xe,this.tagSpace[e].position.ye),a.ctx.globalAlpha=1,a.ctx.fillStyle="black",a.ctx.fillText(this.tagSpace[e].name,this.tagSpace[e].position.x,this.tagSpace[e].position.y+this.tagSpace[e].position.ye+12);a.ctx.fillStyle=b,a.ctx.globalAlpha=1}},b}),define([],function(){function a(a,b){this.position=a,this.name=b}return a.prototype.isInPath=function(a,b){return"undefined"!=typeof a&&!isNaN(a)&&"undefined"!=typeof b&&!isNaN(b)&&this.position.x<=a&&a<=this.position.x+this.position.xe&&this.position.y<=b&&b<=this.position.y+this.position.ye?!0:!1},a}),define(["modules/core/src/SongBarsIterator"],function(a){function b(){this.buffer=null,this.source=null,this.pixelRatio=window.devicePixelRatio,this.waveBarDimensions=[],this.barTimes=[],this.beatDuration=0,this.ctx=null,this.currBar=0}return b.prototype.load=function(a,b,c){var d=new XMLHttpRequest;this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.source=this.audioCtx.createBufferSource();var e=this;d.open("GET",a),d.responseType="arraybuffer",d.onload=function(){var a=d.response;e.audioCtx.decodeAudioData(a,function(a){e.buffer=a,e.beatDuration=e.buffer.duration/c.getSongTotalBeats(),e.source.buffer=e.buffer,e.source.connect(e.audioCtx.destination),e.drawAudio(b,c)},function(a){throw"Error with decoding audio data"+a.err})},d.send()},b.prototype.play=function(){this.startTime=this.audioCtx.currentTime,this.isPause=!1;var a=window.requestAnimationFrame||window.webkitRequestAnimationFrame,b=this;this.source.start(0);var c=function(){b.isPause||(b.drawCursor(b.getPlayedTime()),a(c))};c()},b.prototype.pause=function(){this.isPause=!0,this.source.stop()
},b.prototype.getPeaks=function(a,b,c){b=b||0,c=c||1;for(var d=~~(b*this.buffer.length),e=~~(c*this.buffer.length),f=(e-d)/a,g=~~(f/10)||1,h=this.buffer.numberOfChannels,i=[],j=[],k=0;h>k;k++)for(var l=i[k]=[],m=this.buffer.getChannelData(k),n=0;a>n;n++){for(var o=~~(n*f+d),p=~~(o+f),q=0,r=o;p>r;r+=g){var s=m[r];s>q?q=s:-s>q&&(q=-s)}l[n]=q,(0==k||q>j[n])&&(j[n]=q)}return j},b.prototype.drawPeaks=function(a,b,c,d){if(a[0]instanceof Array){var e=a;if(this.params.splitChannels)return this.setHeight(e.length*this.params.height*this.pixelRatio),void e.forEach(this.drawPeaks,this);a=e[0]}var f=.5/this.pixelRatio,g=b.w,h=b.h,i=b.y,j=h/2,k=a.length,l=1;l=g/k,d.fillStyle=c,this.progressCc&&(this.progressCc.fillStyle=this.params.progressColor),[d,this.progressCc].forEach(function(c){if(c){c.beginPath(),c.moveTo(b.x+f,j+i);for(var d=0;k>d;d++){var e=Math.round(a[d]*j);c.lineTo(b.x+d*l+f,j+e+i)}c.lineTo(b.x+g+f,j+i),c.moveTo(b.x+f,j+i);for(var d=0;k>d;d++){var e=Math.round(a[d]*j);c.lineTo(b.x+d*l+f,j-e+i)}c.lineTo(b.x+g+f,j+i),c.closePath(),c.fill(),c.fillRect(b.x,j+i-f,g,f)}},this)},b.prototype._getCursorPos=function(a){function b(a){for(;d.currBar<d.barTimes.length&&d.barTimes[d.currBar]<a;)d.currBar++;return d.currBar}function c(a,b){var c={},e=d.waveBarDimensions[a],f=0===a?0:d.barTimes[a-1],g=d.barTimes[a],h=(b-f)/(g-f),i=20;return c.y=e.y+i,c.h=e.h-2*i,c.x=e.x+h*e.w,c.w=e.w,c}var d=this,e=b(a),f=c(e,a);return f},b.prototype.drawCursor=function(a){a=a||0,dim=this._getCursorPos(a),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.beginPath(),this.ctx.moveTo(dim.x,dim.y),this.ctx.lineTo(dim.x,dim.y+dim.h),this.ctx.stroke()},b.prototype.drawAudio=function(b,c){this.ctx=b.layerCtx;for(var d,e,f,g=c.getComponent("bars").getTotal(),h=new a(c),i=0,j=1/g,k=0,l=0,m=["#55F","#5A5"],n=0;h.hasNext();)i=this.getBarTime(h,i),this.barTimes.push(i),e=b.barWidthMng.getDimensions(h.getBarIndex()),d={x:e.left,y:e.top-b.LINE_MARGIN_TOP-b.CHORDS_DISTANCE_STAVE,w:e.width,h:b.LINE_MARGIN_TOP},this.waveBarDimensions.push(d),f=this.getPeaks(d.w,k,k+j),this.drawPeaks(f,d,m[l],b.ctx),l=(l+1)%2,k+=j,h.next(),n++;this.drawCursor(0)},b.prototype.getPlayedTime=function(){return this.audioCtx.currentTime-this.startTime},b.prototype.getBarTime=function(a,b){return b+a.getBarTimeSignature().getBeats()*this.beatDuration},b}),define(["pubsub"],function(){function a(a){if(!a)throw"WaveManagerController - WaveMng not defined";$.subscribe("WaveManagerView-play",function(){a.play()}),$.subscribe("WaveManagerView-pause",function(){a.pause()})}return a}),define([],function(){function a(a){this.parentHTML=a,this.playId="audio-play",this.pauseId="audio-pause"}return a.prototype.render=function(){var a=this;this.initView(this.parentHTML,function(){a.initController()})},a.prototype.initView=function(a,b){var c=$("<div></div>");c.css({position:"absolute"}),c.appendTo($(a)),$("<button id="+this.playId+">Play</button>").appendTo(c),$("<button id="+this.pauseId+">Pause</button>").appendTo(c),b()},a.prototype.initController=function(){$("#"+this.playId).click(function(a){a.preventDefault(),$.publish("WaveManagerView-play")}),$("#"+this.pauseId).click(function(a){a.preventDefault(),$.publish("WaveManagerView-pause")})},a}),define(["modules/core/src/SongModel","modules/core/src/SectionModel","modules/core/src/BarManager","modules/core/src/BarModel","modules/core/src/ChordManager","modules/core/src/ChordModel"],function(a){function b(b,c,d){this.el=b,this.songModel="undefined"!=typeof c&&c instanceof a?c:void 0,this.displayTitle="undefined"!=typeof d&&"undefined"!=typeof d.displayTitle?d.displayTitle:!0,this.classTitle="undefined"!=typeof d&&"undefined"!=typeof d.classTitle?d.classTitle:"song_view-title",this.displayComposer="undefined"!=typeof d&&"undefined"!=typeof d.displayComposer?d.displayComposer:!0,this.displayBar="undefined"!=typeof d&&"undefined"!=typeof d.displayBar?d.displayBar:!0,this.delimiterBar="undefined"!=typeof d&&"undefined"!=typeof d.delimiterBar?d.delimiterBar:"|",this.delimiterNewLine="undefined"!=typeof d&&"undefined"!=typeof d.delimiterNewLine?d.delimiterNewLine:"<br />",this.delimiterBeat="undefined"!=typeof d&&"undefined"!=typeof d.delimiterBeat?d.delimiterBeat:"",this.displaySection="undefined"!=typeof d&&"undefined"!=typeof d.displaySection?d.displaySection:!0,this.fillEmptyBar="undefined"!=typeof d&&"undefined"!=typeof d.fillEmptyBar?d.fillEmptyBar:!0,this.fillEmptyBarCharacter="undefined"!=typeof d&&"undefined"!=typeof d.fillEmptyBarCharacter?d.fillEmptyBarCharacter:"%",this._initSubscribe()}return b.prototype._initSubscribe=function(){var a=this;$.subscribe("ToViewer-draw",function(){a.draw()})},b.prototype.draw=function(){var a="";if("undefined"!=typeof this.songModel){this.displayTitle===!0&&(a+='<span class="song_view-title">'+this.songModel.getTitle()+"</span> "),this.displayComposer===!0&&(a+="("+this.songModel.getComposer()+")"),(this.displayTitle===!0||this.displayComposer===!0)&&(a+=this.delimiterNewLine);for(var b=this.songModel.getComponent("bars"),c=this.songModel.getSections().length,d=0;c>d;d++){if(a+=this.delimiterNewLine,a+=this.getSectionView(d),this.displayBar===!0)for(var e,f,g,h=0,i=b.getBars().length;i>h;h++){e=b.getBar(h),0!==h&&(a+=this.delimiterBar),"undefined"==typeof e.ending||"BEGIN"!==e.ending&&"BEGIN_END"!==e.ending||(a+=":"),0!==h&&(a+=" ");var j=this.songModel.getComponentsAtBarNumber(h,"chords");if(0===j.length&&this.fillEmptyBar===!0)a+=this.fillEmptyBarCharacter+" ";else for(var k=0,l=j.length;l>k;k++)if(a+="undefined"!=typeof j[k+1]&&j[k].getBeat()===j[k+1].getBeat()?j[k].toString("")+"_":j[k].toString("")+" ",""!==this.delimiterBeat){g=this.songModel.getComponent("chords"),f=g.getChordDuration(this.songModel,g.getChordIndex(j[k])),f=Math.floor(f);for(var m=0;f-1>m;m++)a+=this.delimiterBeat+" "}"undefined"==typeof e.ending||"END"!==e.ending&&"BEGIN_END"!==e.ending||(a+=":")}a+=this.delimiterNewLine}}this.el.innerHTML=a},b.prototype.getSectionView=function(a){var b="";if(this.displaySection===!0&&"undefined"!=typeof this.songModel.getSection(a)){var c=this.songModel.getSection(a);if(b+=c.getName(),c.getRepeatTimes()>0){var d=parseInt(c.getRepeatTimes(),10)+1;b+=" ("+d+")"}b+=": "}return b},b}),define(["modules/converters/MusicCSLJson/src/SongModel_CSLJson","modules/core/src/SongModel","modules/chordSequence/src/SongView_chordSequence","tests/test-songs"],function(a,b,c,d){return{run:function(){test("SongView_chordSequence",function(e){{var f=new b,g=a.importFromMusicCSLJSON(d.simpleLeadSheet,f),h={displayTitle:!0,displayComposer:!0,displaySection:!0,displayBar:!0,delimiterBar:"|",delimiterNewLine:"\n",fillEmptyBar:!0,fillEmptyBarCharacter:"%"},i=document.createElement("div"),j=new c(i,g,h);j.draw()}e.equal(i.innerHTML,'<span class="song_view-title">Whatever song</span> (Random Composer)\n\nA: AM7 | % | B7 | % | Em | % | F7 | % \n'),j.displayTitle=!1,j.draw(),e.equal(i.innerHTML,"(Random Composer)\n\nA: AM7 | % | B7 | % | Em | % | F7 | % \n","Display title false"),j.displayTitle=!0,j.displayComposer=!1,j.draw(),e.equal(i.innerHTML,'<span class="song_view-title">Whatever song</span> \n\nA: AM7 | % | B7 | % | Em | % | F7 | % \n',"Display composer false"),j.displayComposer=!0,j.displaySection=!1,j.draw(),e.equal(i.innerHTML,'<span class="song_view-title">Whatever song</span> (Random Composer)\n\nAM7 | % | B7 | % | Em | % | F7 | % \n',"Display section false"),j.displaySection=!0,j.displayBar=!1,j.draw(),e.equal(i.innerHTML,'<span class="song_view-title">Whatever song</span> (Random Composer)\n\nA: \n',"Display bar false"),j.displayBar=!0,j.delimiterBar="/",j.draw(),e.equal(i.innerHTML,'<span class="song_view-title">Whatever song</span> (Random Composer)\n\nA: AM7 / % / B7 / % / Em / % / F7 / % \n',"delimiterBar"),j.delimiterBar="|",j.fillEmptyBar=!1,j.draw(),e.equal(i.innerHTML,'<span class="song_view-title">Whatever song</span> (Random Composer)\n\nA: AM7 | | B7 | | Em | | F7 | \n',"fillEmptyBar set to false"),j.fillEmptyBar=!0,j.fillEmptyBarCharacter="%%",j.draw(),e.equal(i.innerHTML,'<span class="song_view-title">Whatever song</span> (Random Composer)\n\nA: AM7 | %% | B7 | %% | Em | %% | F7 | %% \n',"fillEmptyBarCharacter"),j.fillEmptyBarCharacter="%"})}}}),define(["modules/core/src/BarModel"],function(a){var b={};return b.importFromMusicCSLJSON=function(b){var c=new a,d=["segno","segno2","fine","coda","coda2","on cue"];return d.forEach(function(a){b.hasOwnProperty(a)&&c.setLabel(a)}),b.hasOwnProperty("ending")&&c.setEnding(b.ending),b.hasOwnProperty("sublabel")&&c.setSublabel(b.sublabel),b.hasOwnProperty("timeSignature")&&c.setTimeSignature(b.timeSignature),c},b.exportToMusicCSLJSON=function(a){var b={};return a.getLabel()&&(b[a.getLabel()]=1),a.getEnding()&&(b.ending=a.getEnding()),a.getSublabel()&&(b.sublabel=a.getSublabel()),a.getTimeSignature()&&(b.timeSignature=a.getTimeSignature()),b},b}),define(["modules/core/src/ChordModel"],function(a){var b={};return b.importFromMusicCSLJSON=function(b){if("undefined"!=typeof b)for(var c,d=[],e=0,f=0,g=b.sections.length;g>f;f++)for(var h=0,i=d.length;i>h;h++){for(var j=0,k=d[h].length;k>j;j++)c=new a,c.importFromMusicCSLJSON(d[h][j]),c.setBarNumber(e),this.addChord(c);e++}return this},b.exportToMusicCSLJSON=function(a){var b=[];if("undefined"!=typeof a.chords&&a.chords.length)for(var c,d,e=0,f=a.chords.length;f>e;e++){c=a.getChord(e),d=c.getBarNumber(),"undefined"==typeof b[d]&&(b[d]=[]);var g={beat:c.getBeat(),p:c.getNote(),ch:c.getChordType()};c.isEmptyBase()||(g.bp=c.getBase().getNote(),g.bch=c.getBase().getChordType()),c.getParenthesis()&&(g.parenthesis=c.getParenthesis()),b[d].push(g)}return b},b}),define(["modules/core/src/ChordModel"],function(a){var b={};return b.importFromMusicCSLJSON=function(b,c){c.setNote(b.p),c.setChordType(b.ch),c.setParenthesis(b.parenthesis),c.setBeat(b.beat),b.hasOwnProperty("bp")&&0!=b.bp.length&&(chordModelBase=new a,chordModelBase.setNote(b.bp),chordModelBase.setChordType(b.bch),c.setBase(chordModelBase)),null!=b.barNumber&&(c.barNumber=b.barNumber)},b.exportToMusicCSLJSON=function(b,c){void 0===c&&(c=!1);var d={};return"undefined"!=typeof b&&b instanceof a&&(d.p=b.getNote(),d.ch=b.getChordType(),b.getParenthesis()&&(d.parenthesis=b.getParenthesis()),d.beat=b.getBeat(),b.isEmptyBase()||(chordBase=b.getBase(),d.bp=chordBase.getNote(),d.bch=chordBase.getChordType()),c&&(d.barNumber=b.barNumber)),d},b}),define(["modules/core/src/NoteModel"],function(a){var b={};return b.importFromMusicCSLJSON=function(b,c){if("undefined"!=typeof b)for(var d in b)this.addNote(new a(b[d]));return this.setNotesBarNum(c),this},b.exportToMusicCSLJSON=function(a,b,c){var d=[];return a.getNotes(b,c+1).forEach(function(a){d.push(a.exportToMusicCSLJSON(songModel))}),d},b}),define(["modules/core/src/NoteModel","utils/NoteUtils"],function(a,b){var c={};return c.importFromMusicCSLJSON=function(a,c){function d(a){var b=/[a-g|A-G](#{1,2}|b{1,2}|n)?\/\d/;if(!a.match(b))throw"Error creating pitch "+a+". Should be in the form [pitch][acc]/[octave]. e.g. Ab/4";var c=a.split("/"),d=c[0].substr(0,1).toUpperCase(),e=c[0].substr(1,c[0].length),f=c[1];return{pitchClass:d,accidental:e,octave:f}}var e=a.duration;-1!=e.indexOf("r")?(c.duration=e.substring(0,e.length-1),c.isRest=!0):(c.duration=e,c.isRest=!1),a.keys.length>1&&(a.keys=b.sortPitches(a.keys));for(var f,g=0,h=a.keys.length;h>g;g++)f=d(a.keys[g]),c.pitchClass[g]=f.pitchClass,c.accidental[g]=f.accidental,c.octave[g]=f.octave;c.setDot(a.dot),c.setTie(a.tie),c.setTuplet(a.tuplet,a.time_modification)},c.exportToMusicCSLJSON=function(a,b,c){if(!a)throw"note sent is not correct";void 0===b&&(b=!0),void 0===c&&(c=!1);var d={};d.keys=[];for(var e=0,f=a.getNumPitches();f>e;e++)d.keys.push(a.getPitch(e));return d.duration=a.duration,null!=a.dot&&(d.dot=a.dot),null!=a.tie&&b&&(d.tie=a.tie),null!=a.tuplet&&b&&(d.tuplet=a.tuplet),null!=a.time_modification&&b&&(d.time_modification=a.time_modification),a.isRest&&(d.duration+="r"),null!=a.measure&&c&&(d.num_measure=a.measure),d},c}),define(["modules/core/src/SectionModel"],function(a){var b={};return b.importFromMusicCSLJSON=function(b,c){if("undefined"==typeof b||"undefined"==typeof c||!(c instanceof a))throw"SectionModel_CSLJson - importFromMusicCSLJSON - bad arguments type";c.setName(b.name),c.setNumberOfBars(b.bars?parseInt(b.bars.length):0),c.setTimeSignature(b.timeSig),c.setRepeatTimes(b.repeat?parseInt(b.repeat):0),c.setStyle(b.style)},b.exportToMusicCSLJSON=function(a){var b={};return b.name=a.getName(),a.getTimeSignature()&&(b.timeSig=a.getTimeSignature().toString()),a.getRepeatTimes()&&(b.repeat=a.getRepeatTimes()),a.getStyle()&&(b.style=a.getStyle()),b},b}),define(function(a){var b=a("modules/core/src/SongModel"),c=a("modules/core/src/SectionModel"),d=a("modules/core/src/BarManager"),e=a("modules/core/src/BarModel"),f=a("modules/core/src/ChordManager"),g=a("modules/core/src/ChordModel"),h=a("modules/core/src/NoteManager"),i=a("modules/core/src/NoteModel"),j=a("modules/converters/MusicCSLJson/src/SectionModel_CSLJson"),k=a("modules/converters/MusicCSLJson/src/BarModel_CSLJson"),l=(a("modules/converters/MusicCSLJson/src/ChordManager_CSLJson"),a("modules/converters/MusicCSLJson/src/ChordModel_CSLJson")),m=(a("modules/converters/MusicCSLJson/src/NoteManager_CSLJson"),a("modules/converters/MusicCSLJson/src/NoteModel_CSLJson")),n={};return n.importFromMusicCSLJSON=function(a,n,o){!n||!n instanceof b?n=new b:n.clear();var p=new f,q=new h,r=new d;if(!a)throw"SongModel_CSLJson-importFromMusicCSLJSON: You can't import an empty song "+a;if("undefined"!=typeof a._id&&"undefined"!=typeof a._id.$oid&&(a._id.$id=a._id.$oid),n._id=a._id?a._id.$id:o,n._id||(n._id=a._id),"undefined"!=typeof a){n.setTitle(a.title),n.setTimeSignature(a.time),n.setTonality(a.keySignature),n.addComposer(a.composer),n.setStyle(a.style),n.setSource(a.source),n.setTempo(a.tempo);var s,t,u,v,w=!1,x=0;null!=a.changes&&(a.changes.forEach(function(a){s=new c,j.importFromMusicCSLJSON(a,s),n.addSection(s),null!=a.bars?a.bars.forEach(function(a){v=k.importFromMusicCSLJSON(a,new e),r.addBar(v),null!=a.chords&&a.chords.forEach(function(a){t=new g,l.importFromMusicCSLJSON(a,t),t.setBarNumber(x),p.addChord(t)}),null!=a.melody&&(w=!0,a.melody.forEach(function(a){u=new i,m.importFromMusicCSLJSON(a,u),q.addNote(u)})),x++}):console.log(a.bars)}),n.addComponent("bars",r),n.addComponent("chords",p),n.addComponent("notes",q))}return n},n.exportToMusicCSLJSON=function(a){if(!a instanceof b)throw"SongModel_CSLJson - exportToMusicCSLJSON - songModel parameters must be an instanceof SongModel";var c={};"undefined"!=typeof a._id&&(c._id=a._id);var d=a.getComposer();"undefined"!=typeof d&&(d=d.toString()),c.composer=d,c.title=a.getTitle(),c.time=a.getTimeSignature().toString(),c.keySignature=a.getTonality(),c.tempo=a.getTempo(),c.style=a.getStyle(),c.source=a.getSource();var e,f,g,h,i=a.getComponent("bars"),n={};c.changes=[];for(var o=0,p=a.getSections().length;p>o;o++){n=j.exportToMusicCSLJSON(a.getSection(o)),e=a.getStartBarNumberFromSectionNumber(o),f=e+a.getSection(o).getNumberOfBars()-1;for(var q,r,s,t,u,v=[],w=e;f>=w;w++)s=k.exportToMusicCSLJSON(i.getBar(w)),q=[],g=a.getComponentsAtBarNumber(w,"chords"),g.forEach(function(a){t=l.exportToMusicCSLJSON(a),q.push(t)}),0!=q.length&&(s.chords=q),h=a.getComponentsAtBarNumber(w,"notes"),r=[],h.forEach(function(a){u=m.exportToMusicCSLJSON(a),r.push(u)}),0!==r.length&&(s.melody=r),v.push(s);n.bars=v,c.changes[o]=n}return c},n}),define(["modules/converters/MusicCSLJson/src/BarModel_CSLJson","modules/core/src/BarModel"],function(a,b){return{run:function(){test("BarModel_CSLJson",function(){{var c=new b;a.exportToMusicCSLJSON(c)}expect(0)})}}}),define(["modules/converters/MusicCSLJson/src/ChordManager_CSLJson","modules/core/src/ChordManager"],function(a,b){return{run:function(){test("ChordManager_CSLJson",function(c){var d=new b,e=a.exportToMusicCSLJSON(d);c.deepEqual(e,[])})}}}),define(["modules/converters/MusicCSLJson/src/ChordModel_CSLJson","modules/core/src/ChordModel"],function(a,b){return{run:function(){test("ChordModel_CSLJson",function(c){var d=new b,e=a.exportToMusicCSLJSON(d);c.deepEqual(e,{ch:"",p:"",beat:1});var f=new b({note:"G",chordType:"m7",beat:3,parenthesis:!0,barNumber:4}),g=a.exportToMusicCSLJSON(f);c.deepEqual(g,{ch:"m7",p:"G",beat:3,parenthesis:!0});var h=new b;a.importFromMusicCSLJSON(g,h);var i=a.exportToMusicCSLJSON(h);c.deepEqual(i,{ch:"m7",p:"G",beat:3,parenthesis:!0})})}}}),define(["modules/converters/MusicCSLJson/src/NoteManager_CSLJson","modules/core/src/NoteManager"],function(a,b){return{run:function(){test("NoteManager_CSLJson",function(){{var c=new b;a.exportToMusicCSLJSON(c)}expect(0)})}}}),define(["modules/converters/MusicCSLJson/src/NoteModel_CSLJson","modules/core/src/NoteModel"],function(a,b){return{run:function(){test("NoteModel_CSLJson",function(c){var d=new b("h"),e=a.exportToMusicCSLJSON(d);c.deepEqual(e,{dot:0,duration:"hr",keys:["B/4"]})})}}}),define(["modules/converters/MusicCSLJson/src/SectionModel_CSLJson","modules/core/src/SectionModel"],function(a,b){return{run:function(){test("SectionModel_CSLJson",function(c){var d=new b,e=a.exportToMusicCSLJSON(d);c.deepEqual(e,{name:""});var d=new b({name:"A",repeatTimes:2,numberOfBars:8,style:"Bossa Nova"}),f=a.exportToMusicCSLJSON(d);c.deepEqual(f,{name:"A",repeat:2,style:"Bossa Nova"});var g=new b;a.importFromMusicCSLJSON(f,g);var h=a.exportToMusicCSLJSON(g);c.deepEqual(h,{name:"A",repeat:2,style:"Bossa Nova"})})}}}),define(["modules/converters/MusicCSLJson/src/SongModel_CSLJson","modules/core/src/SongModel","tests/test-songs"],function(a,b,c){return{run:function(){test("SongModel_CSLJson",function(){{var d=a.importFromMusicCSLJSON(c.simpleLeadSheet,new b);a.exportToMusicCSLJSON(d)}expect(0)})}}}),define(["modules/core/src/BarModel"],function(a){var b={};return b.importFromMusicXML=function(b){var c=new a;b.hasOwnProperty("key")&&c.setTonality(b.key);var d="treble";return b.hasOwnProperty("stave")&&"undefined"!=typeof b.stave[0]&&"undefined"!=typeof b.stave[0].clef?d=b.stave[0].clef:b.hasOwnProperty("clef")&&(d=b.clef),c.setClef(d),c.setTimeSignature(b.hasOwnProperty("time")?b.time.num_beats+"/"+b.time.beat_value:"4/4"),c},b}),define(["modules/core/src/ChordModel"],function(a){var b={};return b.importFromMusicXML=function(b){var c=new a;return b.hasOwnProperty("chordPitch")&&c.setNote(b.chordPitch),b.hasOwnProperty("chordType")&&c.setChordType(b.chordType),c},b}),define(["modules/core/src/NoteModel"],function(a){var b={};return b.importFromMusicXML=function(b,c){function d(a){var b=/[a-g|A-G](#{1,2}|b{1,2}|n)?\/\d/;if(!a.match(b))throw"Error creating pitch "+a+". Should be in the form [pitch][acc]/[octave]. e.g. Ab/4";var c=a.split("/"),d=c[0].substr(0,1).toUpperCase(),e=c[0].substr(1,c[0].length),f=c[1];return{pitchClass:d,accidental:e,octave:f}}"undefine"!=typeof c&&c instanceof a||(c=new a),b.hasOwnProperty("rest")&&(c.isRest=b.rest),b.hasOwnProperty("dot")&&c.setDot(1);var e=b.duration;-1!=e.indexOf("r")?(c.setDuration(e.substring(0,e.length-1)),c.isRest=!0):(c.setDuration(e),c.isRest=!1),b.keys.length>1&&(b.keys=NoteUtils.sortPitches(b.keys));for(var f,g=0,h=b.keys.length;h>g;g++)f=d(b.keys[g]),c.pitchClass[g]=f.pitchClass,c.accidental[g]=f.accidental,c.octave[g]=f.octave;return c.setDot(b.dot),c.setTie(b.tie),"object"==typeof b.tuplet&&null!==b.tuplet&&c.setTuplet(b.tuplet.typeTuplet,b.tuplet.num_notes+"/"+b.tuplet.beats_occupied),c},b}),define(function(a){var b=a("modules/core/src/SongModel"),c=a("modules/core/src/SectionModel"),d=a("modules/core/src/BarManager"),e=(a("modules/core/src/BarModel"),a("modules/core/src/ChordManager")),f=(a("modules/core/src/ChordModel"),a("modules/core/src/NoteManager")),g=(a("modules/core/src/NoteModel"),a("modules/converters/MusicXML/utils/musicXMLParser")),h=a("modules/converters/MusicXML/src/BarModel_MusicXML"),i=a("modules/converters/MusicXML/src/ChordModel_MusicXML"),j=a("modules/converters/MusicXML/src/NoteModel_MusicXML"),k={};return k.importFromMusicXML=function(a,k){"undefined"!=typeof k&&k instanceof b?k.clear():k=new b;var l=new e,m=new f,n=new d,o=new g;if(o.parse(a),"undefined"!=typeof o){Array.prototype.forEach.call(o.documentElement.getElementsByTagName("credit"),function(a){if(a.hasAttribute("page")&&"1"===a.attributes.page.value){var b=a.getElementsByTagName("credit-words")[0].textContent;k.setTitle(b)}}),"undefined"!=typeof o.attributes&&"undefined"!=typeof o.attributes[0]&&"undefined"!=typeof o.attributes[0][0]&&("undefined"!=typeof o.attributes[0][0].key&&k.setTonality(o.attributes[0][0].key),k.setTimeSignature("undefined"!=typeof o.attributes[0][0].time?o.attributes[0][0].time.num_beats+"/"+o.attributes[0][0].time.beat_value:"4/4"));for(var p,q,r,s,t,u=[[1],[1,3],[1,3,4],[1,2,3,4]],v=0,w=o.partList.length;w>v;v++){p=new c,"undefined"!=typeof o.partName[v]&&p.setName(o.partName[v]),k.addSection(p),p.setNumberOfBars(o.measures.length);for(var x=0,y=o.measures.length;y>x;x++){if(q=o.measures[x][0],q=o.getMeasure(x),q=q.part[0],r=h.importFromMusicXML(q.measureInfos),n.addBar(r),"undefined"!=typeof q.chords)for(var z=0,A=q.chords.length;A>z;z++)s=i.importFromMusicXML(q.chords[z]),s.setBarNumber(x),s.setBeat(u[A][z]),l.addChord(s);if("undefined"!=typeof q.notes)for(var z=0,A=q.notes.length;A>z;z++)q.notes[z].chord===!1?(t=j.importFromMusicXML(q.notes[z]),m.addNote(t)):j.importFromMusicXML(q.notes[z],t)}}k.addComponent("bars",n),k.addComponent("chords",l),k.addComponent("notes",m)}return k},k}),define(["modules/converters/MusicXML/utils/musicXMLParser","modules/converters/MusicXML/src/SongModel_MusicXML","modules/core/src/SongModel"],function(){return{run:function(){test("SongModel_MusicXML",function(){expect(0)})}}}),define(function(){var a={};return a=function(){this.partList=[],this.partName=[],this.staveConnectors=[],this.measures=[],this.measureNumbers=[],this.numStaves=[],this.attributes=[]},a.appearsValid=function(a){return"string"==typeof a?-1!=a.search(/<score-partwise/i):a instanceof Document&&"score-partwise"==a.documentElement.nodeName},a.prototype.parse=function(a){if("string"==typeof a)if(window.DOMParser&&"undefined"!=typeof XMLDocument){var b=new window.DOMParser;this.document=b.parseFromString(a,"text/xml")}else{if(!window.ActiveXObject||!new window.ActiveXObject("Microsoft.XMLDOM"))throw new Vex.RERR("UnsupportedBrowserError","No XML parser found");this.document=new window.ActiveXObject("Microsoft.XMLDOM"),this.document.async="false",this.document.loadXML(a)}else{if(!(a instanceof Document))throw this.valid=!1,new Vex.RERR("ArgumentError","MusicXML requires XML string or DOM Document object");this.document=a}if(this.documentElement=this.document.documentElement,"score-partwise"!=this.documentElement.nodeName)throw new Vex.RERR("ArgumentError","VexFlow only supports partwise scores");var c=0;Array.prototype.forEach.call(this.documentElement.childNodes,function(a){if("part-list"==a.nodeName)this.parsePartList(a);else if("part"==a.nodeName){for(var b=0,d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];if("measure"==e.nodeName){if(b in this.measures||(this.measures[b]=[]),this.measures[b].length!=c)return Vex.LogFatal("Part missing measure"),void(this.valid=!1);if(!(b in this.measureNumbers)){var f=parseInt(e.getAttribute("number"));isNaN(f)||(this.measureNumbers[b]=f)}this.measures[b][c]=e;var g=e.getElementsByTagName("attributes")[0];g&&this.parseAttributes(b,c,g),b++}}c in this.numStaves||(this.numStaves[c]=1),c++}},this);var c=0;this.numStaves.forEach(function(a){a>1&&this.staveConnectors.push({type:"brace",parts:[c],system_start:!0}),c++},this),this.valid=!0},a.prototype.parsePartList=function(a){var b=0,c=null,d=null;Array.prototype.forEach.call(a.childNodes,function(a){switch(a.nodeName){case"part-group":"start"==a.getAttribute("type")?(c=[],d=[],Array.prototype.forEach.call(a.childNodes,function(a){switch(a.nodeName){case"group-symbol":("bracket"==a.textContent||"brace"==a.textContent)&&d.push({type:a.textContent,system_start:!0});case"group-barline":"yes"==a.textContent&&d.push({type:"single",measure_start:!0,system_end:!0})}})):"stop"==a.getAttribute("type")&&(d.forEach(function(a){a.parts=c,this.staveConnectors.push(a)},this),c=d=null);break;case"score-part":c&&c.push(b);var e=this;Array.prototype.forEach.call(a.childNodes,function(a){"part-name"===a.nodeName&&(e.partName[b]=a.textContent)}),this.partList.push(b),b++}},this)},a.prototype.isValid=function(){return this.valid},a.prototype.getNumberOfMeasures=function(){return this.measures.length},a.prototype.getMeasureNumber=function(a){var b=this.measureNumbers[a];return isNaN(b)?null:b},a.prototype.getMeasure=function(a){for(var b=this.getAttributes(a,0),c=b.time,d={time:c},e={part:[]},f=this.measures[a].length,g=0;f>g;g++){e.part[g]={};var h=this.getAttributes(a,g);if("string"==typeof h.clef&&(d.clef=h.clef),"string"==typeof h.key&&(d.key=h.key),d.numberOfStaves=this.numStaves[g],d.stave=[],h.clef instanceof Array)for(var i=0;i<this.numStaves[g];i++)d.stave[i]={clef:h.clef[i]};e.part[g].measureInfos=d,e.part[g].notes=[];for(var j=this.measures[a][g].getElementsByTagName("note"),k=0;k<j.length;k++){var l=this.parseNote(j[k],h);e.part[g].notes.push(l),!l.grace}e.part[g].chords=[];for(var m=this.measures[a][g].getElementsByTagName("harmony"),k=0,n=m.length;n>k;k++){var o=this.parseChord(m[k],h);e.part[g].chords.push(o)}}return e},a.prototype.getStaveConnectors=function(){return this.staveConnectors},a.prototype.parseAttributes=function(a,b,c){for(var d=c.childNodes,e=0;e<d.length;e++){var f=null,g=d[e];switch(g.nodeName){case"staves":0==a&&(this.numStaves[b]=parseInt(g.textContent));break;case"key":f=this.getKeySignature(parseInt(g.getElementsByTagName("fifths")[0].textContent));break;case"time":f=g.getElementsByTagName("senza-misura").length>0?{num_beats:4,beat_value:4,soft:!0}:{num_beats:parseInt(g.getElementsByTagName("beats")[0].textContent),beat_value:parseInt(g.getElementsByTagName("beat-type")[0].textContent),soft:!0};break;case"clef":var h=parseInt(g.getAttribute("number")),i=g.getElementsByTagName("sign")[0].textContent,j=parseInt(g.getElementsByTagName("line")[0].textContent),k="G"==i&&"2"==j?"treble":"C"==i&&"3"==j?"alto":"C"==i&&"4"==j?"tenor":"F"==i&&"4"==j?"bass":null;h>0?(f=a in this.attributes&&b in this.attributes[a]&&this.attributes[a][b].clef instanceof Array?this.attributes[a][b].clef:new Array(this.numStaves[b]),f[h-1]=k):f=k;break;case"divisions":f=parseInt(g.textContent);break;default:continue}a in this.attributes||(this.attributes[a]=[]),b in this.attributes[a]||(this.attributes[a][b]={}),this.attributes[a][b][g.nodeName]=f}return f},a.prototype.parseNote=function(a,b){var c={rest:!1,chord:!1};if(c.tickMultiplier=1,c.tuplet=null,Array.prototype.forEach.call(a.childNodes,function(a){switch(a.nodeName){case"pitch":var d=a.getElementsByTagName("step")[0].textContent,e=parseInt(a.getElementsByTagName("octave")[0].textContent),f=a.getElementsByTagName("alter")[0];if(f)switch(parseInt(f.textContent)){case 1:d+="#";break;case 2:d+="##";break;case-1:d+="b";break;case-2:d+="bb"}c.keys=[d+"/"+e.toString()];break;case"type":var g=a.textContent;c.duration={whole:"w",half:"h",quarter:"q",eighth:"8","16th":"16","32nd":"32","64th":"64","128th":"128","256th":"256"}[g],c.rest&&(c.duration+="r");break;case"dot":c.dot=!0;break;case"duration":var h={numerator:1/(4*parseInt(a.textContent,10)),denominator:b.divisions};if(isNaN(h.numerator)||isNaN(h.denominator))throw"InvalidMusicXML - Error parsing MusicXML duration";1==h.denominator&&(h=h.numerator),c.intrinsicTicks=h,c.duration||(c.duration="4");break;case"time-modification":var i=a.getElementsByTagName("actual-notes")[0],j=a.getElementsByTagName("normal-notes")[0];if(i&&j){if(i=parseInt(i.textContent),j=parseInt(j.textContent),!(i>0&&j>0))break;c.tickMultiplier={beats_occupied:j,num_notes:i},c.tuplet={typeTuplet:"middle",num_notes:i,beats_occupied:j}}break;case"rest":c.rest=!0;var d=a.getElementsByTagName("display-step")[0],e=a.getElementsByTagName("display-octave")[0];d&&e&&(c.keys=[d.textContent+"/"+e.textContent]),c.duration||(c.duration="1r");break;case"grace":c.grace=!0;break;case"chord":c.chord=!0;break;case"voice":var k=parseInt(a.textContent);isNaN(k)||(c.voice=k);break;case"staff":var l=parseInt(a.textContent);!isNaN(l)&&l>0&&(c.stave=l-1);break;case"stem":"up"==a.textContent?c.stem_direction=1:"down"==a.textContent&&(c.stem_direction=-1);break;case"beam":var m=a.textContent;if("begin"!=m&&"continue"!=m&&"end"!=m)break;"continue"!=c.beam&&(c.beam=m);break;case"lyric":var n=a.getElementsByTagName("text")[0];n&&(n=n.textContent),n&&(c.lyric={text:n});break;case"notations":Array.prototype.forEach.call(a.childNodes,function(a){switch(a.nodeName){case"tied":var b=a.getAttribute("type");switch(b){case"start":c.tie="stop"==c.tie?"stop_start":"start";break;case"stop":c.tie="start"==c.tie?"stop_start":"stop";break;default:throw"BadMusicXML - Bad tie: "+b.toString()}break;case"tuplet":var d=a.getAttribute("type");switch(d){case"start":c.tuplet.typeTuplet="stop"==c.tuplet.typeTuplet?"stop_start":"start";break;case"stop":c.tuplet.typeTuplet="start"==c.tuplet.typeTuplet?"stop_start":"stop";break;default:throw"BadMusicXML - Bad tuplet: "+d.toString()}}})}}),c.rest&&!c.keys){var d=b.clef;switch(d instanceof Array&&(d=d[c.stave]),d){case"bass":c.keys=["D/3"];break;case"tenor":c.keys=["A/3"];break;case"alto":c.keys=["C/4"];break;case"treble":default:c.keys=["B/4"]}}return c},a.prototype.parseChord=function(a){var b={};return Array.prototype.forEach.call(a.childNodes,function(a){switch(a.nodeName){case"root":b.chordPitch=a.getElementsByTagName("root-step")[0].textContent;break;case"kind":b.chordType=a.textContent}}),b},a.prototype.getAttributes=function(a,b){for(var c={},d=0;a>=d;d++)if(d in this.attributes&&b in this.attributes[d]){var e=this.attributes[d][b];for(var f in e){var g=e[f];if(g instanceof Array){c[f]&&c[f]instanceof Array||(c[f]=[]);for(var h=0;h<g.length;h++)("undefined"==typeof c[f][h]||"undefined"!=typeof g[h]&&null!=g[h])&&(c[f][h]=g[h])}else c[f]=g}}return c.time||(c.time={num_beats:4,beat_value:4,soft:!0}),c},a.prototype.getKeySignature=function(a){var b={"-7":"Cb","-6":"Gb","-5":"Db","-4":"Ab","-3":"Eb","-2":"Bb","-1":"F",0:"C",1:"G",2:"D",3:"A",4:"E",5:"B",6:"F#",7:"C#"},c=b[a];return c},a.prototype.fetch=function(a){var b=new XMLHttpRequest;return b.open("GET",a,!1),b.send(null),4!=b.readyState?void 0:b.responseText},a}),define(["modules/core/src/BarModel"],function(a){function b(){this.bars=[]}return b.prototype.getTotal=function(){return this.bars.length},b.prototype.getBars=function(){return this.bars},b.prototype.setBars=function(a){this.bars=a},b.prototype.getBar=function(a){if(isNaN(a)||0>a)throw"BarManager - getBar - invalid index :"+a;return this.bars[a]},b.prototype.addBar=function(b){return"undefined"!=typeof b&&b instanceof a||(b=new a),this.bars.push(b),b},b.prototype.removeBar=function(a){if("undefined"==typeof a||isNaN(a)||0>a)throw"BarManager - removeBar - invalid index "+a;this.bars.splice(a,1)},b.prototype.clear=function(){this.bars=[]},b}),define(["modules/core/src/TimeSignatureModel"],function(a){function b(a){"undefined"==typeof a&&(a={}),this.begining="undefined"!=typeof a.begining?a.begining:void 0,this.clef="undefined"!=typeof a.clef?a.clef:void 0,this.ending="undefined"!=typeof a.ending?a.ending:void 0,this.style="undefined"!=typeof a.style?a.style:"",this.timeSignature="undefined"!=typeof a.timeSignature?a.timeSignature:void 0,this.tonality="undefined"!=typeof a.tonality?a.tonality:void 0,this.label="undefined"!=typeof a.label?a.label:void 0,this.sublabel="undefined"!=typeof a.sublabel?a.sublabel:void 0}return b.prototype.setBegining=function(a){if("undefined"==typeof a)throw"BarModel - begining should not be undefined";this.begining=a},b.prototype.getBegining=function(){return this.begining},b.prototype.setClef=function(a){var b=["","treble","bass","alto","tenor","percussion"];if("undefined"==typeof a&&"undefined"==typeof b[a])throw"BarModel - clef should not be undefined";
this.clef=a},b.prototype.getClef=function(){return this.clef},b.prototype.setEnding=function(a){"undefined"==typeof a&&(a=void 0),this.ending=a},b.prototype.removeEnding=function(){this.ending=void 0},b.prototype.getEnding=function(){return this.ending},b.prototype.setStyle=function(a){"undefined"==typeof a&&(a=""),this.style=a},b.prototype.getStyle=function(){return this.style},b.prototype.setTimeSignature=function(b){this.timeSignature=b?new a(b):void 0},b.prototype.getTimeSignature=function(){return this.timeSignature},b.prototype.setTonality=function(a){"undefined"==typeof a&&(a=""),this.tonality=a},b.prototype.getTonality=function(){return this.tonality},b.prototype.setLabel=function(a){"undefined"==typeof a&&(a=""),this.label=a},b.prototype.getLabel=function(){return this.label},b.prototype.setSublabel=function(a){"undefined"==typeof a&&(a=""),this.sublabel=a},b.prototype.getSublabel=function(a){return a&&"undefined"!=typeof this.sublabel?this.sublabel.replace(/ /g,"_").toUpperCase():this.sublabel},b.prototype.clone=function(a){var c=new b(this);return a&&c.removeEnding(),c},b}),define(["modules/core/src/SongModel","modules/core/src/ChordModel"],function(a,b){function c(a){this.chords=a?a:[]}return c.prototype.getTotal=function(){return this.chords.length},c.prototype.isEmpty=function(){return 0===this.chords.length},c.prototype.getChords=function(a,b){return this.chords.slice(a,b)},c.prototype.setAllChords=function(a){this.chords=a},c.prototype.getChord=function(a){return"undefined"!=typeof a&&!isNaN(a)&&this.chords[a]?this.chords[a]:void 0},c.prototype.getChordIndex=function(a){if("undefined"==typeof a||!(a instanceof b))throw"Chord must be a ChordModel";for(var c=0,d=this.chords.length;d>c;c++)if(JSON.stringify(this.getChord(c))===JSON.stringify(a))return c;return void 0},c.prototype.setChord=function(a,c){if("undefined"==typeof a||!(a instanceof b)||"undefined"==typeof c||isNaN(c)||0>c)throw"Wrong Parameters";this.chords[c]=a},c.prototype.addChord=function(a){this.chords.push("undefined"!=typeof a&&a instanceof b?a:new b)},c.prototype.insertChord=function(a,c){if("undefined"!=typeof a&&isNaN(a))throw"Index must be a int in insert chord";if("undefined"==typeof c||!(c instanceof b))var c=new b;this.chords.splice(a,0,c)},c.prototype.removeChord=function(a){if("undefined"!=typeof a&&!(a instanceof b))throw"Chord must be a ChordModel";var c=this.getChordIndex(a);this.removeChordByIndex(c)},c.prototype.removeChordByIndex=function(a){if("undefined"==typeof a||isNaN(a)||0>a)throw"Index must be a int in removeChordByIndex";if(this.chords[a]){this.chords.splice(a,1)}},c.prototype.incrementChordsBarNumberFromBarNumber=function(a,b){if("undefined"!=typeof b&&!isNaN(b)&&b>=0)for(var c,d=0,e=this.chords.length;e>d;d++)c=this.chords[d],c.getBarNumber()>=b&&c.setBarNumber(c.getBarNumber()+a)},c.prototype.getChordsByBarNumber=function(a){var b=[];if("undefined"!=typeof a&&!isNaN(a)&&a>=0)for(var c,d=0,e=this.chords.length;e>d;d++)c=this.chords[d],c.getBarNumber()===a&&b.push(c);return b},c.prototype.removeChordsByBarNumber=function(a){if("undefined"!=typeof a&&!isNaN(a)&&a>=0)for(var b,c=this.chords.length-1;c>=0;c--)b=this.chords[c],b.getBarNumber()===a&&this.removeChordByIndex(c)},c.prototype.searchChordByBarAndBeat=function(a,b){if(!isNaN(a)&&a>=0&&!isNaN(b)&&b>=0)for(var c,d=0,e=this.chords.length;e>d;d++)if(c=this.chords[d],c.getBarNumber()===a&&c.getBeat()===b)return c;return void 0},c.prototype.cloneElems=function(a,b){var c=[],d=this.getChords(a,b);return d.forEach(function(a){var b=a.clone();c.push(b)}),c},c.prototype.getChordDuration=function(a,b){if("undefined"==typeof a||"undefined"==typeof b||isNaN(b))throw"ChordManager - getChordDuration - wrong arguments";if("undefined"==typeof this.chords[b])return void 0;var c,d,e=this.chords[b].getBarNumber(),f=this.chords[b].getBeat(),g=a.getTimeSignatureAt(e).getBeats();if("undefined"!=typeof this.chords[b+1])c=this.chords[b+1].getBarNumber(),d=this.chords[b+1].getBeat();else{var h=a.getSectionNumberFromBarNumber(e);c=a.getStartBarNumberFromSectionNumber(h)+a.getSection(h).getNumberOfBars(),d=1}var i=0;return c===e?i=d-f:c>e&&(i=g*(c-e)+d-f),i},c.prototype.getChordDurationFromBarNumber=function(a,b,c){if("undefined"==typeof a||isNaN(b)||isNaN(c))throw"ChordManager - getChordDurationFromBarNumber - wrong arguments";if("undefined"!=typeof this.chords[b]){var d,e,f=this.chords[b].getBarNumber(),g=this.chords[b].getBeat(),h=a.getTimeSignatureAt(f).getBeats();"undefined"!=typeof this.chords[b+1]?(d=this.chords[b+1].getBarNumber(),e=this.chords[b+1].getBeat()):(d=c+1,e=1);var i=0;return d===f?i=e-g:d>f&&(f===c?i=h-g+1:d>c?i=a.getTimeSignatureAt(c).getBeats():c===d&&(i=e-1)),i}return void 0},c.prototype.getChordIndexByPosition=function(a,b){function c(a,b){return a.numBar==b.getBarNumber()&&a.numBeat==b.getBeat()}function d(a,b){return a.numBar>b.getBarNumber()||a.numBar==b.getBarNumber()&&a.numBeat>b.getBeat()}function e(a,b){return a.numBar<b.getBarNumber()||a.numBar==b.getBarNumber()&&a.numBeat<b.getBeat()}for(var f,g=this.getChords(),h=0,i=g.length;i>h;h++){if(c(a,g[h])){f="equal";break}if(d(a,g[h])&&(h+1==g.length||e(a,g[h+1]))){f="greater";break}}return b&&"equal"!=f&&h++,{index:h,exact:"equal"==f}},c.prototype.getChordsAsString=function(){for(var a=[],b=0;b<this.chords.length;b++)a.push(this.chords[b].toString());return a},c.prototype.getBeatIntervalByIndexes=function(a,b){if("undefined"==typeof a||isNaN(a)||"undefined"==typeof b||isNaN(b))throw"Start and End parameters should be number";var c=this.songModel,d=this.getChord(a),e=this.getChord(b),f=c.getBeatsBeforeBarNumber(d.getBarNumber())+d.getBeat(),g=c.getBeatsBeforeBarNumber(e.getBarNumber())+1+c.getTimeSignatureAt(e.getBarNumber()).getBeats();return[f,g]},c.prototype.getIndexesStartingBetweenBeatInterval=function(a,b){if("undefined"==typeof a||isNaN(a)||"undefined"==typeof b||isNaN(b))throw"Start and End parameters should be number";var c=this.songModel,d=c.getPositionFromBeat(a),e=c.getPositionFromBeat(b),f=this.getChordIndexByPosition(d,!0),g=this.getChordIndexByPosition(e);return g.exact&&g.index--,[f.index,g.index]},c}),define(function(){function a(a){function b(){function a(a){var b=document.createElement("div");return b.innerHTML=a,b.firstChild.nodeValue}var b={halfdim:"&#248;",dim:"&#959;"};for(var c in b)b[c]=a(b[c]);return b}this.note=a&&a.note?a.note:"",this.chordType=a&&a.chordType?a.chordType:"",this.base=a&&a.base?a.base:{},this.parenthesis=a&&"undefined"!=typeof a.parenthesis?a.parenthesis:!1,this.beat=a&&"undefined"!=typeof a.beat?a.beat:1,this.barNumber=a&&"undefined"!=typeof a.barNumber?a.barNumber:0,this.chordSymbolList=b()}return a.prototype.getNote=function(){return this.note},a.prototype.setNote=function(a){if("undefined"==typeof a)throw"Undefined note";this.note=a},a.prototype.getChordType=function(){return this.chordType},a.prototype.setChordType=function(a){this.chordType=a},a.prototype.getBase=function(){return this.base},a.prototype.isEmptyBase=function(){return 0===Object.keys(this.base).length?!0:!1},a.prototype.setBase=function(b){if(!("undefined"!=typeof b&&b instanceof a||""===b))throw"Base don't have the correct ChordModel type";this.base=b},a.prototype.getParenthesis=function(){return this.parenthesis},a.prototype.setParenthesis=function(a){this.parenthesis=!!a},a.prototype.getBeat=function(){return this.beat},a.prototype.setBeat=function(a){return"undefined"==typeof a||isNaN(a)?!1:(this.beat=a,!0)},a.prototype.getBarNumber=function(){return this.barNumber},a.prototype.setBarNumber=function(a){return"undefined"==typeof a||isNaN(a)?!1:(this.barNumber=Number(a),!0)},a.prototype.isEmpty=function(){return"undefined"==typeof this.note||""===this.note?!0:!1},a.prototype.toString=function(b,c){"undefined"==typeof b&&(b=""),"undefined"==typeof c&&(c=!0);var d=this.getChordType();c&&(d="undefined"!=typeof d?this.formatChordType(d):"");var e="";this.isEmpty()||(e=this.getNote()+b+d);var f=this.getBase();if(f instanceof a&&""!==f.getNote()){var g=f.getChordType();c&&(g="undefined"!=typeof g?this.formatChordType(g):""),e+="/"+f.getNote()+b+g}return this.getParenthesis()&&(e="("+e+")"),e},a.prototype.setChordFromString=function(b){b=b.split("/");var c,d=b[0];if(b.length>=2){var e=b[1];this.base instanceof a==!1&&(this.base=new a),this.base.setChordFromString(e)}d=d.replace(/\s/g,"");var f;f="b"==d.charAt(1)||"#"==d.charAt(1)||"%"==d.charAt(1)?2:"NC"==d?d.length:1;var g=d.substring(0,f),c=d.substring(f,d.length);this.setNote(g),this.setChordType(c)},a.prototype.serialize=function(){var a={};return a.note=this.note,a.chordType=this.chordType,this.isEmptyBase()!==!0&&(a.base=this.base.toString()),a.parenthesis=this.parenthesis,a.beat=this.beat,a.barNumber=this.barNumber,a},a.prototype.clone=function(){return new a(this.serialize())},a.prototype.formatChordType=function(a){if("undefined"==typeof a)return"";for(var b in this.chordSymbolList)a=a.replace(b,this.chordSymbolList[b]);return a},a.prototype.unformatChordType=function(a){if("undefined"==typeof a)return"";for(var b in this.chordSymbolList)a=a.replace(this.chordSymbolList[b],b);return a},a}),define(["modules/core/src/NoteModel","utils/NoteUtils"],function(a,b){function c(){this.notes=[]}function d(a){return Math.round(1e6*a)/1e6}return c.prototype.getTotal=function(){return this.notes.length},c.prototype.getTotalDuration=function(a,b){var c=this.getNotes(a,b),e=0;return c.forEach(function(a){e+=a.getDuration()}),d(e)},c.prototype.addNote=function(b,c){if(!b instanceof a)throw"note is not an instance of Note";"undefined"==typeof c?this.notes.push(b):this.notes.splice(c,0,b)},c.prototype.getNote=function(a){return a=a||0,this.notes[a]},c.prototype.deleteNote=function(a){if("undefined"==typeof a)throw"pos undefined. Can't delete note";this.getNotes();this.notes.splice(a,1)},c.prototype.getNotes=function(a,b){return this.notes.slice(a,b)},c.prototype.setNotes=function(a){"undefined"!=typeof a&&(this.notes=a)},c.prototype.insertNote=function(b,c){if(isNaN(b)||!(c instanceof a))throw"NoteManager - insertNote - attribute incorrect "+b+" "+c;this.notes.splice(b+1,0,c)},c.prototype.cloneElems=function(a,b){var c=[],d=this.getNotes(a,b);return d.forEach(function(a){c.push(a.clone())}),c},c.prototype.notesSplice=function(a,b){for(var c=this.notes.slice(0,a[0]),d=this.notes.slice(a[1]+1,this.notes.length),e=[],f=0,g=b.length;g>f;f++)e.push(b[f].clone());this.notes=c.concat(e,d)},c.prototype.addNotes=function(a,b){void 0===b&&(b=this.notes.length),this.notesSplice([b,b-1],a)},c.prototype.getNoteBeat=function(a){if("undefined"==typeof a||isNaN(a)||a>=this.notes.length||0>a)throw"NoteManager - getNoteBeat: problem with index "+a;var b,c=1;for(b=0;a>b;b++)c+=this.notes[b].getDuration();return d(c)},c.prototype.getNotesAsString=function(){var a=[];return this.notes.forEach(function(b){a.push(b.toString())}),a},c.prototype.getNoteIndex=function(b){if("undefined"!=typeof b&&b instanceof a){console.warn("getNoteIndex does not work as expected");for(var c=0;c<this.notes.length;c++)if(JSON.stringify(this.notes[c].serialize(!0))===JSON.stringify(b.serialize(!0)))return c}return void 0},c.prototype.getNotesAtBarNumber=function(a,b){if(!b)throw"NoteManager - getNotesAtBarNumber - incorrect song parameter";var c,d=1;return d=b.getStartBeatFromBarNumber(a),c=d+b.getTimeSignatureAt(a).getBeats(),this.getTotalDuration()+1<c&&console.warn("NoteManager - getNotesAtBarNumber - notes on bar "+a+" do not fill the total bar duration"+(this.getTotalDuration()+1)+" "+c),this.getNotes(this.getNextIndexNoteByBeat(d),this.getNextIndexNoteByBeat(c))},c.prototype.getNoteBarNumber=function(a,b){if(isNaN(a)||0>a||"undefined"==typeof b)throw"NoteManager - getNoteBarNumber - attributes are not what expected, song: "+b+", index: "+a;for(var c=0,e=0,f=b.getBarNumBeats(c,null),g=0;a>=g;g++)d(e)==f&&(c++,e=0,f=b.getBarNumBeats(c,f)),e+=this.notes[g].getDuration();return c},c.prototype.getBeatIntervalByIndexes=function(a,b){if("undefined"==typeof a||isNaN(a)||a>=this.notes.length||0>a)throw"NoteManager - getBeatIntervalByIndexes:  problem with start "+a;if("undefined"==typeof b||isNaN(b)||b>=this.notes.length||0>b)throw"problem with end "+b;var c=this.getNoteBeat(a),e=this.getNoteBeat(b)+this.getNote(b).getDuration();return e=d(e),[c,e]},c.prototype._getIndexAndCurBeat=function(a){for(var b,c=0,e=1;d(e)<a;){if(b=this.getNote(c),void 0===b)throw"NoteManager - getNextIndexNoteByBeat - Note not found (possibly beat is greater than last note beat)";e+=b.getDuration(),c++}return{index:c,curBeat:e}},c.prototype.getNextIndexNoteByBeat=function(a){if(isNaN(a)||1>a)throw"NoteManager - getNextIndexNoteByBeat - beat must be a positive integer "+a;return this._getIndexAndCurBeat(a).index},c.prototype.getPrevIndexNoteByBeat=function(a){if(isNaN(a)||0>a)throw"NoteManager - getPrevIndexNoteByBeat - beat must be a positive integer "+a;var b=this._getIndexAndCurBeat(a);return b.curBeat===a?b.index:b.index-1},c.prototype.getIndexesStartingBetweenBeatInterval=function(a,b){if((isNaN(a)||0>a)&&(a=1),isNaN(b))throw"NoteManager - getIndexesStartingBetweenBeatInterval - endBeat must be a positive integer "+b;var c=this.getNextIndexNoteByBeat(a),d=this.getPrevIndexNoteByBeat(b);return[c,d]},c.prototype.fillGapWithRests=function(c,d){if(!isNaN(c)){(isNaN(d)||0>d)&&(d=1),c=Math.round(1e6*c)/1e6;var e,f=b.durationToNotes(c,d),g=this;f.forEach(function(b){"undefined"!=typeof b&&(e=new a(b+"r"),g.addNote(e))})}},c.prototype.reviseNotes=function(){function b(a,b){for(var c=b,d=b;c>0&&"no"!=a[c-1];)c--;for(;d+1<a.length&&"no"!=a[d+1];)d++;return{min:c,max:d}}function c(c,d,e,f){for(var g,h,i=Object.keys(d),j=[],k=0;k<e.length;k++){if(g=1>k?"no":e[k-1],h=k==e.length?"no":e[k],-1==$.inArray(g,i))throw"value "+g+"(position "+k+") not specified on transitions graph";if(-1==$.inArray(h,d[g])){var l="no"==h?k-1:k;j.push(b(e,l))}}var m,n;for(var k in j){m=j[k].max,n=j[k].min;for(var o=n;m>=o;o++)a.prototype[f].call(c[o],c[o].tie)}}function d(a){for(var b,d,e=[],f=0;f<a.length;f++)b=a[f],d=b.getTuplet()||"no",e.push(d);c(a,{no:["no","start"],start:["middle"],middle:["stop"],stop:["start","no"]},e,"removeTuplet")}function e(a){for(var b,d,e=[],f=0;f<a.length;f++)b=a[f],d=b.getTie()||"no",e.push(d);c(a,{no:["no","start"],start:["stop","stop_start"],stop_start:["stop","stop_start"],stop:["start","no"]},e,"removeTie")}d(this.notes),e(this.notes)},c}),define(["utils/NoteUtils"],function(a){function b(b){if(this.pitchClass=[],this.octave=[],this.accidental=[],this.duration=b&&b.duration?b.duration:void 0,this.isRest=b&&b.isRest?b.isRest:!1,this.dot=b&&b.dot?b.dot:0,this.tie=b&&b.tie?b.tie:void 0,this.tuplet=b&&b.tuplet?b.tuplet:void 0,this.timeModification=b&&b.timeModification?b.timeModification:void 0,"undefined"!=typeof this.tuplet&&this.setTuplet(this.tuplet,this.timeModification),"string"==typeof b)this.setNoteFromString(b);else if("undefined"!=typeof b&&"undefined"!=typeof b.pitchList){b.pitchList.length>1&&(b.pitchList=a.sortPitches(b.pitchList));for(var c=0,d=b.pitchList.length;d>c;c++)this.setNoteFromString(b.pitchList[c],c)}}return b.prototype.toString=function(){if(this.isRest)return this.duration+"r";for(var a=this.pitchClass[0]+this.accidental[0]+"/"+this.octave[0]+"-"+this.duration,b=0;b<this.dot;b++)a+=".";return a},b.prototype.setNoteFromString=function(a,b){b=b||0;var c=/[a-g|A-G](#{1,2}|b{1,2}|n)?(-[w|h|q|8|16|32|64])?\.{0,2}\/\d/;if(a.match(c)){var d=a.split("-"),e=d[0].split("/");if(this.pitchClass[b]=e[0].substr(0,1).toUpperCase(),this.accidental[b]=e[0].substr(1,e[0].length),this.octave[b]=e[1],2==d.length){var f=d[1].split("/"),g=f[0].indexOf(".");-1==g?this.duration=f[0]:(this.duration=f[0].split(".")[0],this.dot=f[0].length-g)}}else{if(c=/[w|h|q|8|16|32|64](r)?/,!a.match(c))throw"Creating pitch "+a+". Should be in de form [pitch][acc]/[octave]. e.g. Ab/4 or [duration] if you want a rest eg. '8'";this.pitchClass[0]="B",this.octave[0]="4",this.accidental[0]="";var h=a.indexOf("r");this.duration=-1===h?a:a.substr(0,h),this.isRest=!0}},b.prototype.getNumPitches=function(){return this.pitchClass.length},b.prototype.getPitchClass=function(a){return a=a||0,this.pitchClass[a]},b.prototype.getAccidental=function(a){return a=a||0,this.accidental[a]},b.prototype.getOctave=function(a){return a=a||0,this.octave[a]},b.prototype.getPitch=function(a){a=a||0;var b="";"undefined"!=typeof this.accidental[a]&&(b=this.accidental[a]);var c="";return"undefined"!=typeof this.octave[a]&&(c="/"+this.octave[a]),this.pitchClass[a]+b+c},b.prototype.setDot=function(a){if("undefined"!=typeof a){var b=Number(a);if(isNaN(b)||0>b||b>2)throw"not valid number of dots";this.dot=b}},b.prototype.getDot=function(){return this.dot},b.prototype.setTie=function(a){if(a){var b=["start","stop","stop_start"];if(-1==b.indexOf(a))throw"not valid tie type "+a;this.tie?a!=this.tie&&(this.tie="stop_start"):this.tie=a}},b.prototype.getTie=function(){return this.tie},b.prototype.removeTie=function(a){if("stop_start"!=this.tie)this.tie=null;else{if(void 0===a)throw"tieType not defined";this.tie="start"==a?"stop":"start"}},b.prototype.isTie=function(a){return a?this.tie&&-1!=this.tie.indexOf(a):null!=this.tie},b.prototype.setTuplet=function(a,b){if(a||b){var c=["start","stop","stop_start","middle"];if(a&&-1==c.indexOf(a))throw"not valid typeTuplet "+a;this.timeModification=b||"3/2","middle"!=a&&(this.tuplet=a)}},b.prototype.getTuplet=function(){return this.timeModification&&!this.tuplet?"middle":this.tuplet},b.prototype.getTimeModification=function(){return this.timeModification||null},b.prototype.removeTuplet=function(){this.timeModification=null,this.tuplet=null},b.prototype.isTuplet=function(a){return a?null!=this.timeModification&&this.tuplet&&-1!=this.tuplet.indexOf(a):null!=this.timeModification},b.prototype.setRest=function(a){"undefined"==typeof a&&(a=!0),this.isRest=a,this.setAccidental("")},b.prototype.setAccidental=function(a,b){var c=["","#","b","n","##","bb"];if(-1==c.indexOf(a))throw"invalid accidental";b=b||0,this.accidental[b]=a},b.prototype.getAccidental=function(a){return a=a||0,this.accidental[a]},b.prototype.removeAccidental=function(a){this.setAccidental("",a)},b.prototype.getNumPitches=function(){return this.pitchClass.length},b.prototype.getDuration=function(b){var c=0;if(c=a.getBeatFromStringDuration(this.duration),4===c&&this.isRest&&(c="undefined"==typeof b||b>4?4:b),null!=this.timeModification){var d=this.timeModification.split("/");c=c*parseInt(d[1],null)/parseInt(d[0],null)}for(var e=c,f=0,g=this.dot;g>f;f++)e/=2,c+=e;return c},b.prototype.setDuration=function(b){"number"==typeof b&&(b=a.getStringFromBeatDuration(b)),this.duration=b},b.prototype.serialize=function(a){void 0===a&&(a=!0);var b={};b.pitchList=[];for(var c=0,d=this.getNumPitches();d>c;c++)b.pitchList.push(this.getPitch(c));return b.duration=this.duration,null!=this.dot&&(b.dot=this.dot),null!=this.tie&&a&&(b.tie=this.tie),null!=this.tuplet&&a&&(b.tuplet=this.tuplet),null!=this.time_modification&&a&&(b.time_modification=this.time_modification),this.isRest&&(b.isRest=this.isRest),b},b.prototype.clone=function(a){return new b(this.serialize(a))},b}),define(function(){function a(a){this.section=a,this.index=0}return a.prototype={hasNext:function(){return this.index<this.section.getNumberOfBars()},getBarIndex:function(){return this.index},getSection:function(){return this.section},next:function(){this.index++},isLastBar:function(){return this.index==this.section.getNumberOfBars()-1}},a}),define(function(){function a(a){a=a||{},this.setName(a.name),this.setRepeatTimes(a.repeatTimes),this.setNumberOfBars(a.numberOfBars),this.setStyle(a.style),this.setTimeSignature(a.timeSignature)}return a.prototype.setName=function(a){this.name=void 0!==a?a:""},a.prototype.getName=function(){return this.name},a.prototype.setRepeatTimes=function(a){if(void 0===a&&(a=0),0>a)throw"repeatTimes cannot be negative";this.repeatTimes=parseInt(a,10)},a.prototype.getRepeatTimes=function(){return this.repeatTimes},a.prototype.setNumberOfBars=function(a){this.numberOfBars=void 0!==a?a:0},a.prototype.getNumberOfBars=function(){return this.numberOfBars},a.prototype.setStyle=function(a){this.style=void 0!==a?a:""},a.prototype.getStyle=function(){return this.style},a.prototype.setTimeSignature=function(a){this.timeSignature=void 0!==a?a:void 0},a.prototype.getTimeSignature=function(){return this.timeSignature},a.prototype.cloneUnfolded=function(b){if(!b)throw"SectionModel - cloneUnfolded: numBars not valid :"+b;return new a({name:this.name,numberOfBars:b,style:this.style,timeSignature:this.timeSignature})},a}),define(function(){function a(a){this.song=a,this.index=0,this.bm=this.song.getComponent("bars"),this.prevTimeSig=null,this.prevKeySig=null,this.endingState=null}return a.prototype={hasNext:function(){return this.index<this.bm.getTotal()},next:function(){this.bm.getBar(this.index);this.prevKeySig=this.getBarKeySignature(),this.prevTimeSig=this.getBarTimeSignature(),this.index++},getBarIndex:function(){return this.index},getBar:function(){return this.bm.getBar(this.index)},getFollowingBar:function(){return this.bm.getBar(this.index+1)},getBarKeySignature:function(){var a=this.getBar().getTonality();return a?a:0===this.index?this.song.getTonality():this.prevKeySig},getBarTimeSignature:function(){var a=this.getBar().getTimeSignature();return a?a:0===this.index?this.song.getTimeSignature():this.prevTimeSig},getEndingState:function(){return this.endingState},setEndingState:function(a){this.endingState=a}},a}),define(["modules/core/src/NoteManager","modules/core/src/BarManager","modules/core/src/ChordManager","modules/core/src/TimeSignatureModel"],function(a,b,c,d){function e(a){this.init(a)}return e.prototype.init=function(c){this.title="undefined"!=typeof c&&c.title?c.title:"",this.composers="undefined"!=typeof c&&c.composers?c.composers:[],this.style="undefined"!=typeof c&&c.style?c.style:"",this.source="undefined"!=typeof c&&c.source?c.source:"",this.tempo="undefined"!=typeof c&&c.tempo?c.tempo:120,this.tonality="undefined"!=typeof c&&c.tonality?c.tonality:"C",this.timeSignature="undefined"!=typeof c&&c.timeSignature?c.timeSignature:new d("4/4"),this.sections="undefined"!=typeof c&&c.sections?c.sections:[],this.components="undefined"!=typeof c&&c.components?c.components:[],this.addComponent("notes",new a),this.addComponent("bars",new b)},e.prototype.getTitle=function(){return this.title},e.prototype.setTitle=function(a){this.title=a},e.prototype.getComposer=function(a){return a=a||0,this.composers[a]},e.prototype.addComposer=function(a){return"undefined"!=typeof a?(this.composers.push(a),!0):!1},e.prototype.getStyle=function(){return this.style},e.prototype.setStyle=function(a){"undefined"!=typeof a&&(this.style=a)},e.prototype.getSource=function(){return this.source},e.prototype.setSource=function(a){return"undefined"!=typeof a?(this.source=a,!0):!1},e.prototype.setTempo=function(a){"undefined"==typeof a||isNaN(a)||0>a||(this.tempo=a)},e.prototype.getTempo=function(){return this.tempo},e.prototype.setTonality=function(a){"undefined"!=typeof a&&(this.tonality=a)},e.prototype.getTonality=function(){return this.tonality},e.prototype.getTonalityAt=function(a){if("undefined"==typeof a||isNaN(a))throw"invalid barNumber "+a;for(var b,c=this.tonality,d=this.getComponent("bars");a>=0;){if(null!=d.getBar(a)&&(b=d.getBar(a).getTonality(),"undefined"!=typeof b&&""!==b))return b;a--}return c},e.prototype.setTimeSignature=function(a){this.timeSignature=new d("undefined"==typeof a?"4/4":a)},e.prototype.getTimeSignature=function(){return this.timeSignature},e.prototype.getTimeSignatureAt=function(a){var b,c=this.getTimeSignature(),d=this.getSectionNumberFromBarNumber(a);if("undefined"==typeof d)return c;for(var e=this.getStartBarNumberFromSectionNumber(d),f=this.getComponent("bars");a>=e;){if(b=f.getBar(a).getTimeSignature(),"undefined"!=typeof b)return b;a--}return b=this.getSection(d).getTimeSignature(),"undefined"!=typeof b?b:c},e.prototype.getSection=function(a){if(isNaN(a)||0>a||a>this.sections.length)throw"getSection - invalid index :"+a;return this.sections[a]},e.prototype.getSections=function(){return this.sections},e.prototype.addSection=function(a){this.sections.push(a)},e.prototype.removeSection=function(a){if("undefined"==typeof a||isNaN(a)||0>a)throw"SongModel - removeSection - invalid sectionIndex "+a;this.sections.splice(a,1)},e.prototype.getComponent=function(a){return this.components.hasOwnProperty(a)?this.components[a]:void 0},e.prototype.addComponent=function(a,b){return b?(this.components[a]=b,!0):!1},e.prototype.getBar=function(a){return console.warn('get bar will be deleted, use getComponent("bars") instead'),this.getComponent("bars").getBar(a)},e.prototype.getBarNumBeats=function(a,b){var c=this.getComponent("bars").getBar(a).getTimeSignature(),d=c||this.getTimeSignature();if(!d&&!b)throw"bad use: either song is not well formatted, either currentBeats is not sent";return d?d.getBeats():b},e.prototype.getBars=function(){return console.warn('getBars will be deleted, use getComponent("bars").getBars() instead'),this.getComponent("bars").getBars()},e.prototype.getUnfoldedSongComponents=function(a){var b=[];"undefined"==typeof a&&(a=void 0);for(var c=this.getUnfoldedSongStructure(),d=0;d<c.length;d++)b.push(this.getComponentsAtBarNumber(c[d],a));return b},e.prototype.getUnfoldedSongStructure=function(){for(var a=[],b=0,c=this.getSections().length;c>b;b++)a=a.concat(this.getUnfoldedSongSection(b));return a},e.prototype.getUnfoldedSongSection=function(a){if("undefined"!=typeof a&&!isNaN(a)){for(var b,c,d,e=this.getComponent("bars"),f=this.getSection(a),g=f.getRepeatTimes(),h=0,i=0,j=[],k=[];g>=0||h>1e3;){h++,j=[],i=0,b=this.getStartBarNumberFromSectionNumber(a),c=b+f.getNumberOfBars();for(var l=b;c>l;l++)d=parseInt(e.getBar(l).getEnding(),10),!isNaN(d)&&d>0&&(i=d,g--),0===i&&j.push(l),!isNaN(d)&&d>1&&(k=k.concat(j)),k.push(l);g--}return k}},e.prototype.getStartBarNumberFromSectionNumber=function(a){if(isNaN(a))throw"SongModel - getStartBarNumberFromSectionNumber - sectionNumber is not a number: "+a;for(var b=0,c=0;a>c;c++)b+=this.getSection(c).getNumberOfBars();return b},e.prototype.getSectionNumberFromBarNumber=function(a){if("undefined"==typeof a||isNaN(a)||0>a)throw"SongModel - getSectionNumberFromBarNumber - barNumber is not a number: "+a;for(var b=this.getSections(),c=0,d=0,e=b.length;e>d;d++)if("undefined"!=typeof b[d]&&(c+=b[d].getNumberOfBars(),c>a))return d;return void 0},e.prototype.getStartBeatFromBarNumber=function(a){var b=1;if("undefined"!=typeof a&&!isNaN(a)&&a>=0)for(var c=0;a>c;c++)b+=this.getTimeSignatureAt(c).getBeats();return b},e.prototype.getSongTotalBeats=function(){for(var a=0,b=this.getComponent("bars"),c=this.getTimeSignature().getBeats(),d=0,e=0,f=this.sections.length;f>e;e++)for(var g=0,h=this.sections[e].getNumberOfBars();h>g;g++)"undefined"!=typeof b.getBar(d)&&"undefined"!=typeof b.getBar(d).getTimeSignature()&&(c=b.getBar(d).getTimeSignature().getBeats()),a+=c,d++;return a},e.prototype.getComponentsAtBarNumber=function(b,d){var e=[];if(!d||!this.components.hasOwnProperty(d))throw"the item is matching no known type in getComponentsAtBarNumber";var f=this.components[d];if("undefined"!=typeof c&&f instanceof c)for(var g=f.getChordsByBarNumber(b),h=0;h<g.length;h++)e.push(g[h]);else if("undefined"!=typeof a&&f instanceof a)for(var i=e.concat(f.getNotesAtBarNumber(b,this)),j=0;j<i.length;j++)e.push(i[j]);return e},e.prototype.clear=function(){this.init()},e.prototype.unfold=function(){function d(){var b=h.getUnfoldedSongComponents("notes"),c=new a;for(var d in b)c.addNotes(b[d]);return c.getNotes()}function f(){var a,b=[],c=h.getUnfoldedSongComponents("chords");for(var d in c)for(var e in c[d])a=c[d][e].clone(),a.setBarNumber(d),b.push(a);return b}function g(){var a,b,c,d,e,f=[],g=[],i=h.getComponent("bars");for(a=0,b=h.getSections().length;b>a;a++)for(d=h.getSection(a),e=h.getUnfoldedSongSection(a),f.push(d.cloneUnfolded(e.length)),c=0;c<e.length;c++)g.push(i.getBar(e[c]).clone(!0));return{newBars:g,newSections:f}}var h=this,i=new e({title:this.getTitle(),composers:this.composers,style:this.getStyle(),source:this.getSource(),tempo:this.getTempo(),tonality:this.getTonality(),timeSignature:this.getTimeSignature()}),j=g(),k=new b;k.setBars(j.newBars),i.sections=[];for(var l in j.newSections)i.addSection(j.newSections[l]);var m=new a;m.setNotes(d());var n=new c;return n.setAllChords(f()),i.addComponent("notes",m),i.addComponent("chords",n),i.addComponent("bars",k),i},e}),define(function(){function a(a){var b=/\d\/\d/;if(!a||!a.match(b))throw"TimeSignatureModel - Time signature not valid "+a;var c=a.split("/");this.numBeats=parseInt(c[0],10),this.beatUnit=parseInt(c[1],10)}return a.prototype.getBeats=function(){return this.numBeats},a.prototype.getBeatUnitQuarter=function(){return 4/this.beatUnit},a.prototype.getBeatUnit=function(){return this.beatUnit},a.prototype.getQuarterBeats=function(){return 4/this.beatUnit*this.numBeats},a.prototype.toString=function(){return this.numBeats+"/"+this.beatUnit},a}),define(["modules/core/src/BarModel"],function(a){return{run:function(){test("Bar model",function(b){var c=new a;b["throws"](function(){c.setBegining()}),c.setBegining("test"),b.equal(c.getBegining(),"test"),b["throws"](function(){c.setClef()}),c.setClef("treble"),b.equal(c.getClef(),"treble"),c.setClef(""),b.equal(c.getClef(),""),c.setEnding(),b.equal(c.getEnding(),void 0),c.setEnding("1"),b.equal(c.getEnding(),"1"),c.setStyle(),b.equal(c.getStyle(),""),c.setStyle("Jazz"),b.equal(c.getStyle(),"Jazz"),c.setTimeSignature(),b.equal(c.getTimeSignature(),void 0),c.setTimeSignature("4/4"),b.equal(typeof c.getTimeSignature(),"object"),c.setTonality(),b.equal(c.getTonality(),""),c.setTonality("F"),b.equal(c.getTonality(),"F"),c.setLabel(),b.equal(c.getLabel(),""),c.setLabel("Coda"),b.equal(c.getLabel(),"Coda"),c.setSublabel(),b.equal(c.getSublabel(),""),c.setSublabel("DC al Coda"),b.equal(c.getSublabel(),"DC al Coda"),b.equal(c.getSublabel(!1),"DC al Coda"),b.equal(c.getSublabel(!0),"DC_AL_CODA","formated sublabel")})}}}),define(function(a){var b=a("modules/core/src/SongModel"),c=a("modules/core/src/SectionModel"),d=(a("modules/core/src/BarManager"),a("modules/core/src/BarModel")),e=a("modules/core/src/ChordManager"),f=a("modules/core/src/ChordModel");return{run:function(){test("ChordManager",function(a){var g=new e;a.equal(g.getTotal(),0),g.addChord(),a.equal(g.getTotal(),1),a["throws"](function(){g.removeChord()});var h=new f;h.setNote("NC"),g.insertChord(0,h),a.equal(g.getTotal(),2),g.removeChord(h),a.equal(g.getTotal(),1),a.equal(g.getChordIndex(h),void 0);var i=new b;i.addSection(new c({numberOfBars:4})),i.getComponent("bars").addBar(new d),i.getComponent("bars").addBar(new d),i.getComponent("bars").addBar(new d);var j=new e;h=new f({note:"G",chordType:"7",beat:2,barNumber:0}),j.addChord(h);var k=new f({note:"F",chordType:"M7",beat:3,barNumber:2});j.addChord(k),a.equal(j.getChordDurationFromBarNumber(i,0,0),3,"chord duration - first bar"),a.equal(j.getChordDurationFromBarNumber(i,0,1),4,"chord duration - last full bar"),a.equal(j.getChordDurationFromBarNumber(i,0,2),2,"chord duration - end bar"),a.equal(j.getChordDuration(i,0),9,"chord duration - first"),a.equal(j.getChordDuration(i,1),6,"chord duration - last"),a.equal(j.getChordDuration(i,2),void 0,"chord does not exist"),a.equal(j.getChordsByBarNumber(0)[0].toString(),h.toString()),j.incrementChordsBarNumberFromBarNumber(1,0),a.equal(j.getChordsByBarNumber(1)[0].toString(),h.toString()),j.incrementChordsBarNumberFromBarNumber(-1,0),a.equal(j.getChordsByBarNumber(0)[0].toString(),h.toString()),j.removeChordsByBarNumber(0),a.equal(j.getChordsByBarNumber(0)[0],void 0)})}}}),define(["modules/core/src/ChordModel"],function(a){return{run:function(){test("Chords",function(b){var c=new a;b.equal(c.toString(),""),b["throws"](function(){c.setNote()}),b.equal(c.getNote(),""),b.equal(c.getChordType(),""),b.ok(!c.getParenthesis()),b.deepEqual(c.getBase(),{});
var d=new a;d.setNote("G"),d.setChordType("m"),c.setBase(d),b.equal(c.getBase().getNote(),"G"),b.equal(c.getBase().getChordType(),"m"),c.setBase(""),c.setNote("Db"),b.equal(c.getNote(),"Db"),c.setChordType("M7"),b.equal(c.getChordType(),"M7"),b.equal(c.toString(),"DbM7"),b.equal(c.toString(" "),"Db M7"),c.setParenthesis(!0),b.equal(c.toString(""),"(DbM7)"),c.setChordFromString("A#m9/E"),b.equal(c.getNote(),"A#"),b.equal(c.getChordType(),"m9"),b.equal(c.getBase().getNote(),"E"),b.equal(c.getBase().getChordType(),"");var e=new a({note:"G",chordType:"m7",beat:3});b.equal(e.getNote(),"G");var f=e.clone();b.deepEqual(f,e)})}}}),define(["modules/core/src/NoteManager","modules/core/src/NoteModel","modules/core/src/SongModel","modules/converters/MusicCSLJson/src/SongModel_CSLJson","tests/test-songs"],function(a,b,c,d,e){return{run:function(){test("NoteManager",function(f){function g(a,b,c,d,e){var f=0;a.getNotes(d,e).forEach(function(a){b.equal(a.getPitch(),c[f]),f++})}function h(a){function c(a){a.addNote(new b({pitchList:["E/4"],duration:"q"})),a.addNote(new b({pitchList:["F/4"],duration:"8"})),a.addNote(new b({pitchList:["G/4"],duration:"8"})),a.addNote(new b({pitchList:["A/4"],duration:"8",dot:1})),a.addNote(new b({pitchList:["B/4"],duration:"16"}))}c(a),f.equal(a.getTotal(),5),f.equal(a.getTotalDuration(),3),g(a,f,["E/4","F/4","G/4","A/4","B/4"]),a.addNote(new b({pitchList:["C/5"],duration:"8"}),0),g(a,f,["C/5","E/4","F/4","G/4","A/4","B/4"]),a.addNote(new b({pitchList:["D/5"],duration:"8"}),1),g(a,f,["C/5","D/5","E/4"],0,3),f["throws"](function(){a.deleteNote()},"Delete note"),a.deleteNote(1),a.deleteNote(0),g(a,f,["E/4","F/4","G/4"],0,3),g(a,f,["F/4","G/4","A/4"],1,4);var d=[];d.push(new b({pitchList:["E/5"],duration:"q"})),d.push(new b({pitchList:["F/5"],duration:"q"})),a.notesSplice([1,1],d),g(a,f,["E/4","E/5","F/5","G/4","A/4","B/4"]),d=[],d.push(new b({pitchList:["Gb/5"],duration:"q"})),a.notesSplice([3,6],d),g(a,f,["E/4","E/5","F/5","Gb/5"])}function i(a){function c(){var a=[];return a.push(new b({pitchList:["F#/5"],duration:"q"})),a.push(new b({pitchList:["G/5"],duration:"8",dot:1})),a.push(new b({pitchList:["F#/5"],duration:"16"})),a.push(new b({pitchList:["F#/5"],duration:"q",tuplet:"start",timeModification:"3/2"})),a.push(new b({pitchList:["G/5"],duration:"q",timeModification:"3/2"})),a.push(new b({pitchList:["A/5"],duration:"q",tuplet:"stop",timeModification:"3/2"})),a.push(new b({pitchList:["Bb/5"],duration:"q"})),a}a.setNotes(c()),f["throws"](function(){a.getNoteBeat(7)},"Get Note beat"),f.equal(a.getNoteBeat(0),1),f.equal(a.getNoteBeat(1),2),f.equal(a.getNoteBeat(2),2.75),f.equal(a.getNoteBeat(3),3),f.equal(a.getNoteBeat(4).toFixed(3),3.667),f.equal(a.getNoteBeat(5).toFixed(3),4.333),f.equal(a.getNoteBeat(6),5),f["throws"](function(){a.getNextIndexNoteByBeat()}),f["throws"](function(){a.getNextIndexNoteByBeat(0)}),f["throws"](function(){a.getNextIndexNoteByBeat(.5)}),f.equal(a.getNextIndexNoteByBeat(1.8),1),f.equal(a.getNextIndexNoteByBeat(3),3),f.equal(a.getNextIndexNoteByBeat(3.1),4),f.equal(a.getNextIndexNoteByBeat(4.9),6),f.equal(a.getPrevIndexNoteByBeat(1.1),0),f["throws"](function(){a.getNextIndexNoteByBeat(10)}),f["throws"](function(){a.getNextIndexNoteByBeat(6.1)},"getNextIndexNoteByBeat last beat must throw error"),f.equal(a.getNextIndexNoteByBeat(2),1),f.equal(a.getPrevIndexNoteByBeat(2),1),f.equal(a.getPrevIndexNoteByBeat(2.2),1),f.equal(a.getNextIndexNoteByBeat(2.2),2),f.deepEqual(a.getBeatIntervalByIndexes(0,2),[1,3]),f.deepEqual(a.getBeatIntervalByIndexes(1,5),[2,5]),f.deepEqual(a.getIndexesStartingBetweenBeatInterval(1,3.1),[0,3]);new b({pitchList:["A/5"],duration:"q",tuplet:"stop",timeModification:"3/2"});f.equal(a.getNoteBeat(0),1),f.equal(a.getNoteBeat(1),2),f.equal(a.getNoteBeat(2),2.75),f.equal(a.getNoteBeat(3),3),f.equal(a.getNoteBeat(4).toFixed(3),3.667),f.equal(a.getNoteBeat(6),5)}function j(a,b){var e=d.importFromMusicCSLJSON(b.simpleLeadSheet,new c),g=e.getComponent("notes"),h=g.getNotesAtBarNumber(3,e);f.equal(h[0].getPitch(),"A/4"),f.equal(h[1].getPitch(),"F/4"),f.equal(h[2].getPitch(),"G/4"),f.equal(h[3].getPitch(),"E/4"),f.equal(g.getNoteBarNumber(0,e),0),f.equal(g.getNoteBarNumber(1,e),0),f.equal(g.getNoteBarNumber(2,e),0),f.equal(g.getNoteBarNumber(3,e),0),f.equal(g.getNoteBarNumber(4,e),0),f.equal(g.getNoteBarNumber(5,e),1),f.equal(g.getNoteBarNumber(6,e),1),f.equal(g.getNoteBarNumber(7,e),1),f.equal(g.getNoteBarNumber(8,e),1),f.equal(g.getNoteBarNumber(9,e),2),f.equal(g.getNoteBarNumber(10,e),2)}var k=new a;h(k),i(k),j(k,e)})}}}),define(["modules/core/src/NoteModel"],function(a){return{run:function(){test("Notes",function(b){var c=new a;c.setDot(),b.equal(c.getDot(),0),c.setDot(1),b.equal(c.getDot(),1),b["throws"](function(){c.setDot("wrongDot")}),c.setTie(),b.equal(c.getTie(),void 0),b["throws"](function(){c.setTie("wrongTie")}),c.setTie("start"),b.equal(c.getTie(),"start"),c.setTie("start"),b.equal(c.getTie(),"start"),c.setTie("stop"),b.equal(c.getTie(),"stop_start"),b["throws"](function(){c.setTuplet("wrongValidType")}),c.setTuplet("start"),b.equal(c.getTuplet(),"start"),b.equal(c.getTimeModification(),"3/2"),b.ok(c.isTuplet()),c.removeTuplet(),b.equal(c.getTuplet(),null),b.equal(c.getTimeModification(),null),b.ok(!c.isTuplet()),c.setTuplet(null,"5/4"),b.equal(c.getTuplet(),"middle"),b.equal(c.getTimeModification(),"5/4"),b.ok(c.isTuplet()),c.setTuplet("middle","3/4"),b.equal(c.getTuplet(),"middle"),b.equal(c.getTimeModification(),"3/4"),b.ok(c.isTuplet()),b["throws"](function(){c.setAccidental("invalidAcc")}),c.setAccidental("#"),b.equal(c.getAccidental(),"#"),c.removeAccidental(),b.equal(c.getAccidental(),"");var d=new a({pitchList:["E/4"],duration:"q"});b.equal(d.getPitch(),"E/4"),b.equal(d.getNumPitches(),1);var e=new a({pitchList:["E/4","C/4","G#/3"],duration:"q"});b.equal(e.getPitch(0),"G#/3"),b.equal(e.getPitch(1),"C/4"),b.equal(e.getPitch(2),"E/4"),b.equal(e.getNumPitches(),3);var f=new a("h");b.equal(f.getDuration(),2),b.ok(f.isRest),f=new a("hr"),b.equal(f.getDuration(),2),b.ok(f.isRest);var g=new a("C#/4-8.");b.equal(g.getPitch(),"C#/4"),b.equal(g.getNumPitches(),1),b.equal(g.getAccidental(),"#"),b.equal(g.getDuration(),.75),b.equal(g.getDot(),1),b.equal(g.getTie(),void 0),b.equal(g.getTuplet(),null),b.equal(g.getTimeModification(),null),b.ok(!g.isRest),b.equal(g.toString(),"C#/4-8.");var h=new a("16r");b.equal(h.getDuration(),.25),b.ok(h.isRest,"is a silence"),b.equal(h.toString(),"16r");var i=g.clone();b.deepEqual(i,g,"clone test");var j=h.clone();b.deepEqual(j,h,"clone test with silence")})}}}),define(["modules/core/src/SectionModel"],function(a){return{run:function(){test("Section model",function(b){var c=new a({numberOfBars:10,name:"A",repeatTimes:1,style:"jazz"});b.equal(c.getName(),"A","testing constructor"),b.equal(c.getRepeatTimes(),1),b.equal(c.getNumberOfBars(),10),b.equal(c.getStyle(),"jazz"),b["throws"](function(){c.setRepeatTimes(-2)}),b["throws"](function(){c.cloneUnfolded()},"cloneUnfolded with no param throws exception");var d=c.cloneUnfolded(16);b.equal(d.getName(),c.getName(),"testing unfoldedSection"),b.equal(d.getRepeatTimes(),0),b.equal(d.getNumberOfBars(),16),b.equal(d.getStyle(),c.getStyle())})}}}),define(["tests/test-songs","modules/core/src/SongModel","modules/converters/MusicCSLJson/src/SongModel_CSLJson","modules/core/src/TimeSignatureModel"],function(a,b,c,d){return{run:function(){test("SongModel",function(e){function f(){var b=c.importFromMusicCSLJSON(a.foldedSong);console.log("----------------");var d=b.getUnfoldedSongComponents("notes");e.equal(d.length,20,"getUnfoldedSongComponents: unfolded bars"),e.equal(d[14][0].pitchClass[0],"A","getUnfoldedSongComponents: note in 14th bar has pitch A"),console.log("----------------");var f=b.unfold();e.deepEqual(b.getComponent("notes").getNotesAsString(),["Db/4-w","E/4-w","F/4-w","A#/4-w","C/5-w","B/4-h","A/4-h","A/4-h","qr","qr","B/4-w","Ab/4-w","G#/4-w","D/5-w","F/5-w","E/5-w","E/5-w"],"compare folded notes"),e.deepEqual(f.getComponent("notes").getNotesAsString(),["Db/4-w","E/4-w","F/4-w","A#/4-w","Db/4-w","E/4-w","C/5-w","B/4-h","A/4-h","Db/4-w","E/4-w","A/4-h","qr","qr","B/4-w","Db/4-w","E/4-w","Ab/4-w","G#/4-w","D/5-w","F/5-w","E/5-w","E/5-w"],"compare unfolded notes"),e.deepEqual(b.getComponent("chords").getChordsAsString(),["Dm","F7","Am","G7","E7","F","D","G7","CM7"],"compare folded chords"),e.deepEqual(f.getComponent("chords").getChordsAsString(),["Dm","F7","Dm","Am","Dm","G7","Dm","E7","F","D","G7","CM7"],"compare unfolded chords")}var g=c.importFromMusicCSLJSON(a.simpleLeadSheet,new b);g.getComponent("bars").getBar(5).setTonality("Eb"),e.equal(g.getTonalityAt(1),"C"),e.equal(g.getTonalityAt(5),"Eb"),e.equal(g.getTonalityAt(6),"Eb"),g.getComponent("bars").getBar(5).setTimeSignature("3/4"),e["throws"](function(){g.getTimeSignatureAt()}),e.deepEqual(g.getTimeSignatureAt(1).getBeats(),new d("4/4").getBeats()),e.deepEqual(g.getTimeSignatureAt(5).getBeats(),new d("3/4").getBeats()),e.deepEqual(g.getTimeSignatureAt(6).getBeats(),new d("3/4").getBeats()),e.equal(g.getSectionNumberFromBarNumber(0),0),e.equal(g.getSectionNumberFromBarNumber(6),0),e.equal(g.getSectionNumberFromBarNumber(10),void 0),e.equal(g.getBarNumBeats(0),4),e.equal(g.getStartBeatFromBarNumber(0),1),e.equal(g.getStartBeatFromBarNumber(2),9),e.equal(g.getSongTotalBeats(),29),f()})}}}),define(["modules/core/src/TimeSignatureModel"],function(a){return{run:function(){test("Time Signature",function(b){b["throws"](function(){new a("timesign/notvalid")});var c=new a("5/4");b.equal(c.getBeats(),5),b.equal(c.getQuarterBeats(),5),c=new a("3/8"),b.equal(c.getBeats(),3),b.equal(c.getQuarterBeats(),1.5)})}}}),define(["jquery"],function(a){var b={};return b.request=function(b,c){if("undefined"==typeof b)throw"AjaxUtils - ajaxRequest - request argument is undefined "+b;if("undefined"==typeof b.url)throw"AjaxUtils - ajaxRequest - url argument is undefined "+url;"undefined"==typeof b.type&&(b.type="GET"),"undefined"==typeof b.data&&(b.data={}),"undefined"==typeof b.dataType&&(b.dataType="jsonp"),"undefined"==typeof b.withCredentialsBool&&(b.withCredentialsBool=!1),a.ajax({url:b.url,dataType:b.dataType,type:b.type,data:b.data,xhrFields:{withCredentials:b.withCredentialsBool},success:function(a){"undefined"!=typeof c&&c(a)},error:function(a,b,d){console.warn("AjaxUtils - Ajax Request fail "+b+" : "+d.message),"undefined"!=typeof c&&c(d)}})},b.servletRequest=function(a,c,d,e){if("undefined"==typeof a)throw"AjaxUtils - servletRequest - servletRoot argument is undefined "+a;if("undefined"==typeof c)throw"AjaxUtils - servletRequest - servletName argument is undefined "+c;var f={url:"http://apijava.flow-machines.com:8080/"+a+"/"+c,type:"POST",data:d,dataType:"json",withCredentialsBool:!0};b.request(f,e)},b}),define([],function(){var a={allChordNotes:{"":"C4, E4, G4",M7:"C4,E4,G4,B4",m7:"C4,Eb4,G4,Bb4",m:"C4,Eb4,G4",mM7:"C4,Eb4,G4,B4",7:"C4, E4, G4, Bb4",6:"C4,E4,G4,A4",9:"C4,E4,G4,Bb4,D5",69:"C4,E4,G4,A4,D5",11:"C4,E4,G4,Bb4,D5,F5",13:"C4,E4,G4,Bb4,D5,F#5,A5",halfdim7:"C4,Eb4,Gb4,Bb4",dim:"C4,Eb4,Gb4",dim7:"C4,Eb4,Gb4,A4","7b9":"C4, E4, G4, Bb4, Db5","7#9":"C4,E4,G4,Bb4,D#5","7#9b5":"C4,E4,Gb4,Bb4,D#5","7sus":"C4,F4,G4,Bb4","7b9sus":"C4,F4,G4,Bb4,Db5","7b13":"C4,E4,G4,Bb4,D5,F#5,Ab5","7#11":"C4,E4,G4,Bb4,D5,F#5","7#5":"C4,E4,G#4,Bb4",m6:"C4, Eb4, G4, A4",m9:"C4,Eb4,G4,Bb4,D5","9#5":"C4,E4,G#4,Bb4,D5","9sus":"C4, F4, G4, Bb4, D5","4sus":"C4,F4,G4","+":"C4,E4,G#4",aug:"C4,E4,G#4","M7#5":"C4, E4, G#4, B4","M7#11":"C4,E4,G4,B4,D5,F#5",add9:"C4,E4,G4,D5",alt:"C4,E4,G#4,Bb4,D#5","9#11":"C4,E4,G4,Bb4,D5,F#5",m11:"C4,Eb4,G4,Bb4,D5,F5",2:"C4,D4,E4,G4","7#5b5":"C4,E4,Gb4,G#4,Bb4","7#4#5":"C4,E4,F#4,G#4,Bb4","7#5#11":"C4,F4,G#4,Bb4,D5,F#5","7b5":"C4,E4,Gb4,Bb4","13b9":"C4,E4,G4,Bb4,Db5,F#5,A5","13#11":"C4,E4,G4,Bb4,D5,F#5,A5","7b9#5":"C4,E4,G#4,Bb4,Db5","11b9":"C4,E4,G4,Bb4,Db5,F5",M9:"C4,E4,G4,B4,D5",m69:"C4,Eb4,G4,A4,D5","9b5":"C4,E4,Gb4,Bb4,D5","7b9b5":"C4,E4,Gb4,Bb4,Db5","7b9#11":"C4,F4,G4,Bb4,Db5,F#5","7alt":"C4,E4,G#4,Bb4,D#5","7#9#5":"C4,E4,G#4,Bb4,D#5","+7":"C4,E4,G#4,Bb4","6#11":"C4,E4,G4,A4,F#5",Phrygian:"C4,F4,G4,Bb4,Db5",Lydian:"C4,E4,G4,B4,D5,F#5",Aeolian:"C4, Eb4, G4, Bb4, D5, F5",m7sus4:"C4,F4,G4,Bb4","7b13#11":"C4,E4,G4,Bb4,D5,F#5,Ab5",dimM7:"C4,Eb4,Gb4,B4","m7#5":"C4,Eb4,G#4,Bb4","M9#11":"C4,E4,G4,B4,D5,F#5","13sus":"C4, F4, G4, Bb4, D5, A5","7b9#9":"C4,E4,G4,Bb4,Db5,D#5","7#9#11":"C4,E4,G4,Bb4,D#5,F#5","7b9b13":"C4,E4,G4,Bb4,Db5,F#5,Ab5",mb6:"C4,Eb4,G4,Ab4","7susadd3":"C4,E4,F4,Bb4","7b13sus":"C4,F4,G4,Bb4,D5,Ab5","7b9b13sus":"C4,F4,G4,Bb4,Db5,Ab5",Dorian:"C4, Eb4, G4, Bb4, D5, F5",m13:"C4,Eb4,G4,Bb4,D5,F5,A5","M7#9b9":"C4,E4,G4,Bb4,Db5,D#5",M7b9:"C4,E4,G4,B4,Db5","+7#9":"C4,E4,G#4,Bb4,D#5","m#5":"C4,Eb4,G#4","+7b9":"C4,E4,G#4,Bb4,Db5","M7#5#11":"C4,E4,G#4,Bb4,D5,F#5",mb5b13:"C4,Eb4,Gb4,Bb4,D5,Ab5","6#9":"C4,E4,G4,A4,D#5",M7b5:"C4,E4,Gb4,B4","m9#11":"C4,Eb4,G4,Bb4,D5,F#5","m13#11":"C4,Eb4,G4,Bb4,D5,F#5,A5","m7#11":"C4,Eb4,G4,Bb4,F#5","M7#9#11":"C4,E4,G4,Bb4,D#5,F#5",sus2:"C4, D4, G4","13#9":"C4,E4,G4,Bb4,D#5,A5","7#5b9":"C4,E4,G#4,Bb4,Db5","69#11":"C4,E4,G4,A4,D5,F#5",sus4:"C4,F4,G4","aug#4":"C4,E4,F#4,G#4",m7add4:"C4,Eb4,F4,G4,Bb4","7#5#9":"C4,E4,G#4,Bb4,D#5",m9M7:"C4,Eb4,G4,B4,D5",pedal:"C4","+add9":"C4,E4,G#4,D5","7b5#9":"C4,E4,Gb4,Bb4,D#5","7#4":"C4,E4,F#4,G4,Bb4","M7#4":"C4,E4,F#4,G4,B4","m(add9)":"C4,Eb4,G4,D5","m7b5#5":"C4,Eb4,Gb4,G#4,Bb4","13b9sus":"C4,E4,G4,Bb4,Db5,A5",m9b5:"C4,Eb4,Gb4,Bb4,D5","(#11)":"C4,E4,G4,F#5","M7(♮4)":"C4,E4,F4,G4,B4","m7(b5b2)":"C4,Db4,Eb4,Gb4,Bb4","+(add9)":"C4,E4,G#4,D5",M13:"C4,E4,G4,B4,D5,F#5,A5",m7b5b13:"C4,Eb4,Gb4,Bb4,D5,Ab5",5:"C4,G4","(no3rd)":"C4,G4","(b5)":"C4,E4,Gb4","m(M9)":"C4,Eb4,G4,D5","(add9)":"C4,E4,G4,D5","(9, #11)":"C4,E4,G4,Bb4,D5,F#5","m(m7M7)":"C4,Eb4,G4,B4","(b9b13)":"C4,E4,G4,Bb4,Db5,Ab5","13(b9#11)":"C4,E4,G4,Bb4,Db5,F#5","13(b9b5)":"C4,E4,Gb4,Bb4,Db5,F#5,A5","m(omit5)":"C4,Eb4","m7(omit5)":"C4,Eb4,Bb4","+(b9)":"C4,E4,G#4,Db5","6sus4":"C4,F4,G4,A4",m11b5:"C4,Eb4,Gb4,Bb4,D5,F5","7b6":"C4,E4,G4,Ab4,Bb4","7susomit5":"C4,F4,Bb4","13b9#11":"C4,E4,G4,Bb4,Db5,F#5,Ab5","#11":"C4,E4,G4,Bb4,D5,F#5","M9#5":"C4,E4,G#4,B4,D5",halfdim7add11:"C4,Eb4,G4,Bb4,F5",sus4add9:"C4,F4,G4,D5",add9addb13:"C4,E4,G4,D5,Ab5",madd9:"C4,Eb4,G4,D5","13b5":"C4,E4,Gb4,Bb4,D5,A5",dim7M7:"C4,Eb4,Gb4,B4",M7add13:"C4,E4,G4,B4,D5,A5",m7add11add13:"C4,Eb4,G4,Bb4,F5,A5",add9b5:"C4,E4,Gb4,D5","mM7#11":"C4,Eb4,G4,B4,D5,F#5",m9add13:"C4,Eb4,G4,Bb4,D5,A5","5add9":"C4,E4,G4,D5",M9b5:"C4,E4,Gb4,D5",mM7b13:"C4,Eb4,G4,Bb4,D5,Ab5",madd9add11:"C4,Eb4,G4,D5,F5","13b9b5":"C4,E4,Gb4,Bb4,Db5,F#5,Ab5",sus:"C4,F4,G4","add#11":"C4,E4,G4,F#5",m7addM7:"C4,Eb4,G4,Bb4,B4",halfdim7b9:"C4,Eb4,Gb4,Bb4,Db5","M13#11":"C4,E4,G4,Bb4,D5,F#5,A5","7omit5":"C4,E4,Bb4","M7#9":"C4,E4,G4,Bb4,D#5","13(add11)":"C4,E4,G4,Bb4,D5,F5,A5","M7(add6)":"C4,E4,G4,A4,B4",sus24:"C4,D4,F4",m6M7:"C4,Eb4,G4,A4,B4","m(M13)":"C4,Eb4,G4,Bb4,D5,A5","m(add4)":"C4,Eb4,F4,G4",m7b9:"C4,Eb4,G4,Bb4,Db5","(add2)":"C4,D4,E4,G4","mM7#5":"C4, Eb4, G#4, B4",halfdim7sus4:"C4, F4, Gb4, Bb4",m9sus4:"C4, F4, G4, Bb4, D5",mM7b5:"C4, Eb4, Gb4, B4",m6add11:"C4, Eb4, G4, A4, F5","7#9b13":"C4, E4, G4, Bb4, Db5, F5","M7#9b5":"C4, E4, Gb4, B4, D#5","13#9b5":"C4, E4, Gb4, Bb4, D#5, F#5, A5","m9#5":"C4, Eb4, G#4, Bb4, D5",m9M7b5:"C4, Eb4, Gb4, B4, D5",m7M7:"C4, Eb4, G4, Bb4, B4","7#9sus4":"C4, F4, G4, Bb4, D#5",M7b6:"C4, E4, G4, Ab4, B4",m2:"C4, D4, Eb4, G4","6b5":"C4, E4, Gb4, A4",msus4:"C4, Eb4, F4, G4","69(omit3)":"C4, G4, A4, D5","m(b9)":"C4, Eb4, G4, Db5","M7#5b5":"C4, E4, Gb4, G#4, B4","7b9#9b5":"C4, E4, Gb4, Bb4, Db5, D#5","7b9b5#5":"C4, E4, Gb4, G#4, Bb4, Db5","Lydian(#6)":"C4, E4, G4, A#4, D5, F#5","9b13":"C4, E4, G4, Bb4, D5, Ab5","7(13)":"C4, E4, G4, Bb4, A5","#9#11":"C4, E4, G4, D#5, F#5","m69(11)":"C4, Eb4, G4, A4, D5, F5",m11M7:"C4, Eb4, G4, B4, D5, F5","13#9#11":"C4, E4, G4, Bb4, D#5, F#5, A5","M7(omit3)":"C4, G4, B4","7#9(omit5)":"C4, E4, Bb4, D#5","M7(omit5)":"C4, E4, B4",m11omit5:"C4, Eb4, Bb4, D5, F5","13#9#5":"C4, E4, G#4, Bb4, D#5, F#5, A5",add9omit3:"C4, G4, D5","7b9#5#11":"C4, E4, G#4, Bb4, Db5, F#5",M7sus:"C4, F4, G4, B4",addb13:"C4, E4, G4, Ab4",m7add13:"C4, Eb4, G4, Bb4, Ab5",m7addb13:"C4, Eb4, G4, Bb4, Ab5","sus(addb9)":"C4, F4, G4, Db5",add11:"C4, E4, G4, F5",add9sus:"C4, F4, G4, D5","Phrygian(add3)":"C4, E4, F4, G4, Bb4, Db5","m9M7#11":"C4, Eb4, G4, B4, D5, F#5",madd11:"C4, Eb4, G4, F5","(add#9)":"C4, D#4, E4, G4","9omit5":"C4, E4, Bb4, D5",M7add11:"C4, E4, G4, B4, F5",m7add9:"C4, Eb4, G4, Bb4, D5",m7b5:"C4, Eb4, Gb4, Bb4","dim(b13)":"C4, D#4, F#4, Ab4","m7(add11)":"C4, E4, G4, Bb4","M7(add#11)":"C4, E4, G4, Bb4","M7(add9)":"C4, E4, G4, Bb4",sus4b9:"C4, E4, G4, Bb4","sus4(9,13)":"C4, E4, G4, Bb4","_#5add#9":"C4, E4, G#4, D#5",m69addM7:"C4, Eb4, G4, A4, B4, D5","m69(#11)":"C4, Eb4, G4, A4, D5, F#5",m11M7b5:"C4, Eb4, Gb4, B4, F5","mM7(add9)":"C4, Eb4, G4, B4","m6(add9)":"C4, Eb4, G4, A4, D5","7b5b9":"C4, E4, Gb4, Bb4, Db5","dim(9)":"C4, Eb4, Gb4, Bbb4, D5","m7(add11omit5)":"C4, Eb4, Bb4, F5","_#9":"C4, E4, G4, D#5",mM7add11:"C4, Eb4, G4, B4, F5","m#11":"C4, Eb4, G4, Bb4, D5, F#5",M9sus:"C4, F4, G4, B4, D5",M9add13:"C4, E4, G4, B4, D5, A5",M7addb13:"C4, E4, G4, B4, Ab5",halfdim7add13:"C4, Eb4, Gb4, Bb4, A5",omit5:"C4, E4","m9add#5":"C4, Eb4, G4, G#4, Bb4, D5","7add11":"C4, E4, G4, Bb4, F5","69omit5":"C4, E4, A4, D5","4(addb9)":"C4, F4, G4, Db5",dim7add9:"C4, Eb4, Gb4, A4, D5","13b9add#5":"C4, E4, G4, Bb4, Db5, G#5, A5","5#11":"C4, G4, F#5",addb9:"C4, E4, G4, Db5","6#9#11":"C4, E4, G4, A4, D#5, F#5",dim7b13:"C4, E4, G4, Bb4",sus4add13:"C4, E4, G4, Bb4",halfdim7add9:"C4, E4, G4, Bb4","7b9b11":"C4, E4, G4, Bb4",omit3:"C4, E4, G4, Bb4","9omit3":"C4, E4, G4, Bb4","7omit3":"C4, E4, G4, Bb4","7b9omit3":"C4, E4, G4, Bb4","m11#5":"C4, Eb4, Ab4, Bb4, D5, F5","_#9b13":"C4, E4, G4, Eb5, Ab5","11b9#5":"C4, E4, G#4, Bb4, Db5, F5",mM9:"C4, E4, G4, Bb4","M7(6)":"C4, E4, G4, Bb4","m7(6)":"C4, E4, G4, Bb4",m7b13:"C4, E4, G4, Bb4","(#5)":"C4, E4, G4, Bb4","7susadd13":"C4, F4, G4, Bb4, A5",m11b6:"C4, Eb4, G4, Ab4, Bb4, D5, F5","M7#11(omit3)":"C4, G4, B4, F#5",mb5:"C4, Eb4, Gb4",m7b6:"C4, Eb4, G4, Ab4, Bb4",sus4omit5:"C4, E4, G4, Bb4","m(omit3)":"C4, E4, G4, Bb4","m(addb9)":"C4, E4, G4, Bb4","m6(omit5)":"C4, E4, G4, Bb4",_b9:"C4, E4, G4, Db5","M7(69)":"C4, E4, G4, Bb4",dimadd11:"C4, Eb4, Gb4, F5","_b9#11":"C4, E4, G4, Db5, F#5","9b5b13":"C4, E4, Gb4, D5, Ab5","4(add9)":"C4, F4, G4, D5","M9#11(6)":"C4, E4, G4, A4, B4, D5, F#5","m6(add11)":"C4, Eb4, G4, A4, F5","(b9)":"C4, E4, G4, Db5","m6(M7)":"C4, Eb4, G4, A4, B4","(b5)sus4":"C4, F4, Gb4","7#9add4":"C4, E4, G4, Bb4, D#5, F5","13omit3":"C4, G4, Bb4, D5, F#5, A5",dim7add11:"C4, Eb4, Gb4, A4, F5",m9b13:"C4, Eb4, G4, Bb4, D5, Ab5","mb6(add9)":"C4, Eb4, G4, Ab4, D5","9#5#11":"C4, E4, G#4, Bb4, D5, F#5","#11add9":"C4, E4, G4, D5, F#5","_#11add9":"C4, E4, G4, D5, F#5","6omit3":"C4, G4, A4","9b5omit3":"C4, Gb4, Bb4, D5","9add13":"C4, E4, G4, Bb4, D5, A5",dim11:"C4, Eb4, Gb4, A4, D5, F5",m11b9:"C4, Eb4, G4, Bb4, Db5, F5","m7#5add4":"C4, Eb4, G#4, Bb4, F5",_b9sus:"C4, F4, G4, Db5","9#11omit3":"C4, G4, Bb4, D5, F#5","_b9#5sus":"C4, F4, G#4, Bb4, Db5","7b9#5sus":"C4, F4, G#4, Bb4, Db5",M9b5add13:"C4, E4, Gb4, B4, D5, A5",mb9add11:"C4, Eb4, G4, Db5, F5"}};return a}),define(["jquery","utils/NoteUtils","utils/ChordTypesCollection"],function(a,b,c){var d={};return d.getAllChordTypeFromDB=function(b){a.ajax({url:"api/chordsTypesInfo.php",dataType:"jsonp",type:"POST",data:{action:"getAllChordNotes"},success:function(a){"undefined"!=typeof b&&b("undefined"!=typeof a&&a.allChordNotes?a:"error "+a)}})},d.getAllChordTypes=function(){if("undefined"!=typeof d.allChords)return d.chordTypeToNote;if("undefined"!=typeof c){d.chordTypeToNote=[];for(var a in c.allChordNotes)d.chordTypeToNote[a]=b.transformStringNote2ArrayNote(c.allChordNotes[a]);return d.chordTypeToNote}return d.chordTypeToNote=[],d.getAllChordTypeFromDB(function(a){for(var c in a.allChordNotes)d.chordTypeToNote[c]=b.transformStringNote2ArrayNote(a.allChordNotes[c])}),d.chordTypeToNote},d.getAllChords=function(){var a=this.getAllChordTypes(),b=["C","C#","Cb","D","D#","Db","E","E#","Eb","F","F#","Fb","G","G#","Gb","A","A#","Ab","B","B#","Bb","%","%%","NC"],c=[];for(var e in b)if(-1==b[e].indexOf("%")&&"NC"!=b[e])for(var f in a)("#"==f.substring(0,1)||"b"==f.substring(0,1))&&(f="_"+f),c.push(b[e]+f);else c.push(b[e]);return d.allChords=c,c},d}),define(function(){var a={};return a.PITCH_CLASSES=["C","D","E","F","G","A","B"],a.DURATIONS={4:"w",2:"h",1:"q",.5:"8",.25:"16",.125:"32",.0625:"64"},a.getStringFromBeatDuration=function(b){return a.DURATIONS[b]},a.getBeatFromStringDuration=function(b){for(var c in a.DURATIONS)if(a.DURATIONS[c]===b)return Number(c)},a.sortPitches=function(a){function b(a,b){var c,d=a.substring(0,1).toUpperCase(),e=parseInt(a.slice(-1),null),f=b.substring(0,1).toUpperCase(),g=parseInt(b.slice(-1),null);if(e>g)c=1;else if(g>e)c=-1;else{var h={C:0,D:1,E:2,F:3,G:4,A:5,B:6};h[d]>h[f]&&(c=1),c=h[d]<h[f]?-1:0}return c}var c,d,e,f,g,h=[];for(var i in a)if(c=a[i],0===h.length)h.push(c);else{for(d=!1,e=0;d===!1&&e<h.length;)g=h[e],f=b(c,g),0>f&&(h.splice(e,0,c),d=!0),e++;d===!1&&h.push(c)}return h},a.pitch2Number=function(a){var b,c={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};return"undefined"!=typeof c[a]&&(b=c[a]),b},a.number2Pitch=function(a){number2PitchArray={0:"C",1:"C#",2:"D",3:"D#",4:"E",5:"F",6:"F#",7:"G",8:"G#",9:"A",10:"A#",11:"B"},a=(a+12)%12;var b;return"undefined"!=typeof number2PitchArray[a]&&(b=number2PitchArray[a]),b},a.transformStringNote2ArrayNote=function(a){var b=[];if("undefined"!=typeof a)for(var c=a.split(","),d=0;d<c.length;d++){var e=/[A-Z][b,#]{0,2}[0-9]?/i.exec(c[d]);e&&b.push(e[0])}return b},a.getValidPitch=function(a){var b=/[a-g|A-G]/;return"number"==typeof a?-1:a.match(b)?a.toUpperCase():-1},a.getClosestKey=function(a,b){var c=a.split("/")[0],d=this.getKeyPosition(c),e=this.getKeyPosition(b),f=e-d,g=this.PITCH_CLASSES.length-Math.abs(f);f>0&&(g*=-1);var h=Math.abs(g)<Math.abs(f)?g:f;return this.getKey(a,h)},a.getKeyPosition=function(a){for(var b=0;b<this.PITCH_CLASSES.length&&this.PITCH_CLASSES[b]!=a.toUpperCase();b++);return b},a.getKey=function(a,b){var c=a.split("/"),d=c[0],e="";"undefined"!=typeof d[1]&&(e=d[1]);var f=parseInt(c[1],null),g=this.getKeyPosition(d[0])+b,h=g%this.PITCH_CLASSES.length;0>h&&(h+=this.PITCH_CLASSES.length);var i=Math.floor(g/this.PITCH_CLASSES.length),j=f+i;return 1>=j&&2>h||j>=7&&h>3?null:this.PITCH_CLASSES[h]+e+"/"+j},a.durationToNotes=function(a,b){function c(a,b){a=a||[];for(var e=1,f=0;f<=d.length;){if(b==e){a.push(d[f]);break}if(b>e){a.push(d[f]),a=c(a,b-e);break}f++,e/=2}return a}var d=["q","8","16","32","64"],e=[];if(null!=b){b=Number(b);var f=b-Math.floor(b);if(0!==f){var g=1-f;a>g&&(e=c(e,g),a-=g)}}return c(e,a)},a}),define(["mustache"],function(a){function b(a,b,c){this.title=a,this.content=b,"undefined"!=typeof c&&c===!0?(this.isTemplate=!0,this.template=b):(this.isTemplate=!1,this.content=b),this.backgroundOpacity=.5}return b.prototype.render=function(){if(this.initView(),this.isTemplate){var a=this;this.renderTemplate(function(){a.initController(),a.initKeyboard()})}else this.initView(),this.initController(),this.initKeyboard()},b.prototype.initView=function(){var a='<div class="backgroundPopin" style="opacity:'+this.backgroundOpacity+'"></div>';document.body.innerHTML+=a;var b="";this.isTemplate||(b=this.content);var c="";c+='<div class="modal foregroundPopin" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">',c+='<div class="modal-dialog">',c+='<div class="modal-content">',c+='<div class="modal-header">',c+='<button type="button" class="popin_close close" data-dismiss="modal" aria-hidden="true">&times;</button>',c+='<h4 class="modal-title">'+this.title+"</h4>",c+="</div>",c+='<div class="modal-body contentPopIn">'+b+"</div>",c+="</div>",c+="</div>",c+="</div>",document.body.innerHTML+=c},b.prototype.renderTemplate=function(b){$.get(this.template,function(c){var d=a.render(c);return $(".contentPopIn").html(d),"function"==typeof b&&b(),d})},b.prototype.initController=function(){var a=this;$(".backgroundPopin, .popin_close").click(function(){a.hide()})},b.prototype.initKeyboard=function(){var a=this;$(document).keydown(function(b){var c=null===b?event.keyCode:b.keyCode;27===c&&a.hide()})},b.prototype.show=function(){$(".backgroundPopin").fadeIn("slow"),$(".foregroundPopin").fadeIn("slow")},b.prototype.hide=function(){$(".backgroundPopin").fadeOut("slow"),$(".foregroundPopin").fadeOut("slow")},b}),define(["jquery"],function(a){var b={};return b.logAutoFade=function(b,c,d,e){"undefined"==typeof b&&(b="info"),"undefined"==typeof c&&(c="Untitled"),"undefined"==typeof d&&(d=a("body")[0]),"undefined"==typeof e&&(e=5e3);var f="";switch(b){case"info":f="alert alert-info";break;case"success":f="alert alert-success";break;case"warn":f="alert alert-warning";break;case"error":f="alert alert-error";break;default:f="alert alert-info"}var g="<span class='"+f+"' style='position:fixed; z-index:9999; left:30%'>"+c+"</span>";a(g).insertBefore(d).fadeOut(e,function(){a(this).remove()})},b.log=function(b,c,d){"undefined"==typeof b&&(b="info"),"undefined"==typeof c&&(c="Untitled"),"undefined"==typeof d&&(d=a("body")[0]);var e="";switch(b){case"info":e="alert alert-info";break;case"success":e="alert alert-success";break;case"warn":e="alert alert-warning";break;case"error":e="alert alert-error";break;default:e="alert alert-info"}var f=Math.round(1e3*Math.random())+"-"+Date.now(),g="<span class='"+e+"' id='logId-"+f+"' style='position:fixed; z-index:9999; left:30%'>"+c+"</span>";return a(g).insertBefore(d),f},b.removeLog=function(b){"undefined"==typeof b&&console.warn("UserLog - remove - id undefined "+b),a("#logId-"+b).remove()},b}),define(["jquery"],function(){var a={};return a.getRequestForSimpleAudio=function(a,b,c,d){var e={"ls.leadsheet":a,type:"audio","ex.tempo":b,"seq.tick.play":d,"seq.comping.play":c,"seq.bass.play":c,"ex.audio.sampleRate":48e3,"ex.audio.bitrate":320};return e},a.getRequestForSimpleMidi=function(a,b,c,d){var e={"ls.leadsheet":a,type:"midi","ex.tempo":b,"seq.tick.play":d,"seq.comping.play":c,"seq.bass.play":c};return e},a}),define(["utils/AjaxUtils"],function(a){return{run:function(){test("AjaxUtils",function(b){b["throws"](function(){a.request()},"Empty request should throw an exception"),b["throws"](function(){a.request({type:"GET",data:data,dataType:"json",withCredentialsBool:!0})},"Request without url should throw an exception"),b["throws"](function(){a.servletRequest()},"Empty request should throw an exception"),b["throws"](function(){a.servletRequest("ServletRoot")},"Empty servletTitle or ServletRoot should throw an exception")})}}}),define(["utils/UserLog"],function(a){return{run:function(){test("UserLog",function(b){var c=a.log("success","Testing log");b.ok("undefined"!=typeof c),b.equal($("#logId-"+c).length,1),a.removeLog(c),b.equal($("#logId-"+c).length,0)})}}});